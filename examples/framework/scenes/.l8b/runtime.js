var ft=Object.create;var Ne=Object.defineProperty;var _t=Object.getOwnPropertyDescriptor;var dt=Object.getOwnPropertyNames;var mt=Object.getPrototypeOf,Et=Object.prototype.hasOwnProperty;var b=(o,e)=>Ne(o,"name",{value:e,configurable:!0}),q=(o=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(o,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):o)(function(o){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+o+'" is not supported')});var We=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports);var gt=(o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of dt(e))!Et.call(o,a)&&a!==t&&Ne(o,a,{get:()=>e[a],enumerable:!(n=_t(e,a))||n.enumerable});return o};var Ke=(o,e,t)=>(t=o!=null?ft(mt(o)):{},gt(e||!o||!o.__esModule?Ne(t,"default",{value:o,enumerable:!0}):t,o));var ut=We((wt,Ue)=>{"use strict";var me=Object.defineProperty,Tt=Object.getOwnPropertyDescriptor,Ot=Object.getOwnPropertyNames,Pt=Object.prototype.hasOwnProperty,B=b((o,e)=>me(o,"name",{value:e,configurable:!0}),"__name"),kt=b((o,e)=>{for(var t in e)me(o,t,{get:e[t],enumerable:!0})},"__export"),we=b((o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Ot(e))!Pt.call(o,a)&&a!==t&&me(o,a,{get:()=>e[a],enumerable:!(n=Tt(e,a))||n.enumerable});return o},"__copyProps"),tt=b((o,e,t)=>(we(o,e,"default"),t&&we(t,e,"default")),"__reExport"),At=b(o=>we(me({},"__esModule",{value:!0}),o),"__toCommonJS"),Ie={};kt(Ie,{AssetLoader:()=>nt,GameLoop:()=>at,Image:()=>de.Image,InputManager:()=>ot,Map:()=>it.Map,ObjectPool:()=>ht,Runtime:()=>et,RuntimeOrchestrator:()=>et,Sound:()=>st.Sound,SourceUpdater:()=>rt,Sprite:()=>de.Sprite,StorageService:()=>Dt.StorageService,System:()=>lt,createSoundClass:()=>Fe});Ue.exports=At(Ie);var st=q("@l8b/audio"),it=q("@l8b/map"),de=q("@l8b/sprites");function Fe(o){return st.Sound}b(Fe,"createSoundClass");B(Fe,"createSoundClass");var bt=q("@l8b/map"),Lt=q("@l8b/sprites"),nt=class{static{b(this,"AssetLoader")}static{B(this,"AssetLoader")}url;resources;collections;loadingBarTime=null;constructor(o,e){this.url=o,this.resources=e,this.collections={sprites:{},maps:{},sounds:{},music:{},assets:{}}}async loadAll(){return await Promise.all([this.loadSprites(),this.loadMaps(),this.loadSounds(),this.loadMusic(),this.loadGenericAssets()]),this.collections}async loadSprites(){if(!this.resources.images)return;let o=this.resources.images.map(e=>new Promise(t=>{let n=e.file.split(".")[0].replace(/-/g,"/"),a=`${this.url}sprites/${e.file}?v=${e.version||0}`;try{let l=(0,Lt.loadSprite)(a,e.properties,()=>{t()});this.collections.sprites[n]=l}catch(l){console.error(`Failed to load sprite ${n}:`,l),this.collections.sprites[n]={name:n,ready:!1,frames:[],fps:e.properties?.frames||5,width:0,height:0},t()}}));await Promise.all(o)}async loadMaps(){if(!this.resources.maps)return;let o=this.resources.maps.map(e=>new Promise(t=>{let n=e.file.split(".")[0].replace(/-/g,"/"),a=`${this.url}maps/${e.file}?v=${e.version||0}`;try{let l=(0,bt.loadMap)(a,this.collections.sprites,()=>{t()});this.collections.maps[n]=l}catch(l){console.error(`Failed to load map ${n}:`,l),this.collections.maps[n]={name:n,ready:!1,width:0,height:0,block_width:16,block_height:16,data:[]},t()}}));await Promise.all(o)}async loadSounds(){if(!this.resources.sounds)return;let o=this.resources.sounds.map(async e=>{let t=e.file.split(".")[0],n=`${this.url}sounds/${e.file}?v=${e.version||0}`;try{let a=new Audio;a.src=n,await new Promise((l,h)=>{a.addEventListener("canplaythrough",()=>l(),{once:!0}),a.addEventListener("error",h,{once:!0}),a.load()}),this.collections.sounds[t]={name:t,url:n,audio:a,ready:!0}}catch(a){console.error(`Failed to load sound ${t}:`,a),this.collections.sounds[t]={name:t,url:n,ready:!1}}});await Promise.all(o)}async loadMusic(){if(!this.resources.music)return;let o=this.resources.music.map(async e=>{let t=e.file.split(".")[0],n=`${this.url}music/${e.file}?v=${e.version||0}`;try{let a=new Audio;a.src=n,a.loop=!0,await new Promise((l,h)=>{a.addEventListener("canplaythrough",()=>l(),{once:!0}),a.addEventListener("error",h,{once:!0}),a.load()}),this.collections.music[t]={name:t,url:n,audio:a,ready:!0}}catch(a){console.error(`Failed to load music ${t}:`,a),this.collections.music[t]={name:t,url:n,ready:!1}}});await Promise.all(o)}async loadGenericAssets(){if(this.resources.assets)for(let o of this.resources.assets){let e=o.file.split(".")[0].replace(/-/g,"/");this.collections.assets[e]={name:e,file:o.file,version:o.version}}}isReady(){return this.countReady()===this.countTotal()}getProgress(){let o=this.countTotal();return o===0?1:this.countReady()/o}countTotal(){let o=0;return o+=Object.keys(this.collections.sprites).length,o+=Object.keys(this.collections.maps).length,o+=Object.keys(this.collections.sounds).length,o+=Object.keys(this.collections.music).length,o}countReady(){let o=0;for(let e of Object.values(this.collections.sprites))e.ready&&o++;for(let e of Object.values(this.collections.maps))e.ready&&o++;for(let e of Object.values(this.collections.sounds))e.ready&&o++;for(let e of Object.values(this.collections.music))e.ready&&o++;return o}showLoadingBar(o){if(this.loadingBarTime&&Date.now()<this.loadingBarTime+16)return;this.loadingBarTime=Date.now();let e=this.getProgress();o.clear("#000"),o.drawRect(0,0,100,10,"#DDD"),o.fillRect(-(1-e)*48,0,e*96,6,"#DDD")}getCollections(){return this.collections}},Rt=q("@l8b/audio"),Xe=q("@l8b/lootiscript"),St=q("@l8b/vm"),yt=q("@l8b/screen"),Ct=q("@l8b/time"),rt=class{static{b(this,"SourceUpdater")}static{B(this,"SourceUpdater")}vm;listener;updateMemory={};previousInit=null;constructor(o,e){this.vm=o,this.listener=e}updateSource(o,e,t=!1){if(e===this.updateMemory[o])return!1;this.updateMemory[o]=e;try{if(this.vm.run(e,3e3,o),this.listener.postMessage&&this.listener.postMessage({name:"compile_success",file:o}),this.vm.error_info){let n=Object.assign({},this.vm.error_info);return n.type="init",n.file=o,this.reportError(n),!1}if(t&&this.vm.runner.getFunctionSource){let n=this.vm.runner.getFunctionSource("init");if(n&&n!==this.previousInit&&(this.previousInit=n,this.vm.call("init"),this.vm.error_info)){let a=Object.assign({},this.vm.error_info);a.type="init",this.reportError(a)}}return!0}catch(n){console.error("Parse/Runtime error:",n);let h=(this.vm.error_info?{...this.vm.error_info}:null)||{error:B(()=>{if(typeof n=="string")return n;if(n?.message)return n.message;if(typeof n?.error=="string")return n.error;if(typeof n?.error=="function")return"Parse error (function)";if(n?.error)try{return JSON.stringify(n.error)}catch{return String(n.error)}try{return JSON.stringify(n)}catch{return String(n)}},"getMessage")(),type:n?.type||"init",file:n?.file||o,line:n?.line,column:n?.column,stack:n?.stack};return h.file||(h.file=o),this.reportError(h),!1}}reportError(o){this.listener.reportError&&this.listener.reportError(o)}},_e=q("@l8b/input"),ot=class{static{b(this,"InputManager")}static{B(this,"InputManager")}keyboard;mouse;touch;gamepad;constructor(o){this.keyboard=new _e.KeyboardInput,this.mouse=new _e.MouseInput,this.touch=new _e.TouchInput(this.mouse),this.gamepad=new _e.GamepadInput,o&&this.attachCanvas(o)}attachCanvas(o){this.mouse.setCanvas(o),this.touch.setCanvas(o)}update(){this.keyboard.update(),this.mouse.update(),this.touch.update(),this.gamepad.update()}getStates(){return{keyboard:this.keyboard.state,mouse:this.mouse.state,touch:this.touch.state,gamepad:this.gamepad.status}}},at=class{static{b(this,"GameLoop")}static{B(this,"GameLoop")}callbacks;state;stopped=!1;animationFrameId=null;constructor(o){this.callbacks=o,this.state={currentFrame:0,floatingFrame:0,dt:1e3/60,lastTime:performance.now(),fps:60,updateRate:60},this.loop=this.loop.bind(this)}start(){this.stopped=!1,this.state.lastTime=performance.now(),this.state.currentFrame=0,this.state.floatingFrame=0,this.loop()}stop(){this.stopped=!0,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}resume(){this.stopped&&(this.stopped=!1,this.state.lastTime=performance.now(),this.loop())}loop(){if(this.stopped)return;this.animationFrameId=requestAnimationFrame(this.loop);let o=performance.now();Math.abs(o-this.state.lastTime)>160&&(this.state.lastTime=o-16);let e=o-this.state.lastTime;this.state.dt=this.state.dt*.9+e*.1,this.state.lastTime=o,this.state.fps=Math.round(1e3/this.state.dt),this.state.floatingFrame+=this.state.dt*this.state.updateRate/1e3;let t=Math.min(10,Math.round(this.state.floatingFrame-this.state.currentFrame));(t===0||t===2)&&this.state.updateRate===60&&Math.abs(this.state.fps-60)<2&&(t=1,this.state.floatingFrame=this.state.currentFrame+1);for(let n=0;n<t;n++)this.callbacks.onUpdate(),n<t-1&&this.callbacks.onTick&&this.callbacks.onTick();this.state.currentFrame+=t,this.callbacks.onDraw(),this.callbacks.onTick&&this.callbacks.onTick()}getState(){return{...this.state}}setUpdateRate(o){o>0&&Number.isFinite(o)&&(this.state.updateRate=o)}getFPS(){return this.state.fps}},lt=class{static{b(this,"System")}static{B(this,"System")}listener;systemAPI;constructor(o={}){this.listener=o,this.systemAPI={get time(){return Date.now()},fps:60,cpu_load:0,update_rate:60,get language(){return typeof navigator<"u"?navigator.language:"en"},inputs:{get keyboard(){return 1},get mouse(){return 1},get touch(){return typeof window<"u"&&"ontouchstart"in window?1:0},get gamepad(){return typeof navigator<"u"&&typeof navigator.getGamepads=="function"?1:0}},loading:0,pause:B(()=>{this.listener.codePaused&&this.listener.codePaused()},"pause"),exit:B(()=>{typeof window<"u"&&window.close()},"exit"),prompt:B((e,t)=>{if(typeof window<"u"){let n=window.prompt(e);n!==null&&t&&t(n)}},"prompt"),say:B(e=>{typeof window<"u"&&window.alert(e)},"say"),file:{dropped:0},javascript:{},threads:[],disable_autofullscreen:0,preemptive:1}}getAPI(){return this.systemAPI}setFPS(o){this.systemAPI.fps=o}setCPULoad(o){this.systemAPI.cpu_load=o}setLoading(o){this.systemAPI.loading=o}},ht=class{static{b(this,"ObjectPool")}static{B(this,"ObjectPool")}pool=[];factory;reset;maxSize;constructor(o,e,t=100){this.factory=o,this.reset=e,this.maxSize=t}acquire(){return this.pool.length>0?this.pool.pop():this.factory()}release(o){this.pool.length>=this.maxSize||(this.reset(o),this.pool.push(o))}clear(){this.pool=[]}size(){return this.pool.length}getMaxSize(){return this.maxSize}setMaxSize(o){this.maxSize=o,this.pool.length>o&&(this.pool=this.pool.slice(0,o))}},xt=q("@l8b/scene"),Ze=q("@l8b/diagnostics"),et=class{static{b(this,"RuntimeOrchestrator")}static{B(this,"RuntimeOrchestrator")}options;listener;screen;audio;input;system;sceneManager;vm=null;sprites={};maps={};sounds={};music={};assets={};assetLoader;gameLoop=null;sourceUpdater=null;timeMachine=null;lastInputDebug;lastScreenDebug;frameCount=0;DEBUG_UPDATE_FREQUENCY=10;constructor(o={}){this.options=o,this.listener=o.listener||{},this.screen=new yt.Screen({runtime:this,canvas:o.canvas,width:o.width||400,height:o.height||400}),this.audio=new Rt.AudioCore(this),this.input=new ot(this.screen.getCanvas()),this.system=new lt(this.listener),this.sceneManager=new xt.SceneManager,this.assetLoader=new nt(o.url||"",o.resources||{}),this.logStep("RuntimeOrchestrator constructed",{width:this.screen.width,height:this.screen.height,resources:{images:o.resources?.images?.length??0,sounds:o.resources?.sounds?.length??0,music:o.resources?.music?.length??0}})}async start(){this.logStep("startup: begin"),this.logStep("startup: loading assets"),await this.loadAssets(),this.logStep("startup: assets loaded",{sprites:Object.keys(this.sprites).length,maps:Object.keys(this.maps).length,sounds:Object.keys(this.sounds).length,music:Object.keys(this.music).length,assets:Object.keys(this.assets).length}),this.logStep("startup: waiting for asset readiness"),await this.waitForAssetsReady(),this.logStep("startup: assets ready"),this.logStep("startup: initializing VM"),this.initializeVM(),this.logStep("startup: VM ready",{sourceFiles:Object.keys(this.options.sources||{}).length}),this.logStep("startup: starting game loop"),this.startGameLoop(),this.logStep("startup: completed")}async loadAssets(){let o=await this.assetLoader.loadAll();this.sprites=o.sprites,this.maps=o.maps,this.sounds=o.sounds,this.music=o.music,this.assets=o.assets}async waitForAssetsReady(){return new Promise(o=>{let e=B(()=>{if(this.assetLoader.isReady()){this.system.setLoading(100),o();return}let t=this.assetLoader.getProgress();this.system.setLoading(Math.floor(t*100)),this.assetLoader.showLoadingBar(this.screen.getInterface()),requestAnimationFrame(e)},"checkReady");e()})}convertSceneDefinition(o){if(!o||typeof o!="object")return o;if(!this.vm?.runner?.main_thread?.processor)return console.warn("[RuntimeOrchestrator] VM not ready for scene conversion. Scene functions may not work correctly."),o;let e=this.vm.runner.main_thread.processor,t=this.vm.context,n={};for(let a in o){let l=o[a];l instanceof Xe.Routine?n[a]=e.routineAsFunction(l,t):l&&typeof l=="object"&&!Array.isArray(l)?n[a]=this.convertSceneDefinition(l):n[a]=l}return n}initializeVM(){this.logStep("vm: building meta/global APIs");let o={print:B(E=>{(typeof E=="object"||typeof E=="function")&&this.vm&&(E=this.vm.toString(E)),this.listener.log?this.listener.log(String(E)):console.log(E)},"print")},e=this.input.getStates(),t={screen:this.screen.getInterface(),audio:this.audio.getInterface(),keyboard:e.keyboard,mouse:e.mouse,touch:e.touch,gamepad:e.gamepad,sprites:this.sprites,maps:this.maps,sounds:this.sounds,music:this.music,assets:this.assets,system:this.system.getAPI(),scene:B((E,O)=>{let g=this.convertSceneDefinition(O);this.sceneManager.registerScene(E,g)},"scene"),route:B((E,O)=>this.sceneManager.registerRoute(E,O),"route"),router:this.sceneManager.router.getInterface(),Image:de.Image,Sprite:de.Sprite,Map:it.Map,Sound:Fe(this.audio),Random:Xe.Random,ObjectPool:ht};this.vm=new St.L8BVM(o,t,this.options.namespace||"/l8b",this.options.preserveStorage||!1),this.sourceUpdater=new rt(this.vm,this.listener),this.timeMachine=new Ct.TimeMachine(this),this.listener.postMessage&&this.timeMachine.onStatus(E=>{this.listener.postMessage?.({name:"time_machine_status",status:E})});let n=this.options.compiledRoutines||{},a=this.options.sources||{};if(Object.keys(n).length>0){this.logStep("vm: loading compiled routines",{files:Object.keys(n)});for(let[E,O]of Object.entries(n))try{this.vm.loadRoutine(O,E)}catch(g){this.reportError({error:g.message||String(g),type:"compile",stack:g.stack,file:E}),this.logStep("vm: routine load error",{file:E,message:g?.message||String(g)})}}else if(Object.keys(a).length>0){this.logStep("vm: executing sources",{files:Object.keys(a)});for(let[E,O]of Object.entries(a))this.sourceUpdater.updateSource(E,O,!1)}else this.logStep("vm: no sources or compiled routines provided");try{this.vm.call("init"),this.logStep("vm: init() executed")}catch(E){this.reportError({error:E.message||String(E),type:"init",stack:E.stack}),this.logStep("vm: init() error",{message:E?.message||String(E)})}let l=this.sceneManager.registry.getNames();this.logStep("router: initializing",{registeredScenes:l.length,sceneNames:l}),this.sceneManager.router.init();let h=this.sceneManager.hasActiveScene()?this.sceneManager.getCurrentSceneName?.()||"unknown":null,m=this.sceneManager.router.getState();this.logStep("router: initialized",{activeScene:h||"none",path:m.path,hasActiveScene:this.sceneManager.hasActiveScene()}),this.listener.postMessage&&this.listener.postMessage({name:"started"})}startGameLoop(){this.logStep("loop: creating game loop"),this.gameLoop=new at({onUpdate:B(()=>this.handleUpdate(),"onUpdate"),onDraw:B(()=>this.handleDraw(),"onDraw"),onTick:B(()=>this.handleTick(),"onTick")}),this.gameLoop.start(),this.logStep("loop: started")}handleUpdate(){if(this.vm){this.frameCount++,this.input.update(),this.frameCount%this.DEBUG_UPDATE_FREQUENCY===0&&(this.debugInputs(),this.debugScreen()),this.gameLoop&&this.system.setFPS(this.gameLoop.getFPS());try{if(this.sceneManager.hasActiveScene()?this.sceneManager.update():this.vm.call("update"),this.vm.error_info){let o=Object.assign({},this.vm.error_info);o.type="update",this.reportError(o)}}catch(o){this.reportError({error:o.message||String(o),type:"update",stack:o.stack})}}}debugInputs(){if(!this.options.debug?.input)return;let o=this.createInputSnapshot();o&&(this.lastInputDebug&&this.shallowEqual(o,this.lastInputDebug)||(this.lastInputDebug=o,console.debug("[@l8b/runtime][input]",o)))}debugScreen(){if(!this.options.debug?.screen)return;let o=this.screen.getCanvas(),e={width:this.screen.width,height:this.screen.height,canvasWidth:o.width,canvasHeight:o.height};this.lastScreenDebug&&e.width===this.lastScreenDebug.width&&e.height===this.lastScreenDebug.height&&e.canvasWidth===this.lastScreenDebug.canvasWidth&&e.canvasHeight===this.lastScreenDebug.canvasHeight||(this.lastScreenDebug=e,console.debug("[@l8b/runtime][screen]",{screen:{width:this.screen.width,height:this.screen.height},canvas:{width:o.width,height:o.height,clientWidth:o.clientWidth,clientHeight:o.clientHeight,style:{width:o.style.width,height:o.style.height}}}))}shallowEqual(o,e){if(o===e)return!0;if(!o||!e||typeof o!="object"||typeof e!="object")return!1;let t=Object.keys(o),n=Object.keys(e);if(t.length!==n.length)return!1;for(let a of t){let l=o[a],h=e[a];if(l!==h){if(l==null||h==null){if(l!==h)return!1;continue}if(typeof l=="object"&&typeof h=="object"){let m=Object.keys(l),E=Object.keys(h);if(m.length!==E.length)return!1;for(let O of m)if(l[O]!==h[O])return!1}else return!1}}return!0}createInputSnapshot(){let o=this.options.debug?.input;if(!o)return null;let e=this.getEnabledInputChannels(o);if(e.length===0)return null;let t=this.input.getStates(),n={};return e.includes("touch")&&(n.touch={touching:t.touch.touching,press:t.touch.press,release:t.touch.release,x:Number(t.touch.x?.toFixed?.(2)??t.touch.x),y:Number(t.touch.y?.toFixed?.(2)??t.touch.y),count:t.touch.touches?.length??0}),e.includes("mouse")&&(n.mouse={pressed:t.mouse.pressed,left:t.mouse.left,x:Number(t.mouse.x?.toFixed?.(2)??t.mouse.x),y:Number(t.mouse.y?.toFixed?.(2)??t.mouse.y),wheel:t.mouse.wheel}),e.includes("keyboard")&&(n.keyboard={UP:t.keyboard.UP,DOWN:t.keyboard.DOWN,LEFT:t.keyboard.LEFT,RIGHT:t.keyboard.RIGHT,press:t.keyboard.press,release:t.keyboard.release}),e.includes("gamepad")&&(n.gamepad={count:this.input.gamepad.count,A:t.gamepad.A,B:t.gamepad.B,UP:t.gamepad.UP,DOWN:t.gamepad.DOWN,LEFT:t.gamepad.LEFT,RIGHT:t.gamepad.RIGHT}),Object.keys(n).length===0?null:n}getEnabledInputChannels(o){if(typeof o=="boolean")return o?["keyboard","mouse","touch","gamepad"]:[];let e=[];return o.keyboard&&e.push("keyboard"),o.mouse&&e.push("mouse"),o.touch&&e.push("touch"),o.gamepad&&e.push("gamepad"),e}handleDraw(){if(this.vm){try{if(this.sceneManager.hasActiveScene()?this.sceneManager.draw():this.vm.call("draw"),this.vm.error_info){let o=Object.assign({},this.vm.error_info);o.type="draw",this.reportError(o)}}catch(o){this.reportError({error:o.message||String(o),type:"draw",stack:o.stack})}this.timeMachine&&this.timeMachine.step()}}handleTick(){this.vm?.runner&&this.vm.runner.tick?.()}updateCall(){this.handleUpdate()}drawCall(){this.handleDraw()}updateSource(o,e,t=!1){return this.sourceUpdater?this.sourceUpdater.updateSource(o,e,t):!1}handleMessage(o){o.name==="time_machine"&&this.timeMachine&&this.timeMachine.messageReceived(o)}stop(){this.logStep("lifecycle: stop requested"),this.gameLoop?.stop()}resume(){this.logStep("lifecycle: resume requested"),this.gameLoop?.resume()}getCanvas(){return this.screen.getCanvas()}runCommand(o,e){if(this.vm)try{let t=this.vm.run(o,3e3,"console");e&&e(t)}catch(t){e&&e(`Error: ${t.message||String(t)}`)}}formatError(o){if(o.code||o.context||o.suggestions)return o;let e=o.code||"E2005",t=(0,Ze.createDiagnostic)(e,{file:o.file,line:o.line,column:o.column,context:o.context,suggestions:o.suggestions,related:o.related,stackTrace:o.stackTrace,data:{error:o.error||o.message}}),n=(0,Ze.formatForBrowser)(t);return{...o,...t,formatted:n}}reportError(o){if(this.listener.reportError){let e=this.formatError(o);this.listener.reportError(e)}}logStep(o,e){if(!this.options.debug?.lifecycle)return;let t="[@l8b/runtime][lifecycle]";if(e!==void 0?console.info(`${t} ${o}`,e):console.info(`${t} ${o}`),this.listener.log)try{let n=e===void 0?"":` ${JSON.stringify(e)}`;this.listener.log(`${t} ${o}${n}`)}catch{this.listener.log(`${t} ${o}`)}}},Dt=q("@l8b/io"),ct={};tt(ct,q("@l8b/vm"));tt(Ie,ct,Ue.exports)});var pt=We((exports,module)=>{"use strict";var __defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,__name=b((o,e)=>__defProp(o,"name",{value:e,configurable:!0}),"__name"),__export=b((o,e)=>{for(var t in e)__defProp(o,t,{get:e[t],enumerable:!0})},"__export"),__copyProps=b((o,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of __getOwnPropNames(e))!__hasOwnProp.call(o,a)&&a!==t&&__defProp(o,a,{get:()=>e[a],enumerable:!(n=__getOwnPropDesc(e,a))||n.enumerable});return o},"__copyProps"),__toCommonJS=b(o=>__copyProps(__defProp({},"__esModule",{value:!0}),o),"__toCommonJS"),index_exports={};__export(index_exports,{After:()=>After,Assignment:()=>Assignment,Braced:()=>Braced,Break:()=>Break,Compiler:()=>Compiler2,Condition:()=>Condition,Continue:()=>Continue,CreateClass:()=>CreateClass,CreateObject:()=>CreateObject,Delete:()=>Delete,Do:()=>Do,Every:()=>Every,Expression:()=>Expression,Field:()=>Field,For:()=>For,ForIn:()=>ForIn,Function:()=>Function,FunctionCall:()=>FunctionCall,LocalLayer:()=>LocalLayer,Locals:()=>Locals,Negate:()=>Negate,NewCall:()=>NewCall,Not:()=>Not,OPCODES:()=>OPCODES,Operation:()=>Operation,Parser:()=>Parser,Processor:()=>Processor,Program:()=>Program,Random:()=>Random,Return:()=>Return,Routine:()=>Routine,Runner:()=>Runner,SelfAssignment:()=>SelfAssignment,Sleep:()=>Sleep,Thread:()=>Thread,Token:()=>Token,Tokenizer:()=>Tokenizer,Transpiler:()=>Transpiler2,Value:()=>Value,Variable:()=>Variable,While:()=>While});module.exports=__toCommonJS(index_exports);var Random=class Me{static{b(this,"_Random")}static{__name(this,"Random")}_seed;a=13971;b=12345;size=1<<30;mask;norm;constructor(e,t=!0){this._seed=e??Math.random(),this._seed===0&&(this._seed=Math.random()),this._seed<1&&(this._seed*=1<<30),this.mask=this.size-1,this.norm=1/this.size,t&&(this.nextSeed(),this.nextSeed(),this.nextSeed())}next(){return this._seed=this._seed*this.a+this.b&this.mask,this._seed*this.norm}nextInt(e){return Math.floor(this.next()*e)}nextSeed(){return this._seed=this._seed*this.a+this.b&this.mask}seed(e){return this._seed=e??Math.random(),this._seed<1&&(this._seed*=1<<30),this.nextSeed(),this.nextSeed(),this.nextSeed()}clone(e){return e!=null?new Me(e):new Me(this._seed,!1)}},OPCODES_CLASS=class{static{b(this,"OPCODES_CLASS2")}static{__name(this,"OPCODES_CLASS")}table={};set(e,t){return this[e]=t,this[t]=e,this.table[e]=t,this.table[t]=e,t}TYPE=1;VARIABLE_TYPE=2;PROPERTY_TYPE=3;LOAD_IMPORT=4;LOAD_THIS=5;LOAD_GLOBAL=6;LOAD_VALUE=10;LOAD_LOCAL=11;LOAD_VARIABLE=12;LOAD_LOCAL_OBJECT=13;LOAD_VARIABLE_OBJECT=14;POP=15;LOAD_PROPERTY=16;LOAD_PROPERTY_OBJECT=17;CREATE_OBJECT=18;MAKE_OBJECT=19;CREATE_ARRAY=20;STORE_LOCAL=21;STORE_VARIABLE=23;CREATE_PROPERTY=24;STORE_PROPERTY=25;DELETE=26;UPDATE_CLASS=27;CREATE_CLASS=28;NEW_CALL=29;ADD=30;SUB=31;MUL=32;DIV=33;MODULO=34;BINARY_AND=35;BINARY_OR=36;SHIFT_LEFT=37;SHIFT_RIGHT=38;NEGATE=39;EQ=40;NEQ=41;LT=42;GT=43;LTE=44;GTE=45;NOT=50;LOAD_PROPERTY_ATOP=68;JUMP=80;JUMPY=81;JUMPN=82;JUMPY_NOPOP=83;JUMPN_NOPOP=84;LOAD_ROUTINE=89;FUNCTION_CALL=90;FUNCTION_APPLY_VARIABLE=91;FUNCTION_APPLY_PROPERTY=92;SUPER_CALL=93;RETURN=94;FORLOOP_INIT=95;FORLOOP_CONTROL=96;FORIN_INIT=97;FORIN_CONTROL=98;UNARY_OP=100;BINARY_OP=101;COMPILED=200;AFTER=110;EVERY=111;DO=112;SLEEP=113;LOAD_VAR_CALL=120;LOAD_PROP_CALL=121;LOAD_CONST_ADD=122;constructor(){this.set("TYPE",1),this.set("VARIABLE_TYPE",2),this.set("PROPERTY_TYPE",3),this.set("LOAD_IMPORT",4),this.set("LOAD_THIS",5),this.set("LOAD_GLOBAL",6),this.set("LOAD_VALUE",10),this.set("LOAD_LOCAL",11),this.set("LOAD_VARIABLE",12),this.set("LOAD_LOCAL_OBJECT",13),this.set("LOAD_VARIABLE_OBJECT",14),this.set("POP",15),this.set("LOAD_PROPERTY",16),this.set("LOAD_PROPERTY_OBJECT",17),this.set("CREATE_OBJECT",18),this.set("MAKE_OBJECT",19),this.set("CREATE_ARRAY",20),this.set("STORE_LOCAL",21),this.set("STORE_VARIABLE",23),this.set("CREATE_PROPERTY",24),this.set("STORE_PROPERTY",25),this.set("DELETE",26),this.set("UPDATE_CLASS",27),this.set("CREATE_CLASS",28),this.set("NEW_CALL",29),this.set("ADD",30),this.set("SUB",31),this.set("MUL",32),this.set("DIV",33),this.set("MODULO",34),this.set("BINARY_AND",35),this.set("BINARY_OR",36),this.set("SHIFT_LEFT",37),this.set("SHIFT_RIGHT",38),this.set("NEGATE",39),this.set("EQ",40),this.set("NEQ",41),this.set("LT",42),this.set("GT",43),this.set("LTE",44),this.set("GTE",45),this.set("NOT",50),this.set("LOAD_PROPERTY_ATOP",68),this.set("JUMP",80),this.set("JUMPY",81),this.set("JUMPN",82),this.set("JUMPY_NOPOP",83),this.set("JUMPN_NOPOP",84),this.set("LOAD_ROUTINE",89),this.set("FUNCTION_CALL",90),this.set("FUNCTION_APPLY_VARIABLE",91),this.set("FUNCTION_APPLY_PROPERTY",92),this.set("SUPER_CALL",93),this.set("RETURN",94),this.set("FORLOOP_INIT",95),this.set("FORLOOP_CONTROL",96),this.set("FORIN_INIT",97),this.set("FORIN_CONTROL",98),this.set("UNARY_OP",100),this.set("BINARY_OP",101),this.set("COMPILED",200),this.set("AFTER",110),this.set("EVERY",111),this.set("DO",112),this.set("SLEEP",113),this.set("LOAD_VAR_CALL",120),this.set("LOAD_PROP_CALL",121),this.set("LOAD_CONST_ADD",122)}},OPCODES=new OPCODES_CLASS,Routine=class Ee{static{b(this,"_Routine")}static{__name(this,"Routine")}num_args;ops;opcodes;arg1;ref;label_count;labels;transpile;import_refs;import_values;import_self;locals_size;uses_arguments;as_function;object;callback;ics;constructor(e=0){this.num_args=e,this.ops=[],this.opcodes=[],this.arg1=[],this.ref=[],this.label_count=0,this.labels={},this.transpile=!1,this.import_refs=[],this.import_values=[],this.import_self=-1,this.ics={}}clone(){let e=new Ee(this.num_args);return e.opcodes=this.opcodes,e.arg1=this.arg1,e.ref=this.ref,e.locals_size=this.locals_size,e.uses_arguments=this.uses_arguments,e}createLabel(e="label"){return":"+e+"_"+this.label_count++}setLabel(e){return this.labels[e]=this.opcodes.length}optimize(){this.transpile&&new Transpiler().transpile(this)}removeable(e){let t=this.labels;for(let n in t)if(t[n]===e)return!1;return!0}remove(e){let t=this.labels;for(let n in t){let a=t[n];if(a===e)return!1;a>e&&(this.labels[n]-=1)}return this.opcodes.splice(e,1),this.arg1.splice(e,1),this.ref.splice(e,1),!0}resolveLabels(){for(let e=0;e<this.opcodes.length;e++){let t=this.opcodes[e];if(t===OPCODES.JUMP||t===OPCODES.JUMPY||t===OPCODES.JUMPN||t===OPCODES.JUMPY_NOPOP||t===OPCODES.JUMPN_NOPOP)this.labels[this.arg1[e]]&&(this.arg1[e]=this.labels[this.arg1[e]]);else if(t===OPCODES.FORLOOP_CONTROL||t===OPCODES.FORLOOP_INIT||t===OPCODES.FORIN_CONTROL||t===OPCODES.FORIN_INIT){let n=this.arg1[e];n&&this.labels[n[1]]&&(n[1]=this.labels[n[1]])}}}OP(e,t,n=0){return this.opcodes.push(e),this.arg1.push(n),this.ref.push(t)}OP_INSERT(e,t,n=0,a){this.opcodes.splice(a,0,e),this.arg1.splice(a,0,n),this.ref.splice(a,0,t);let l=this.labels;for(let h in l)l[h]>=a&&(this.labels[h]+=1)}TYPE(e){return this.OP(OPCODES.TYPE,e)}VARIABLE_TYPE(e,t){return this.OP(OPCODES.VARIABLE_TYPE,t,e)}PROPERTY_TYPE(e){return this.OP(OPCODES.PROPERTY_TYPE,e)}LOAD_THIS(e){return this.OP(OPCODES.LOAD_THIS,e)}LOAD_GLOBAL(e){return this.OP(OPCODES.LOAD_GLOBAL,e)}LOAD_VALUE(e,t){return this.OP(OPCODES.LOAD_VALUE,t,e)}LOAD_LOCAL(e,t){return this.OP(OPCODES.LOAD_LOCAL,t,e)}LOAD_VARIABLE(e,t){return this.OP(OPCODES.LOAD_VARIABLE,t,e)}LOAD_LOCAL_OBJECT(e,t){return this.OP(OPCODES.LOAD_LOCAL_OBJECT,t,e)}LOAD_VARIABLE_OBJECT(e,t){return this.OP(OPCODES.LOAD_VARIABLE_OBJECT,t,e)}POP(e){return this.OP(OPCODES.POP,e)}LOAD_PROPERTY(e){return this.OP(OPCODES.LOAD_PROPERTY,e)}LOAD_PROPERTY_OBJECT(e){return this.OP(OPCODES.LOAD_PROPERTY_OBJECT,e)}CREATE_OBJECT(e){return this.OP(OPCODES.CREATE_OBJECT,e)}MAKE_OBJECT(e){return this.OP(OPCODES.MAKE_OBJECT,e)}CREATE_ARRAY(e){return this.OP(OPCODES.CREATE_ARRAY,e)}CREATE_CLASS(e,t){return this.OP(OPCODES.CREATE_CLASS,t,e)}UPDATE_CLASS(e,t){return this.OP(OPCODES.UPDATE_CLASS,t,e)}NEW_CALL(e,t){return this.OP(OPCODES.NEW_CALL,t,e)}ADD(e,t=0){return this.OP(OPCODES.ADD,e,t)}SUB(e,t=0){return this.OP(OPCODES.SUB,e,t)}MUL(e){return this.OP(OPCODES.MUL,e)}DIV(e){return this.OP(OPCODES.DIV,e)}MODULO(e){return this.OP(OPCODES.MODULO,e)}BINARY_AND(e){return this.OP(OPCODES.BINARY_AND,e)}BINARY_OR(e){return this.OP(OPCODES.BINARY_OR,e)}SHIFT_LEFT(e){return this.OP(OPCODES.SHIFT_LEFT,e)}SHIFT_RIGHT(e){return this.OP(OPCODES.SHIFT_RIGHT,e)}NEGATE(e){return this.OP(OPCODES.NEGATE,e)}LOAD_PROPERTY_ATOP(e){return this.OP(OPCODES.LOAD_PROPERTY_ATOP,e)}EQ(e){return this.OP(OPCODES.EQ,e)}NEQ(e){return this.OP(OPCODES.NEQ,e)}LT(e){return this.OP(OPCODES.LT,e)}GT(e){return this.OP(OPCODES.GT,e)}LTE(e){return this.OP(OPCODES.LTE,e)}GTE(e){return this.OP(OPCODES.GTE,e)}NOT(e){return this.OP(OPCODES.NOT,e)}FORLOOP_INIT(e,t){return this.OP(OPCODES.FORLOOP_INIT,t,e)}FORLOOP_CONTROL(e,t){return this.OP(OPCODES.FORLOOP_CONTROL,t,e)}FORIN_INIT(e,t){return this.OP(OPCODES.FORIN_INIT,t,e)}FORIN_CONTROL(e,t){return this.OP(OPCODES.FORIN_CONTROL,t,e)}JUMP(e,t){return this.OP(OPCODES.JUMP,t,e)}JUMPY(e,t){return this.OP(OPCODES.JUMPY,t,e)}JUMPN(e,t){return this.OP(OPCODES.JUMPN,t,e)}JUMPY_NOPOP(e,t){return this.OP(OPCODES.JUMPY_NOPOP,t,e)}JUMPN_NOPOP(e,t){return this.OP(OPCODES.JUMPN_NOPOP,t,e)}STORE_LOCAL(e,t){return this.OP(OPCODES.STORE_LOCAL,t,e)}STORE_VARIABLE(e,t){return this.OP(OPCODES.STORE_VARIABLE,t,e)}CREATE_PROPERTY(e){return this.OP(OPCODES.CREATE_PROPERTY,e)}STORE_PROPERTY(e){return this.OP(OPCODES.STORE_PROPERTY,e)}LOAD_ROUTINE(e,t){return this.OP(OPCODES.LOAD_ROUTINE,t,e)}FUNCTION_CALL(e,t){return this.OP(OPCODES.FUNCTION_CALL,t,e)}FUNCTION_APPLY_VARIABLE(e,t){return this.OP(OPCODES.FUNCTION_APPLY_VARIABLE,t,e)}FUNCTION_APPLY_PROPERTY(e,t){return this.OP(OPCODES.FUNCTION_APPLY_PROPERTY,t,e)}SUPER_CALL(e,t){return this.OP(OPCODES.SUPER_CALL,t,e)}RETURN(e){return this.OP(OPCODES.RETURN,e)}AFTER(e){return this.OP(OPCODES.AFTER,e)}EVERY(e){return this.OP(OPCODES.EVERY,e)}DO(e){return this.OP(OPCODES.DO,e)}SLEEP(e){return this.OP(OPCODES.SLEEP,e)}DELETE(e){return this.OP(OPCODES.DELETE,e)}UNARY_OP(e,t){return this.OP(OPCODES.UNARY_OP,t,e)}BINARY_OP(e,t){return this.OP(OPCODES.BINARY_OP,t,e)}toString(){let e="";for(let t=0;t<this.opcodes.length;t++){let n=this.opcodes[t];e+=OPCODES[n],this.arg1[t]!=null&&(e+=` ${this.arg1[t]}`),e+=`
`}return e}exportArg(e){return e==null?0:e instanceof Ee?e.export():typeof e=="function"?e.name:e}export(){let e=[];for(let t=0;t<this.arg1.length;t++)e[t]=this.exportArg(this.arg1[t]);return{num_args:this.num_args,ops:this.opcodes,args:e,import_refs:this.import_refs,import_values:this.import_values,import_self:this.import_self,locals_size:this.locals_size}}import(e){this.num_args=e.num_args,this.opcodes=e.ops,this.arg1=e.args,this.import_refs=e.import_refs,this.import_values=e.import_values,this.import_self=e.import_self,this.locals_size=e.locals_size;let t={line:0,column:0,start:0,length:0,index:0,tokenizer:{filename:"filename",input:""}},n={expression:{token:t},token:t};for(let a=0;a<this.opcodes.length;a++)this.opcodes[a]===100?this.arg1[a]=Compiler.predefined_unary_functions[this.arg1[a]]:this.opcodes[a]===101?this.arg1[a]=Compiler.predefined_binary_functions[this.arg1[a]]:typeof this.arg1[a]=="object"&&!Array.isArray(this.arg1[a])&&(this.arg1[a]=new Ee(0).import(this.arg1[a])),this.ref[a]=n;return this}},Expression=class{static{b(this,"Expression")}static{__name(this,"Expression")}nowarning;nopop;constructor(){}},Program=class he{static{b(this,"_Program")}static{__name(this,"Program")}statements=[];static Field;static Variable;static Assignment;constructor(){this.statements=[]}add(e){return this.statements.push(e)}isAssignment(){return this.statements.length>0&&this.statements[this.statements.length-1]instanceof Assignment}static toString(e,t=0){let n,a,l,h,m;if(e instanceof Routine)return t===0&&e.source||"[function]";if(typeof e=="function")return"[native function]";if(typeof e=="string")return`"${e}"`;if(Array.isArray(e)){if(t>=1)return"[list]";for(h="[",n=0;n<e.length;n++)m=e[n],h+=he.toString(m,t+1)+(n<e.length-1?",":"");return h+"]"}else if(typeof e=="object"&&e!==null){if(t>=1)return"[object]";for(h=`object
`,l="",n=1;n<=t;n++)l+="  ";for(a in e)m=e[a],h+=l+`  ${a} = ${he.toString(m,t+1)}
`;return h+l+"end"}return e||0}static Precedence={"^":21,"/":20,"*":19,"%":18,"+":17,"-":17,"<":16,"<=":15,">":14,">=":13,"==":12,"!=":11,"<<":10,">>":9,"&":8,"|":7,and:6,or:5};static CreateFieldAccess(e,t,n){return t instanceof Field?(t.appendField(n),t):new Field(e,t,[n])}static BuildOperations(e,t){let n,a,l,h,m,E;for(;e.length>1;){for(n=0;n<e.length-1&&(l=e[n],h=e[n+1],!(he.Precedence[h.operation]<=he.Precedence[l.operation]));)n++;m=t[n],E=t[n+1],a=new Operation(e[n].token,e[n].operation,m,E),t.splice(n,2,a),e.splice(n,1)}return new Operation(e[0].token,e[0].operation,t[0],t[1])}},Assignment=class extends Expression{static{b(this,"Assignment")}static{__name(this,"Assignment")}token;field;expression;local;constructor(o,e,t,n){super(),this.token=o,this.field=e,this.expression=t,this.local=n}},SelfAssignment=class extends Expression{static{b(this,"SelfAssignment")}static{__name(this,"SelfAssignment")}token;field;operation;expression;constructor(o,e,t,n){super(),this.token=o,this.field=e,this.operation=t,this.expression=n}},Value=class extends Expression{static{b(this,"Value")}static{__name(this,"Value")}token;type;value;static TYPE_NUMBER=1;static TYPE_STRING=2;static TYPE_ARRAY=3;static TYPE_OBJECT=4;static TYPE_FUNCTION=5;static TYPE_CLASS=6;constructor(o,e,t){super(),this.token=o,this.type=e,this.value=t}},Variable=class extends Expression{static{b(this,"Variable")}static{__name(this,"Variable")}token;identifier;constructor(o,e){super(),this.token=o,this.identifier=e}},Field=class extends Expression{static{b(this,"Field")}static{__name(this,"Field")}token;expression;chain;constructor(o,e,t){super(),this.token=o,this.expression=e,this.chain=t,this.token=e instanceof Expression?e.token:o}appendField(o){return this.chain.push(o)}},Operation=class extends Expression{static{b(this,"Operation")}static{__name(this,"Operation")}token;operation;term1;term2;constructor(o,e,t,n){super(),this.token=o,this.operation=e,this.term1=t,this.term2=n}},Negate=class extends Expression{static{b(this,"Negate")}static{__name(this,"Negate")}token;expression;constructor(o,e){super(),this.token=o,this.expression=e}},Not=class extends Expression{static{b(this,"Not")}static{__name(this,"Not")}token;expression;constructor(o,e){super(),this.token=o,this.expression=e}},Braced=class extends Expression{static{b(this,"Braced")}static{__name(this,"Braced")}token;expression;constructor(o,e){super(),this.token=o,this.expression=e}},Return=class extends Expression{static{b(this,"Return")}static{__name(this,"Return")}token;expression;constructor(o,e){super(),this.token=o,this.expression=e}},Condition=class extends Expression{static{b(this,"Condition")}static{__name(this,"Condition")}token;chain;constructor(o,e){super(),this.token=o,this.chain=e}},For=class extends Expression{static{b(this,"For")}static{__name(this,"For")}token;iterator;range_from;range_to;range_by;sequence;constructor(o,e,t,n,a,l){super(),this.token=o,this.iterator=e,this.range_from=t,this.range_to=n,this.range_by=a,this.sequence=l}},ForIn=class extends Expression{static{b(this,"ForIn")}static{__name(this,"ForIn")}token;iterator;list;sequence;constructor(o,e,t,n){super(),this.token=o,this.iterator=e,this.list=t,this.sequence=n}},While=class extends Expression{static{b(this,"While")}static{__name(this,"While")}token;condition;sequence;constructor(o,e,t){super(),this.token=o,this.condition=e,this.sequence=t}},Break=class extends Expression{static{b(this,"Break")}static{__name(this,"Break")}token;nopop=!0;constructor(o){super(),this.token=o,this.nopop=!0}},Continue=class extends Expression{static{b(this,"Continue")}static{__name(this,"Continue")}token;nopop=!0;constructor(o){super(),this.token=o,this.nopop=!0}},Function=class extends Expression{static{b(this,"Function")}static{__name(this,"Function")}token;args;sequence;source;constructor(o,e,t,n){super(),this.token=o,this.args=e,this.sequence=t,this.source="function"+o.tokenizer.input.substring(o.index,n.index+2)}},FunctionCall=class extends Expression{static{b(this,"FunctionCall")}static{__name(this,"FunctionCall")}token;expression;args;constructor(o,e,t){super(),this.token=o,this.expression=e,this.args=t}},CreateObject=class extends Expression{static{b(this,"CreateObject")}static{__name(this,"CreateObject")}token;fields;constructor(o,e){super(),this.token=o,this.fields=e}},CreateClass=class extends Expression{static{b(this,"CreateClass")}static{__name(this,"CreateClass")}token;ext;fields;constructor(o,e,t){super(),this.token=o,this.ext=e,this.fields=t}},NewCall=class extends Expression{static{b(this,"NewCall")}static{__name(this,"NewCall")}token;expression;constructor(o,e){super(),this.token=o,this.expression=e,this.expression instanceof FunctionCall||(this.expression=new FunctionCall(this.token,this.expression,[]))}},After=class extends Expression{static{b(this,"After")}static{__name(this,"After")}token;delay;sequence;multiplier;source;constructor(o,e,t,n,a){super(),this.token=o,this.delay=e,this.sequence=t,this.multiplier=a,this.source="after "+o.tokenizer.input.substring(o.index,n.index+2)}},Every=class extends Expression{static{b(this,"Every")}static{__name(this,"Every")}token;delay;sequence;multiplier;source;constructor(o,e,t,n,a){super(),this.token=o,this.delay=e,this.sequence=t,this.multiplier=a,this.source="every "+o.tokenizer.input.substring(o.index,n.index+2)}},Do=class extends Expression{static{b(this,"Do")}static{__name(this,"Do")}token;sequence;source;constructor(o,e,t){super(),this.token=o,this.sequence=e,this.source="do "+o.tokenizer.input.substring(o.index,t.index+2)}},Sleep=class extends Expression{static{b(this,"Sleep")}static{__name(this,"Sleep")}token;delay;multiplier;constructor(o,e,t){super(),this.token=o,this.delay=e,this.multiplier=t}},Delete=class extends Expression{static{b(this,"Delete")}static{__name(this,"Delete")}token;field;constructor(o,e){super(),this.token=o,this.field=e}};Program.Field=Field;Program.Variable=Variable;Program.Assignment=Assignment;var Compiler2=class Q{static{b(this,"_Compiler")}static{__name(this,"Compiler")}program;code_saves;code;routine;locals;count;break_label;continue_label;processor;constructor(e){let t,n,a,l,h;for(this.program=e,this.code_saves=[],this.code=[""],this.routine=new Routine(0),this.locals=new Locals(this),this.count=0,this.break_label=null,this.continue_label=null,l=this.program.statements,t=n=0,a=l.length;n<a&&(h=l[t],this.compile(h),t<this.program.statements.length-1&&this.routine.POP(h),!(h instanceof Return||h instanceof Break||h instanceof Continue));t=++n);this.routine.optimize(),this.routine.resolveLabels(),this.optimizeFusedOpcodes(),this.count+=this.routine.opcodes.length,this.routine.locals_size=this.locals.max_index}optimizeFusedOpcodes(){let e=this.routine.opcodes,t=this.routine.arg1,n=this.routine.ref,a=0;for(;a<e.length-1;){if(e[a]===OPCODES.LOAD_VARIABLE&&e[a+1]===OPCODES.FUNCTION_CALL){let l=t[a],h=t[a+1],m=n[a+1];e[a]=OPCODES.LOAD_VAR_CALL,t[a]={name:l,args:h},n[a]=m,e.splice(a+1,1),t.splice(a+1,1),n.splice(a+1,1);continue}if(e[a]===OPCODES.LOAD_PROPERTY&&e[a+1]===OPCODES.FUNCTION_CALL){let l=t[a+1],h=n[a+1];e[a]=OPCODES.LOAD_PROP_CALL,t[a]=l,n[a]=h,e.splice(a+1,1),t.splice(a+1,1),n.splice(a+1,1);continue}if(e[a]===OPCODES.LOAD_VALUE&&typeof t[a]=="number"&&e[a+1]===OPCODES.ADD){let l=t[a],h=n[a+1];e[a]=OPCODES.LOAD_CONST_ADD,t[a]=l,n[a]=h,e.splice(a+1,1),t.splice(a+1,1),n.splice(a+1,1);continue}a++}}compile(e){if(e instanceof Value)this.compileValue(e);else if(e instanceof Operation)this.compileOperation(e);else if(e instanceof Assignment)this.compileAssignment(e);else if(e instanceof Variable)this.compileVariable(e);else if(e instanceof Function)this.compileFunction(e);else if(e instanceof FunctionCall)this.compileFunctionCall(e);else if(e instanceof While)this.compileWhile(e);else if(e instanceof SelfAssignment)this.compileSelfAssignment(e);else if(e instanceof Braced)this.compileBraced(e);else if(e instanceof CreateObject)this.compileCreateObject(e);else if(e instanceof Field)this.compileField(e);else if(e instanceof Negate)this.compileNegate(e);else if(e instanceof For)this.compileFor(e);else if(e instanceof ForIn)this.compileForIn(e);else if(e instanceof Not)this.compileNot(e);else if(e instanceof Return)this.compileReturn(e);else if(e instanceof Condition)this.compileCondition(e);else if(e instanceof Break)this.compileBreak(e);else if(e instanceof Continue)this.compileContinue(e);else if(e instanceof CreateClass)this.compileCreateClass(e);else if(e instanceof NewCall)this.compileNewCall(e);else if(e instanceof After)this.compileAfter(e);else if(e instanceof Every)this.compileEvery(e);else if(e instanceof Do)this.compileDo(e);else if(e instanceof Sleep)this.compileSleep(e);else if(e instanceof Delete)this.compileDelete(e);else throw console.info(e),"Not implemented"}compileAssignment(e){let t,n,a,l,h,m;if(e.local)if(e.field instanceof Variable)e.expression instanceof Function?(l=this.locals.register(e.field.identifier),this.compile(e.expression),this.routine.arg1[this.routine.arg1.length-1].import_self=l,this.routine.STORE_LOCAL(l,e)):e.expression instanceof After||e.expression instanceof Do||e.expression instanceof Every?(l=this.locals.register(e.field.identifier),t=this.routine.arg1.length,this.compile(e.expression),this.routine.arg1[t].import_self=l,this.routine.STORE_LOCAL(l,e)):(this.compile(e.expression),l=this.locals.register(e.field.identifier),this.routine.STORE_LOCAL(l,e));else throw"illegal";else if(e.field instanceof Variable)this.locals.get(e.field.identifier)!=null?(this.compile(e.expression),l=this.locals.get(e.field.identifier),this.routine.STORE_LOCAL(l,e)):e.expression instanceof CreateClass?this.compileUpdateClass(e.expression,e.field.identifier):(this.compile(e.expression),this.routine.STORE_VARIABLE(e.field.identifier,e));else{for(n=e.field,n.expression instanceof Variable?n.expression.identifier==="this"?this.routine.LOAD_THIS(n):this.locals.get(n.expression.identifier)!=null?(l=this.locals.get(n.expression.identifier),this.routine.LOAD_LOCAL_OBJECT(l,n.expression)):n.expression.identifier==="global"?this.routine.LOAD_GLOBAL(n):this.routine.LOAD_VARIABLE_OBJECT(n.expression.identifier,e):(this.compile(n.expression),this.routine.MAKE_OBJECT(e)),a=h=0,m=n.chain.length-2;h<=m;a=h+=1)this.compile(n.chain[a]),this.routine.LOAD_PROPERTY_OBJECT(n.chain[a]);this.compile(n.chain[n.chain.length-1]),this.compile(e.expression),this.routine.STORE_PROPERTY(e)}}compileSelfAssignment(e){let t,n,a,l,h,m;switch(e.operation){case"+=":h="ADD";break;case"-=":h="SUB";break;case"*=":h="MUL";break;case"/=":h="DIV";break;case"%=":h="MODULO";break;case"&=":h="BINARY_AND";break;case"|=":h="BINARY_OR";break;default:throw"Unknown self-assignment operation: "+e.operation}if(e.field instanceof Variable)this.locals.get(e.field.identifier)!=null?(a=this.locals.get(e.field.identifier),this.routine.LOAD_LOCAL(a,e),this.compile(e.expression),this.routine[h](e),this.routine.STORE_LOCAL(a,e)):(this.routine.LOAD_VARIABLE(e.field.identifier,e),this.compile(e.expression),this.routine[h](e),this.routine.STORE_VARIABLE(e.field.identifier,e));else{for(t=e.field,t.expression instanceof Variable?t.expression.identifier==="this"?this.routine.LOAD_THIS(t):this.locals.get(t.expression.identifier)!=null?(a=this.locals.get(t.expression.identifier),this.routine.LOAD_LOCAL_OBJECT(a,e)):t.expression.identifier==="global"?this.routine.LOAD_GLOBAL(t):this.routine.LOAD_VARIABLE_OBJECT(t.expression.identifier,e):(this.compile(t.expression),this.routine.MAKE_OBJECT(e)),n=l=0,m=t.chain.length-2;l<=m;n=l+=1)this.compile(t.chain[n]),this.routine.LOAD_PROPERTY_OBJECT(t.chain[n]);this.compile(t.chain[t.chain.length-1]),this.routine.LOAD_PROPERTY_ATOP(e),this.compile(e.expression),this.routine[h](e),this.routine.STORE_PROPERTY(e)}}compileOperation(e){let t,n,a;if((n=e.operation)==="+"||n==="-"||n==="*"||n==="/"||n==="%"||n==="&"||n==="|"||n==="<<"||n===">>"){if(e.term1 instanceof Value&&e.term1.type===Value.TYPE_NUMBER&&e.term2 instanceof Value&&e.term2.type===Value.TYPE_NUMBER){let l,h=e.term1.value,m=e.term2.value;switch(e.operation){case"+":l=h+m;break;case"-":l=h-m;break;case"*":l=h*m;break;case"/":l=h/m;break;case"%":l=h%m;break;case"&":l=h&m;break;case"|":l=h|m;break;case"<<":l=h<<m;break;case">>":l=h>>m;break;default:l=0}this.routine.LOAD_VALUE(l,e);return}switch(this.compile(e.term1),this.compile(e.term2),e.operation){case"+":this.routine.ADD(e);break;case"-":this.routine.SUB(e);break;case"*":this.routine.MUL(e);break;case"/":this.routine.DIV(e);break;case"%":this.routine.MODULO(e);break;case"&":this.routine.BINARY_AND(e);break;case"|":this.routine.BINARY_OR(e);break;case"<<":this.routine.SHIFT_LEFT(e);break;case">>":this.routine.SHIFT_RIGHT(e)}}else if((a=e.operation)==="=="||a==="!="||a==="<"||a===">"||a==="<="||a===">=")switch(this.compile(e.term1),this.compile(e.term2),e.operation){case"==":this.routine.EQ(e);break;case"!=":this.routine.NEQ(e);break;case"<":this.routine.LT(e);break;case">":this.routine.GT(e);break;case"<=":this.routine.LTE(e);break;case">=":this.routine.GTE(e)}else e.operation==="and"?(t=this.routine.createLabel("and"),e.term1.nowarning=!0,e.term2.nowarning=!0,this.compile(e.term1),this.routine.JUMPN_NOPOP(t,e),this.routine.POP(e),this.compile(e.term2),this.routine.setLabel(t)):e.operation==="or"?(t=this.routine.createLabel("or"),e.term1.nowarning=!0,e.term2.nowarning=!0,this.compile(e.term1),this.routine.JUMPY_NOPOP(t,e),this.routine.POP(e),this.compile(e.term2),this.routine.setLabel(t)):e.operation==="^"&&(this.compile(e.term1),this.compile(e.term2),this.routine.BINARY_OP(Q.predefined_binary_functions.pow,e))}compileBraced(e){this.compile(e.expression)}compileNegate(e){e.expression instanceof Value&&e.expression.type===Value.TYPE_NUMBER?this.routine.LOAD_VALUE(-e.expression.value,e):(this.compile(e.expression),this.routine.NEGATE(e))}compileNot(e){e.expression.nowarning=!0,this.compile(e.expression),this.routine.NOT(e)}compileValue(e){let t,n,a;switch(e.type){case Value.TYPE_NUMBER:this.routine.LOAD_VALUE(e.value,e);break;case Value.TYPE_STRING:this.routine.LOAD_VALUE(e.value,e);break;case Value.TYPE_ARRAY:for(this.routine.CREATE_ARRAY(e),t=n=0,a=e.value.length-1;n<=a;t=n+=1)this.routine.LOAD_VALUE(t,e),this.compile(e.value[t]),this.routine.CREATE_PROPERTY(e)}}compileVariable(e){let t,n;n=e.identifier,n==="this"?this.routine.LOAD_THIS(e):n==="global"?this.routine.LOAD_GLOBAL(e):Q.predefined_values[n]!=null?this.routine.LOAD_VALUE(Q.predefined_values[n],e):this.locals.get(n)!=null?(t=this.locals.get(n),this.routine.LOAD_LOCAL(t,e)):this.routine.LOAD_VARIABLE(n,e)}compileField(e){var t,n,a,l,h,m,E,O,g;if((e.expression.identifier==="keyboard"||e.expression.identifier==="gamepad")&&(e.nowarning=!0),t=e.chain[e.chain.length-1],t instanceof Value&&t.value==="type")if(e.chain.length===1)e.expression instanceof Variable?(a=e.expression.identifier,this.locals.get(a)!=null?(l=this.locals.get(a),this.routine.LOAD_LOCAL(l,e),this.routine.TYPE(e)):Q.predefined_values[a]!=null?this.routine.LOAD_VALUE("number",e):Q.predefined_unary_functions[a]!=null||Q.predefined_binary_functions[a]?this.routine.LOAD_VALUE("function",e):this.routine.VARIABLE_TYPE(a,e.expression)):(this.compile(e.expression),this.routine.TYPE(e));else{for(this.compile(e.expression),n=h=0,O=e.chain.length-3;h<=O;n=h+=1)this.compile(e.chain[n]),this.routine.LOAD_PROPERTY(e);this.compile(e.chain[e.chain.length-2]),this.routine.PROPERTY_TYPE(e.expression)}else for(this.compile(e.expression),g=e.chain,m=0,E=g.length;m<E;m++)t=g[m],this.compile(t),this.routine.LOAD_PROPERTY(e)}compileFieldParent(e){var t,n,a,l;for(this.compile(e.expression),n=a=0,l=e.chain.length-2;a<=l;n=a+=1)t=e.chain[n],this.compile(t),this.routine.LOAD_PROPERTY(e)}compileFunctionCall(e){var t,n,a,l,h,m,E,O,g,R,x,T,D,d,U,$,Y,C,J;if(e.expression instanceof Field){for(U=e.args,a=h=0,O=U.length;h<O;a=++h)t=U[a],this.compile(t);this.compileFieldParent(e.expression),this.compile(e.expression.chain[e.expression.chain.length-1]),this.routine.FUNCTION_APPLY_PROPERTY(e.args.length,e)}else if(e.expression instanceof Variable)if(Q.predefined_unary_functions[e.expression.identifier]!=null)n=Q.predefined_unary_functions[e.expression.identifier],e.args.length>0?this.compile(e.args[0]):this.routine.LOAD_VALUE(0,e),this.routine.UNARY_OP(n,e);else if(Q.predefined_binary_functions[e.expression.identifier]!=null)n=Q.predefined_binary_functions[e.expression.identifier],e.args.length>0?this.compile(e.args[0]):this.routine.LOAD_VALUE(0,e),e.args.length>1?this.compile(e.args[1]):this.routine.LOAD_VALUE(0,e),this.routine.BINARY_OP(n,e);else if(e.expression.identifier==="super"){for($=e.args,a=m=0,g=$.length;m<g;a=++m)t=$[a],this.compile(t);this.routine.SUPER_CALL(e.args.length,e)}else if(this.locals.get(e.expression.identifier)!=null){for(Y=e.args,a=E=0,R=Y.length;E<R;a=++E)t=Y[a],this.compile(t);l=this.locals.get(e.expression.identifier),this.routine.LOAD_LOCAL(l,e),this.routine.FUNCTION_CALL(e.args.length,e)}else{for(C=e.args,a=D=0,x=C.length;D<x;a=++D)t=C[a],this.compile(t);this.routine.LOAD_VALUE(e.expression.identifier,e),this.routine.FUNCTION_APPLY_VARIABLE(e.args.length,e)}else{for(J=e.args,d=0,T=J.length;d<T;d++)t=J[d],this.compile(t);this.compile(e.expression),this.routine.FUNCTION_CALL(e.args.length,e)}}compileFor(e){if(e.range_from instanceof Value&&e.range_from.type===Value.TYPE_NUMBER&&e.range_to instanceof Value&&e.range_to.type===Value.TYPE_NUMBER&&(e.range_by==null||e.range_by instanceof Value&&e.range_by.type===Value.TYPE_NUMBER)){let E=e.range_from.value,O=e.range_to.value,g=e.range_by instanceof Value?e.range_by.value:1,R=0;if(g>0&&O>=E?R=Math.floor((O-E)/g)+1:g<0&&O<=E&&(R=Math.floor((E-O)/Math.abs(g))+1),R>0&&R<=5){let x=this.locals.register(e.iterator);this.locals.push();for(let T=0;T<R;T++){let D=E+T*g;this.routine.LOAD_VALUE(D,e),this.routine.STORE_LOCAL(x,e),this.routine.POP(e),this.compileSequence(e.sequence)}this.locals.pop();return}}var t,n,a,l,h,m;l=this.locals.register(e.iterator),this.locals.allocate(),this.locals.allocate(),this.compile(e.range_from),this.routine.STORE_LOCAL(l,e),this.routine.POP(e),this.compile(e.range_to),e.range_by!=null?this.compile(e.range_by):this.routine.LOAD_VALUE(0,e),a=this.routine.createLabel("for_start"),t=this.routine.createLabel("for_continue"),n=this.routine.createLabel("for_end"),this.routine.FORLOOP_INIT([l,n],e),this.routine.setLabel(a),this.locals.push(),h=this.break_label,m=this.continue_label,this.break_label=n,this.continue_label=t,this.compileSequence(e.sequence),this.break_label=h,this.continue_label=m,this.routine.setLabel(t),this.routine.FORLOOP_CONTROL([l,a],e),this.routine.setLabel(n),this.locals.pop()}compileForIn(e){var t,n,a,l,h,m;l=this.locals.register(e.iterator),this.locals.allocate(),this.locals.allocate(),this.compile(e.list),a=this.routine.createLabel("for_start"),t=this.routine.createLabel("for_continue"),n=this.routine.createLabel("for_end"),this.routine.FORIN_INIT([l,n],e),this.routine.setLabel(a),this.locals.push(),h=this.break_label,m=this.continue_label,this.break_label=n,this.continue_label=t,this.compileSequence(e.sequence),this.break_label=h,this.continue_label=m,this.routine.setLabel(t),this.routine.FORIN_CONTROL([l,a],e),this.routine.setLabel(n),this.locals.pop()}compileSequence(e){var t,n,a;for(t=n=0,a=e.length-1;n<=a&&(e[t].nopop||this.routine.POP(e[t]),this.compile(e[t]),!(e[t]instanceof Return||e[t]instanceof Break||e[t]instanceof Continue));t=n+=1);}compileWhile(e){var t,n,a,l;this.locals.push(),l=this.routine.createLabel("while_start"),t=this.routine.createLabel("while_end"),this.routine.LOAD_VALUE(0,e),this.routine.setLabel(l),this.compile(e.condition),this.routine.JUMPN(t),n=this.break_label,a=this.continue_label,this.break_label=t,this.continue_label=l,this.compileSequence(e.sequence),this.routine.JUMP(l,e),this.break_label=n,this.continue_label=a,this.routine.setLabel(t),this.locals.pop()}compileBreak(e){this.break_label!=null&&this.routine.JUMP(this.break_label,e)}compileContinue(e){this.continue_label!=null&&this.routine.JUMP(this.continue_label,e)}compileFunction(e){var t;t=this.compileFunctionBody(e),this.routine.LOAD_ROUTINE(t,e)}compileFunctionBody(e){let t="args"in e&&e.args!=null;var n,a,l,h,m,E,O,g,R,x,T,D,d,U,$,Y,C;if(C=this.routine,x=this.locals,this.routine=new Routine(t?e.args.length:0),this.locals=new Locals(this,x),this.routine.uses_arguments=!0,t){let J=e.args;for(this.routine.uses_arguments&&(a=this.locals.register("arguments"),this.routine.STORE_LOCAL(a,e),this.routine.POP(e)),D=this.locals.register("+numargs"),this.routine.STORE_LOCAL(D,e),this.routine.POP(e),l=m=U=J.length-1;m>=0;l=m+=-1)n=J[l],h=this.locals.register(n.name),this.routine.STORE_LOCAL(h,e),this.routine.POP(e);for(l=E=0,U=J.length-1;E<=U;l=E+=1)n=J[l],n.default!=null&&(h=this.locals.get(n.name),g=this.routine.createLabel("default_arg"),this.routine.LOAD_VALUE(l,e),this.routine.LOAD_LOCAL(D,e),this.routine.LT(e),this.routine.JUMPY(g,e),this.compile(n.default),this.routine.STORE_LOCAL(h,e),this.routine.POP(e),this.routine.setLabel(g))}if(e.sequence.length>0)for(l=O=0,$=e.sequence.length-1;O<=$;l=O+=1)this.compile(e.sequence[l]),l<e.sequence.length-1?this.routine.POP(e.sequence[l]):this.routine.RETURN(e.sequence[l]);else this.routine.LOAD_VALUE(0,e),this.routine.RETURN(e);for(t&&!this.locals.arguments_used&&(this.routine.uses_arguments=!1,this.routine.remove(0),this.routine.remove(0)),h=0,Y=this.locals.imports,T=0,R=Y.length;T<R;T++){let J=Y[T];this.routine.OP_INSERT(OPCODES.LOAD_IMPORT,e,h,h*3),this.routine.OP_INSERT(OPCODES.STORE_LOCAL,e,J.index,h*3+1),this.routine.OP_INSERT(OPCODES.POP,e,0,h*3+2),this.routine.import_refs.push(J.source),h+=1}return this.routine.optimize(),this.routine.resolveLabels(),this.count+=this.routine.opcodes.length,d=this.routine,this.routine.locals_size=this.locals.max_index,this.routine=C,this.locals=x,d}compileReturn(e){e.expression!=null?(this.compile(e.expression),this.routine.RETURN(e)):(this.routine.LOAD_VALUE(0,e),this.routine.RETURN(e))}compileCondition(e){var t,n,a,l,h,m,E;for(n=e.chain,this.routine.LOAD_VALUE(0,e),a=this.routine.createLabel("condition_end"),h=m=0,E=n.length-1;m<=E;h=m+=1)l=this.routine.createLabel("condition_next"),t=n[h],t.condition.nowarning=!0,this.compile(t.condition),this.routine.JUMPN(l),this.locals.push(),this.compileSequence(t.sequence),this.locals.pop(),this.routine.JUMP(a,e),this.routine.setLabel(l),h===n.length-1&&t.else!=null&&(this.locals.push(),this.compileSequence(t.else),this.locals.pop());this.routine.setLabel(a)}formatField(e){return e==="constructor"&&(e="_constructor"),String(e).replace(/"/g,'\\"')}compileCreateObject(e){let t,n,a,l;for(this.routine.CREATE_OBJECT(e),l=e.fields,n=0,a=l.length;n<a;n++)t=l[n],this.routine.LOAD_VALUE(t.field,e),this.compile(t.value),this.routine.CREATE_PROPERTY(e)}compileCreateClass(e){let t,n,a,l,h;for(e.ext!=null?(e.ext.nowarning=!0,this.compile(e.ext)):this.routine.LOAD_VALUE(0,e),h=e.ext!=null&&e.ext instanceof Variable?e.ext.identifier:0,this.routine.CREATE_CLASS(h,e),l=e.fields,n=0,a=l.length;n<a;n++)t=l[n],this.routine.LOAD_VALUE(t.field,e),this.compile(t.value),this.routine.CREATE_PROPERTY(e)}compileUpdateClass(e,t){this.compileCreateClass(e),this.routine.UPDATE_CLASS(t,e)}compileNewCall(e){let t,n,a,l,h,m;for(n=e.expression,this.routine.LOAD_VALUE(0,e),m=n.args,a=l=0,h=m.length;l<h;a=++l)t=m[a],this.compile(t);this.compile(n.expression),this.routine.NEW_CALL(n.args.length,e),this.routine.POP(e)}compileAfter(e){let t;t=this.compileFunctionBody(e),this.routine.LOAD_ROUTINE(t,e),this.compile(e.delay),e.multiplier!=null&&e.multiplier!==1&&(this.routine.LOAD_VALUE(e.multiplier,e),this.routine.MUL(e)),this.routine.AFTER(e)}compileEvery(e){let t;t=this.compileFunctionBody(e),this.routine.LOAD_ROUTINE(t,e),this.compile(e.delay),e.multiplier!=null&&e.multiplier!==1&&(this.routine.LOAD_VALUE(e.multiplier,e),this.routine.MUL(e)),this.routine.EVERY(e)}compileDo(e){let t;t=this.compileFunctionBody(e),this.routine.LOAD_ROUTINE(t,e),this.routine.DO(e)}compileSleep(e){this.compile(e.delay),e.multiplier!=null&&e.multiplier!==1&&(this.routine.LOAD_VALUE(e.multiplier,e),this.routine.MUL(e)),this.routine.SLEEP(e)}compileDelete(e){let t,n,a,l;if(e.field instanceof Variable)this.routine.LOAD_THIS(e),this.routine.LOAD_VALUE(e.field.identifier,e),this.routine.DELETE(e);else if(e.field instanceof Field){for(this.compile(e.field.expression),t=e.field.chain,n=a=0,l=t.length-1;a<=l;n=a+=1)this.compile(t[n]),n<t.length-1&&this.routine.LOAD_PROPERTY(e);this.routine.DELETE(e)}else throw"Delete expects variable or field access"}exec(e){if(this.processor||(this.processor=new globalThis.Processor),!this.routine)throw new Error("No routine to execute");return this.processor.load(this.routine),this.processor.run(e)}static predefined_unary_functions={round:Math.round,floor:Math.floor,ceil:Math.ceil,abs:Math.abs,sqrt:Math.sqrt,sin:Math.sin,cos:Math.cos,tan:Math.tan,acos:Math.acos,asin:Math.asin,atan:Math.atan,sind:__name(e=>Math.sin(e*Math.PI/180),"sind"),cosd:__name(e=>Math.cos(e*Math.PI/180),"cosd"),tand:__name(e=>Math.tan(e*Math.PI/180),"tand"),asind:__name(e=>Math.asin(e)/Math.PI*180,"asind"),acosd:__name(e=>Math.acos(e)/Math.PI*180,"acosd"),atand:__name(e=>Math.atan(e)/Math.PI*180,"atand"),log:Math.log,exp:Math.exp};static predefined_binary_functions={min:Math.min,max:Math.max,pow:Math.pow,atan2:Math.atan2,atan2d:__name((e,t)=>Math.atan2(e,t)/Math.PI*180,"atan2d")};static predefined_values={PI:Math.PI,true:1,false:0}},Locals=class{static{b(this,"Locals")}static{__name(this,"Locals")}compiler;parent;layers;index;max_index;imports;arguments_used;constructor(o,e=null){this.compiler=o,this.parent=e,this.layers=[],this.index=0,this.max_index=0,this.imports=[],this.push()}increment(){let o=this.index++;return this.max_index=Math.max(this.index,this.max_index),o}push(){return this.layers.push(new LocalLayer(this))}pop(){return this.layers.splice(this.layers.length-1,1)}register(o){return this.layers[this.layers.length-1].register(o)}allocate(){return this.layers[this.layers.length-1].allocate()}get(o){let e,t,n,a;for(o==="arguments"&&(this.arguments_used=!0),e=n=this.layers.length-1;n>=0;e=n-=1)if(a=this.layers[e].get(o),a!=null)return a;return this.parent!=null&&(a=this.parent.get(o),a!=null)?(t=this.register(o),this.imports.push({name:o,index:t,source:a}),t):null}},LocalLayer=class{static{b(this,"LocalLayer")}static{__name(this,"LocalLayer")}locals;start_index;registered;constructor(o){this.locals=o,this.start_index=this.locals.index,this.registered={}}register(o){return this.registered[o]=this.locals.increment()}allocate(){return this.locals.increment()}get(o){return this.registered[o]!=null?this.registered[o]:null}},Token=class w{static{b(this,"_Token")}static{__name(this,"Token")}tokenizer;type;value;string_value;line;column;start;length;index;reserved_keyword;is_binary_operator;constructor(e,t,n,a){this.tokenizer=e,this.type=t,this.value=n,this.string_value=a,this.line=e.line,this.column=e.column,this.start=e.token_start,this.length=e.index-this.start,this.index=e.index,this.type===w.TYPE_IDENTIFIER&&Object.hasOwn(w.predefined,String(this.value))&&(this.type=w.predefined[String(this.value)],this.reserved_keyword=!0),this.is_binary_operator=this.type>=30&&this.type<=39||this.type>=200&&this.type<=201||this.type>=2&&this.type<=7}toString(){return String(this.value)+" : "+this.type}static TYPE_EQUALS=1;static TYPE_DOUBLE_EQUALS=2;static TYPE_GREATER=3;static TYPE_GREATER_OR_EQUALS=4;static TYPE_LOWER=5;static TYPE_LOWER_OR_EQUALS=6;static TYPE_UNEQUALS=7;static TYPE_IDENTIFIER=10;static TYPE_NUMBER=11;static TYPE_STRING=12;static TYPE_OPEN_BRACE=20;static TYPE_CLOSED_BRACE=21;static TYPE_OPEN_BRACKET=24;static TYPE_CLOSED_BRACKET=25;static TYPE_COMMA=26;static TYPE_DOT=27;static TYPE_COLON=28;static TYPE_PLUS=30;static TYPE_MINUS=31;static TYPE_MULTIPLY=32;static TYPE_DIVIDE=33;static TYPE_POWER=34;static TYPE_MODULO=35;static TYPE_BINARY_AND=36;static TYPE_BINARY_OR=37;static TYPE_SHIFT_LEFT=38;static TYPE_SHIFT_RIGHT=39;static TYPE_PLUS_EQUALS=40;static TYPE_MINUS_EQUALS=41;static TYPE_MULTIPLY_EQUALS=42;static TYPE_DIVIDE_EQUALS=43;static TYPE_MODULO_EQUALS=44;static TYPE_AND_EQUALS=45;static TYPE_OR_EQUALS=46;static TYPE_RETURN=100;static TYPE_BREAK=101;static TYPE_CONTINUE=102;static TYPE_FUNCTION=103;static TYPE_IF=104;static TYPE_THEN=105;static TYPE_ELSE=106;static TYPE_ELSIF=107;static TYPE_END=108;static TYPE_FOR=109;static TYPE_TO=110;static TYPE_BY=111;static TYPE_IN=112;static TYPE_WHILE=113;static TYPE_OBJECT=114;static TYPE_CLASS=115;static TYPE_EXTENDS=116;static TYPE_NEW=117;static TYPE_ARROW=118;static TYPE_TEMPLATE=119;static TYPE_AFTER=61;static TYPE_EVERY=62;static TYPE_DO=63;static TYPE_SLEEP=64;static TYPE_LOCAL=70;static TYPE_AND=200;static TYPE_OR=201;static TYPE_NOT=202;static TYPE_ERROR=404;static TYPE_DELETE=403;static predefined={return:w.TYPE_RETURN,break:w.TYPE_BREAK,continue:w.TYPE_CONTINUE,function:w.TYPE_FUNCTION,for:w.TYPE_FOR,to:w.TYPE_TO,by:w.TYPE_BY,in:w.TYPE_IN,while:w.TYPE_WHILE,if:w.TYPE_IF,then:w.TYPE_THEN,else:w.TYPE_ELSE,elsif:w.TYPE_ELSIF,end:w.TYPE_END,object:w.TYPE_OBJECT,class:w.TYPE_CLASS,extends:w.TYPE_EXTENDS,new:w.TYPE_NEW,and:w.TYPE_AND,or:w.TYPE_OR,not:w.TYPE_NOT,after:w.TYPE_AFTER,every:w.TYPE_EVERY,do:w.TYPE_DO,sleep:w.TYPE_SLEEP,delete:w.TYPE_DELETE,local:w.TYPE_LOCAL,var:w.TYPE_LOCAL,let:w.TYPE_LOCAL}},Tokenizer=class{static{b(this,"Tokenizer")}static{__name(this,"Tokenizer")}input;filename;index=0;line=1;column=0;last_column=0;buffer=[];token_start=0;chars={};doubles={};shifts={};letter_regex=/^\p{L}/u;constructor(o,e){this.input=o,this.filename=e,this.chars["("]=Token.TYPE_OPEN_BRACE,this.chars[")"]=Token.TYPE_CLOSED_BRACE,this.chars["["]=Token.TYPE_OPEN_BRACKET,this.chars["]"]=Token.TYPE_CLOSED_BRACKET,this.chars["{"]=22,this.chars["}"]=23,this.chars["^"]=Token.TYPE_POWER,this.chars[","]=Token.TYPE_COMMA,this.chars["."]=Token.TYPE_DOT,this.chars[":"]=Token.TYPE_COLON,this.doubles[">"]=[Token.TYPE_GREATER,Token.TYPE_GREATER_OR_EQUALS],this.doubles["<"]=[Token.TYPE_LOWER,Token.TYPE_LOWER_OR_EQUALS],this.doubles["="]=[Token.TYPE_EQUALS,Token.TYPE_DOUBLE_EQUALS],this.doubles["+"]=[Token.TYPE_PLUS,Token.TYPE_PLUS_EQUALS],this.doubles["-"]=[Token.TYPE_MINUS,Token.TYPE_MINUS_EQUALS],this.doubles["*"]=[Token.TYPE_MULTIPLY,Token.TYPE_MULTIPLY_EQUALS],this.doubles["/"]=[Token.TYPE_DIVIDE,Token.TYPE_DIVIDE_EQUALS],this.doubles["%"]=[Token.TYPE_MODULO,Token.TYPE_MODULO_EQUALS],this.doubles["&"]=[Token.TYPE_BINARY_AND,Token.TYPE_AND_EQUALS],this.doubles["|"]=[Token.TYPE_BINARY_OR,Token.TYPE_OR_EQUALS],this.shifts["<"]=Token.TYPE_SHIFT_LEFT,this.shifts[">"]=Token.TYPE_SHIFT_RIGHT}pushBack(o){return this.buffer.splice(0,0,o),o}peek(){if(this.buffer.length>0)return this.buffer[0];let o=this.next();return o&&this.pushBack(o),o}finished(){return this.index>=this.input.length&&this.buffer.length===0}nextChar(o=!1){let e,t;if(e=this.input.charAt(this.index++),e===`
`)this.line+=1,this.last_column=this.column,this.column=0;else if(e==="/"&&!o){if(this.input.charAt(this.index)==="/"){for(;e=this.input.charAt(this.index++),!(e===`
`||this.index>=this.input.length););return this.line+=1,this.last_column=this.column,this.column=0,this.nextChar()}else if(this.input.charAt(this.index)==="*"){for(t=0;;){if(e=this.input.charAt(this.index++),e===`
`)this.line+=1,this.last_column=this.column,this.column=0,t=0;else if(e==="*")t=1;else{if(e==="/"&&t===1)break;t=0}if(this.index>=this.input.length)break}return this.nextChar()}}else this.column+=1;return e}rewind(){this.index-=1,this.column-=1,this.input.charAt(this.index)===`
`&&(this.line-=1,this.column=this.last_column)}next(){let o,e;if(this.buffer.length>0)return this.buffer.splice(0,1)[0];for(;;){if(this.index>=this.input.length)return null;if(o=this.nextChar(),e=o.charCodeAt(0),e>32&&e!==160)break}return this.token_start=this.index-1,this.doubles[o]!=null?this.parseDouble(o,this.doubles[o]):this.chars[o]!=null?new Token(this,this.chars[o],o):o==="!"?this.parseUnequals(o):e>=48&&e<=57?this.parseNumber(o):e>=65&&e<=90||e>=97&&e<=122||e===95||this.letter_regex.test(o)?this.parseIdentifier(o):o==='"'?this.parseString(o,'"'):o==="'"?this.parseString(o,"'"):o==="`"?this.parseString(o,"`"):this.error("Syntax Error")}changeNumberToIdentifier(){let o,e,t,n=[];if(e=this.next(),e!=null&&e.type===Token.TYPE_NUMBER){for(t=(e.string_value||String(e.value)).split("."),o=t.length-1;o>=0;o--)t[o].length>0&&this.pushBack(new Token(this,Token.TYPE_IDENTIFIER,t[o])),o>0&&n.push(this.pushBack(new Token(this,Token.TYPE_DOT,".")));return n}else return e!=null&&e.type===Token.TYPE_STRING?this.pushBack(new Token(this,Token.TYPE_IDENTIFIER,e.value)):e?this.pushBack(e):void 0}parseDouble(o,e){let t=this.input.charAt(this.index);return o==="="&&t===">"?(this.nextChar(),new Token(this,Token.TYPE_ARROW,"=>")):this.shifts[o]!=null&&this.index<this.input.length&&t===o?(this.nextChar(),new Token(this,this.shifts[o],o+o)):e&&this.index<this.input.length&&t==="="?(this.nextChar(),new Token(this,e[1],o+"=")):new Token(this,e?e[0]:this.chars[o],o)}parseEquals(o){return this.index<this.input.length&&this.input.charAt(this.index)==="="?(this.nextChar(),new Token(this,Token.TYPE_DOUBLE_EQUALS,"==")):new Token(this,Token.TYPE_EQUALS,"=")}parseGreater(o){return this.index<this.input.length&&this.input.charAt(this.index)==="="?(this.nextChar(),new Token(this,Token.TYPE_GREATER_OR_EQUALS,">=")):new Token(this,Token.TYPE_GREATER,">")}parseLower(o){return this.index<this.input.length&&this.input.charAt(this.index)==="="?(this.nextChar(),new Token(this,Token.TYPE_LOWER_OR_EQUALS,"<=")):new Token(this,Token.TYPE_LOWER,"<")}parseUnequals(o){return this.index<this.input.length&&this.input.charAt(this.index)==="="?(this.nextChar(),new Token(this,Token.TYPE_UNEQUALS,"!=")):this.error("Expected inequality !=")}parseIdentifier(o){let e,t;for(;;){if(this.index>=this.input.length)return new Token(this,Token.TYPE_IDENTIFIER,o);if(e=this.nextChar(),t=e.charCodeAt(0),t>=65&&t<=90||t>=97&&t<=122||t===95||t>=48&&t<=57||this.letter_regex.test(e))o+=e;else return this.rewind(),new Token(this,Token.TYPE_IDENTIFIER,o)}}parseNumber(o){let e,t,n=!1,a=!1;for(;;){if(this.index>=this.input.length)return new Token(this,Token.TYPE_NUMBER,Number.parseFloat(o),o);if(e=this.nextChar(),t=e.charCodeAt(0),e==="."&&!a&&!n)a=!0,o+=e;else if(t>=48&&t<=57)o+=e;else if((e==="e"||e==="E")&&!n&&this.index<this.input.length)n=!0,o+=e,e=this.nextChar(),e==="+"||e==="-"?o+=e:this.rewind();else return(e==="x"||e==="X")&&o==="0"?this.parseHexNumber("0x"):(this.rewind(),new Token(this,Token.TYPE_NUMBER,Number.parseFloat(o),o))}}parseHexNumber(o){let e;for(;;){if(this.index>=this.input.length)return new Token(this,Token.TYPE_NUMBER,Number.parseInt(o),o);if(e=this.nextChar(),/[a-fA-F0-9]/.test(e))o+=e;else return this.rewind(),new Token(this,Token.TYPE_NUMBER,Number.parseInt(o),o)}}parseString(o,e){let t,n=0,a;for(e==null&&(e='"'),e==='"'&&this.input.charAt(this.index)==='"'&&this.input.charAt(this.index+1)==='"'&&this.input.charAt(this.index+2)!=='"'&&(e='"""',this.nextChar(!0),this.nextChar(!0));;){if(this.index>=this.input.length)return this.error("Unclosed string value");if(t=this.nextChar(!0),t==="\\")switch(a=this.nextChar(!0),a){case"n":o+=`
`;break;case"\\":o+="\\";break;case e:o+=e;break;default:o+="\\"+a}else if(t===e)if(a=this.nextChar(!0),a===e)o+=t;else return this.rewind(),o+=t,new Token(this,e==="`"?Token.TYPE_TEMPLATE:Token.TYPE_STRING,o.substring(1,o.length-1));else{if(e==='"""'&&t==='"'){if(n+=1,n===3)return new Token(this,Token.TYPE_STRING,o.substring(1,o.length-2))}else n=0;o+=t}}}error(o){throw new Error(o)}},import_diagnostics=q("@l8b/diagnostics"),LootiScriptError=class extends Error{static{b(this,"LootiScriptError")}static{__name(this,"LootiScriptError")}file;line;column;stackTrace;constructor(o,e,t,n,a){super(o),this.file=e,this.line=t,this.column=n,this.stackTrace=a,this.name="LootiScriptError"}toString(){let o=`${this.name}: ${this.message}
`;return o+=`  at ${this.file}:${this.line}:${this.column}
`,o}},LootiSyntaxError=class extends LootiScriptError{static{b(this,"LootiSyntaxError")}static{__name(this,"LootiSyntaxError")}context;code;suggestions;related;constructor(o,e,t,n,a,l,h,m){super(o,e,t,n),this.context=a,this.code=l,this.suggestions=h,this.related=m,this.name="SyntaxError"}toString(){let o="";return this.code&&(o+=`[${this.code}] `),o+=`${this.name}: ${this.message}
`,o+=`  at ${this.file}:${this.line}:${this.column}
`,this.context&&(o+=`
${this.context}
`),o}};function formatSourceContext(o,e,t,n=3,a=1){let l=o.split(`
`),h=Math.max(0,e-n-1),m=Math.min(l.length-1,e+n-1),E=`
Source context:
`;for(let O=h;O<=m;O++){let g=O+1,R=g===e?">":" ",x=String(g).padStart(4," "),T=l[O]||"";if(E+=`${R} ${x} | ${T}
`,g===e){let d=" ".repeat(8+Math.max(0,t-1))+"^".repeat(Math.max(1,a));E+=`${d}
`}}return E}b(formatSourceContext,"formatSourceContext");__name(formatSourceContext,"formatSourceContext");var Parser=class ne{static{b(this,"_Parser")}static{__name(this,"Parser")}input;filename;tokenizer;program;current_block;current;verbose;nesting;object_nesting;not_terminated;function_stack;api_reserved;warnings;unexpected_eof;error_info;last_function_call;static multipliers={millisecond:1,milliseconds:1,second:1e3,seconds:1e3,minute:6e4,minutes:6e4,hour:6e4*60,hours:6e4*60,day:6e4*60*24,days:6e4*60*24};constructor(e,t=""){this.input=e,this.filename=t,/^\s*\/\/\s*javascript\s*\n/.test(this.input)&&(this.input=`system.javascript("""

`+this.input.replace(/\\/g,"\\\\")+`

""")`),this.tokenizer=new Tokenizer(this.input,this.filename),this.program=new Program,this.current_block=[],this.current={line:1,column:1,tokenizer:this.tokenizer,type:0,value:"",start:0,length:0,index:0,is_binary_operator:!1},this.verbose=!1,this.nesting=0,this.object_nesting=0,this.not_terminated=[],this.function_stack=[],this.api_reserved={screen:!0,audio:!0,keyboard:!0,gamepad:!0,sprites:!0,sounds:!0,music:!0,assets:!0,asset_manager:!0,maps:!0,touch:!0,mouse:!0,fonts:!0,Sound:!0,Image:!0,Sprite:!0,Map:!0,system:!0,storage:!0,print:!0,random:!0,Function:!0,List:!0,Object:!0,String:!0,Number:!0,scenes:!0,scene:!0,route:!0,router:!0},this.warnings=[]}nextToken(){let e=this.tokenizer.next();if(e==null)throw this.unexpected_eof=!0,"Unexpected end of file";return this.current=e}nextTokenOptional(){let e=this.tokenizer.next();return e!=null&&(this.current=e),e}parse(){let e,t,n,a;try{for(this.warnings=[];;){if(t=this.parseLine(),t==null&&!this.tokenizer.finished())if(a=this.tokenizer.next(),a!=null&&a.reserved_keyword)if(a.value==="end"){let l=formatSourceContext(this.input,a.line,a.column,3,3),h=["Remove this extra 'end' statement","Check if you're missing an opening statement (if, for, while, function)","Verify all blocks are properly matched"];return this.error_info={error:"Too many 'end' statements - no matching opening statement found",line:a.line,column:a.column,context:l,code:import_diagnostics.SyntaxErrorCode.E1002,suggestions:h}}else this.error(`Misuse of reserved keyword: '${a.value}'`);else this.error("Unexpected data");if(t===null)break;this.current_block.push(t),this.program.add(t),this.verbose&&console.info(t)}return this}catch(l){if(e=l,e instanceof LootiSyntaxError)return this.error_info={error:e.message,line:e.line,column:e.column,context:e.context};if(this.not_terminated.length>0&&e==="Unexpected end of file"){n=this.not_terminated[this.not_terminated.length-1];let h=null,m=null,E=null;if(n.value==="function")for(let D=this.function_stack.length-1;D>=0;D--){let d=this.function_stack[D];if(d.token===n){h=d.name,m=d.line,E=d.column;break}}let O=typeof n.value=="string"?n.value.length:1,g=formatSourceContext(n.tokenizer.input,n.line,n.column,3,O),R,x=[],T;return n.value==="function"&&h?(R=`Function '${h}' started at line ${m} is not closed`,x=[`Add 'end' after the last statement to close function '${h}'`,"Check if you have an extra 'end' statement somewhere","Verify all nested blocks (if, for, while) are properly closed"],T={file:this.filename,line:m,column:E,message:`Function '${h}' started here`}):(R=`Unterminated '${n.value}' ; no matching 'end' found`,x=[`Add 'end' to close the '${n.value}' statement`,"Check if you have nested blocks that need to be closed first"]),this.error_info={error:R,line:n.line,column:n.column,context:g,code:import_diagnostics.SyntaxErrorCode.E1001,suggestions:x,related:T}}else{let h=formatSourceContext(this.input,this.current.line,this.current.column,3,1);return this.error_info={error:typeof e=="string"?e:e.message||String(e),line:this.current.line,column:this.current.column,context:h,code:import_diagnostics.SyntaxErrorCode.E1004}}}}parseLine(){let e=this.nextTokenOptional();if(e==null)return null;switch(e.type){case Token.TYPE_RETURN:return new Return(e,this.parseExpression());case Token.TYPE_BREAK:return new Break(e);case Token.TYPE_CONTINUE:return new Continue(e);case Token.TYPE_LOCAL:return this.parseLocalAssignment(e);default:return this.tokenizer.pushBack(e),this.parseExpression()}}parseExpression(e,t=!1){let n,a;if(a=this.parseExpressionStart(),a==null)return null;for(;;){if(n=this.parseExpressionSuffix(a,e),n==null)return a;if(t&&n instanceof FunctionCall)return n;a=n}}assertExpression(e,t=!1){let n=this.parseExpression(e,t);if(n==null)throw"Expression expected";return n}parseExpressionSuffix(e,t){let n,a,l=this.nextTokenOptional();if(l==null)return t==="self"?e:null;switch(l.type){case Token.TYPE_DOT:return e instanceof Value&&e.type===Value.TYPE_NUMBER?(this.tokenizer.pushBack(l),null):(this.tokenizer.changeNumberToIdentifier(),a=this.assertBroadIdentifier("Expected identifier"),Program.CreateFieldAccess(l,e,new Value(a,Value.TYPE_STRING,a.value)));case Token.TYPE_OPEN_BRACKET:return n=this.assertExpression(),this.assert(Token.TYPE_CLOSED_BRACKET,"Expected ']'"),Program.CreateFieldAccess(l,e,n);case Token.TYPE_OPEN_BRACE:return this.parseFunctionCall(l,e);case Token.TYPE_EQUALS:return this.parseAssignment(l,e);case Token.TYPE_PLUS_EQUALS:return this.parseSelfAssignment(l,e,l.type);case Token.TYPE_MINUS_EQUALS:return this.parseSelfAssignment(l,e,l.type);case Token.TYPE_MULTIPLY_EQUALS:return this.parseSelfAssignment(l,e,l.type);case Token.TYPE_DIVIDE_EQUALS:return this.parseSelfAssignment(l,e,l.type);case Token.TYPE_MODULO_EQUALS:case Token.TYPE_AND_EQUALS:case Token.TYPE_OR_EQUALS:return this.parseSelfAssignment(l,e,l.type);default:return t==="self"?(this.tokenizer.pushBack(l),e):l.is_binary_operator&&t!=="noop"?this.parseBinaryOperation(l,e):(this.tokenizer.pushBack(l),null)}}parseExpressionStart(){let e,t=this.nextTokenOptional();if(t==null)return null;switch(t.type){case Token.TYPE_IDENTIFIER:return new Variable(t,t.value);case Token.TYPE_NUMBER:return this.parseNumberExpression(t);case Token.TYPE_PLUS:return this.assertExpression();case Token.TYPE_MINUS:return this.parseExpressionSuffix(new Negate(t,this.assertExpression("noop")),"self");case Token.TYPE_NOT:return this.parseExpressionSuffix(new Not(t,this.assertExpression("noop")),"self");case Token.TYPE_STRING:return this.parseStringExpression(t);case Token.TYPE_TEMPLATE:return this.parseTemplate(t);case Token.TYPE_IF:return this.parseIf(t);case Token.TYPE_FOR:return this.parseFor(t);case Token.TYPE_WHILE:return this.parseWhile(t);case Token.TYPE_OPEN_BRACE:return this.parseBracedExpression(t);case Token.TYPE_OPEN_BRACKET:return this.parseArray(t);case Token.TYPE_FUNCTION:return this.parseFunction(t);case Token.TYPE_OBJECT:return this.parseObject(t);case Token.TYPE_CLASS:return this.parseClass(t);case Token.TYPE_NEW:return this.parseNew(t);case Token.TYPE_DOT:if(e=this.assert(Token.TYPE_NUMBER,"malformed number"),!Number.isInteger(e.value))throw"malformed number";return new Value(t,Value.TYPE_NUMBER,Number.parseFloat(`.${e.string_value}`));case Token.TYPE_AFTER:return this.parseAfter(t);case Token.TYPE_EVERY:return this.parseEvery(t);case Token.TYPE_DO:return this.parseDo(t);case Token.TYPE_SLEEP:return this.parseSleep(t);case Token.TYPE_DELETE:return this.parseDelete(t);default:return this.tokenizer.pushBack(t),null}}parseNumberExpression(e){return new Value(e,Value.TYPE_NUMBER,e.value)}parseStringExpression(e){let t=this.nextTokenOptional();return t!=null&&this.tokenizer.pushBack(t),new Value(e,Value.TYPE_STRING,e.value)}parseArray(e){let t=[];for(;;){let n=this.nextToken();if(n.type===Token.TYPE_CLOSED_BRACKET)return new Value(e,Value.TYPE_ARRAY,t);n.type===Token.TYPE_COMMA||(this.tokenizer.pushBack(n),t.push(this.assertExpression()))}}parseBinaryOperation(e,t){let n=[{token:e,operation:e.value}],a=[t];for(a.push(this.assertExpression("noop"));;){let l=this.nextTokenOptional();if(l==null)break;if(!l.is_binary_operator){this.tokenizer.pushBack(l);break}n.push({token:l,operation:l.value}),a.push(this.assertExpression("noop"))}return Program.BuildOperations(n,a)}parseAssignment(e,t){let n;if(!(t instanceof Variable||t instanceof Field))throw"Expected variable identifier or property";this.object_nesting===0&&t instanceof Variable&&this.api_reserved[t.identifier]&&this.warnings.push({type:"assigning_api_variable",identifier:t.identifier,line:e.line,column:e.column});let a=this.tokenizer.peek(),l=null;t instanceof Variable&&(l=t.identifier),a&&(a.type,Token.TYPE_FUNCTION);let h=this.assertExpression();if(h instanceof Function&&l&&this.function_stack.length>0){let m=h.token;for(let E=this.function_stack.length-1;E>=0;E--){let O=this.function_stack[E];if(O.token===m&&O.name==="anonymous"){O.name=l;break}}}return t instanceof Field?(this.object_nesting+=1,n=new Assignment(e,t,h,!1),this.object_nesting-=1):n=new Assignment(e,t,h,!1),n}parseSelfAssignment(e,t,n){if(!(t instanceof Variable||t instanceof Field))throw"Expected variable identifier or property";let a;return n===Token.TYPE_PLUS_EQUALS?a="+=":n===Token.TYPE_MINUS_EQUALS?a="-=":n===Token.TYPE_MULTIPLY_EQUALS?a="*=":n===Token.TYPE_DIVIDE_EQUALS?a="/=":n===Token.TYPE_MODULO_EQUALS?a="%=":n===Token.TYPE_AND_EQUALS?a="&=":n===Token.TYPE_OR_EQUALS?a="|=":a=String(n),new SelfAssignment(e,t,a,this.assertExpression())}parseLocalAssignment(e){let t=this.assert(Token.TYPE_IDENTIFIER,"Expected identifier");return this.parseOptionalType(),this.assert(Token.TYPE_EQUALS,"Expected '='"),new Assignment(e,new Variable(t,t.value),this.assertExpression(),!0)}parseBracedExpression(e){if(this.current.type===Token.TYPE_CLOSED_BRACE){let a=this.nextToken(),l=this.nextToken();return l.type===Token.TYPE_ARROW?this.parseArrowFunction(l,[]):(this.tokenizer.pushBack(l),this.current=a,this.error("Unexpected ')'"))}let t=this.assertExpression();this.parseOptionalType();let n=this.nextToken();if(n.type===Token.TYPE_CLOSED_BRACE){let a=this.nextToken();return a.type===Token.TYPE_ARROW?this.parseArrowFunction(a,[t]):(this.tokenizer.pushBack(a),this.current=n,new Braced(e,t))}else if(n.type===Token.TYPE_COMMA){let a=[t];for(;;){a.push(this.assertExpression()),this.parseOptionalType();let h=this.nextToken();if(h.type===Token.TYPE_CLOSED_BRACE)break;if(h.type!==Token.TYPE_COMMA)return this.error("Expected ',' or ')'")}let l=this.nextToken();return l.type===Token.TYPE_ARROW?this.parseArrowFunction(l,a):this.error("Expected '=>' after parameter list")}else return this.error("missing closing parenthese")}parseArrowFunction(e,t){let n=[];for(let h of t)if(h instanceof Variable)n.push({name:h.identifier,default:void 0});else throw this.error("Invalid argument in arrow function");let a=[],l=this.parseLine();return l&&(l instanceof Value||l instanceof Variable||l instanceof Operation||l instanceof FunctionCall||l instanceof Assignment||l instanceof Braced?a.push(new Return(e,l)):a.push(l)),new Function(e,n,a,e)}parseFunctionCall(e,t){let n=[];for(this.last_function_call=new FunctionCall(e,t,n);;){let a=this.nextTokenOptional();if(a==null)return this.error("missing closing parenthese");if(a.type===Token.TYPE_CLOSED_BRACE)return new FunctionCall(a,t,n);a.type===Token.TYPE_COMMA||(this.tokenizer.pushBack(a),n.push(this.assertExpression()))}}addTerminable(e){return this.not_terminated.push(e)}endTerminable(){this.not_terminated.length>0&&this.not_terminated.splice(this.not_terminated.length-1,1)}parseFunction(e){let t,n=this.parseFunctionArgs(),a=[];this.nesting+=1;let l={name:"anonymous",line:e.line,column:e.column,token:e};this.function_stack.push(l),this.addTerminable(e);try{for(;;){let h=this.nextToken();if(h.type===Token.TYPE_END)return this.nesting-=1,this.endTerminable(),this.function_stack.pop(),new Function(e,n,a,h);this.tokenizer.pushBack(h),t=this.parseLine(),t!=null?a.push(t):this.error("Unexpected data while parsing function")}}catch(h){throw this.function_stack.length>0&&this.function_stack[this.function_stack.length-1].token===e&&this.function_stack.pop(),h}}parseFunctionArgs(){let e=[],t=null,n=this.nextToken();if(n.type!==Token.TYPE_OPEN_BRACE)return this.error("Expected opening parenthese");for(;;){if(n=this.nextToken(),n.type===Token.TYPE_CLOSED_BRACE)return e;if(n.type===Token.TYPE_COMMA)t=null;else if(n.type===Token.TYPE_EQUALS&&t==="argument"){let a=this.assertExpression();e.length>0&&(e[e.length-1].default=a)}else if(n.type===Token.TYPE_IDENTIFIER)t="argument",e.push({name:n.value}),this.parseOptionalType();else return this.error("Unexpected token")}}warningAssignmentCondition(e){e instanceof Assignment&&this.warnings.push({type:"assignment_as_condition",line:e.token.line,column:e.token.column})}parseIf(e){let t,n,a=[],l={condition:this.assertExpression(),sequence:[]};if(this.addTerminable(e),this.warningAssignmentCondition(l.condition),n=this.nextToken(),n.type!==Token.TYPE_THEN)return this.error("Expected 'then'");for(;;)if(n=this.nextToken(),n.type===Token.TYPE_ELSIF)a.push(l),l={condition:this.assertExpression(),sequence:[]},this.warningAssignmentCondition(l.condition),this.assert(Token.TYPE_THEN,"Expected 'then'");else if(n.type===Token.TYPE_ELSE)l.else=[];else{if(n.type===Token.TYPE_END)return a.push(l),this.endTerminable(),new Condition(e,a);{this.tokenizer.pushBack(n);let h=this.parseLine();if(h==null)throw Error("Unexpected data while parsing if");t=h,l.else!=null?l.else.push(t):l.sequence.push(t)}}}assert(e,t){let n=this.nextToken();if(n.type!==e)throw t;return n}assertBroadIdentifier(e){let t=this.nextToken();if(t.type!==Token.TYPE_IDENTIFIER&&t.reserved_keyword&&(t.type=Token.TYPE_IDENTIFIER),t.type!==Token.TYPE_IDENTIFIER)throw e;return t}error(e){let t=this.current,n=formatSourceContext(t.tokenizer.input,t.line,t.column,2);throw new LootiSyntaxError(e,t.tokenizer.filename,t.line,t.column,n)}parseOptionalType(){let e=this.nextTokenOptional();if(e!=null)if(e.type===Token.TYPE_COLON)for(this.assert(Token.TYPE_IDENTIFIER,"Expected type identifier");;)if(e=this.nextTokenOptional(),e&&e.type===Token.TYPE_OPEN_BRACKET)this.assert(Token.TYPE_CLOSED_BRACKET,"Expected ']'");else{e&&this.tokenizer.pushBack(e);break}else this.tokenizer.pushBack(e)}parseFor(e){let t,n,a,l,h,m=this.assertExpression();if(m instanceof Assignment){a=m.expression;let E=m.field;return h=this.nextToken(),h.type!==Token.TYPE_TO?this.error("Expected 'to'"):(l=this.assertExpression(),h=this.nextToken(),h.type===Token.TYPE_BY?n=this.assertExpression():(n=null,this.tokenizer.pushBack(h)),E instanceof Variable?new For(e,E.identifier,a,l,n,this.parseSequence(e)):this.error("Malformed for loop"))}else return m instanceof Variable?(this.assert(Token.TYPE_IN,"Error expected keyword 'in'"),t=this.assertExpression(),new ForIn(e,m.identifier,t,this.parseSequence(e))):this.error("Malformed for loop")}parseWhile(e){let t=this.assertExpression();return new While(e,t,this.parseSequence(e))}parseSequence(e){let t,n=[];for(e!=null&&this.addTerminable(e),this.nesting+=1;;){let a=this.nextToken();if(a.type===Token.TYPE_END)return e!=null&&this.endTerminable(),this.nesting-=1,n;if(this.tokenizer.pushBack(a),t=this.parseLine(),t==null)throw this.error("Unexpected data");n.push(t)}}parseObject(e){let t,n=[];for(this.nesting+=1,this.object_nesting+=1,this.addTerminable(e);;){let a=this.nextToken();if(a.type===Token.TYPE_END)return this.nesting-=1,this.object_nesting-=1,this.endTerminable(),new CreateObject(e,n);if(a.type!==Token.TYPE_IDENTIFIER&&a.reserved_keyword&&(a.type=Token.TYPE_IDENTIFIER),a.type===Token.TYPE_STRING&&(a.type=Token.TYPE_IDENTIFIER),a.type===Token.TYPE_IDENTIFIER)this.assert(Token.TYPE_EQUALS,"Expected '='"),t=this.assertExpression(),n.push({field:a.value,value:t});else return this.error("Malformed object")}}parseClass(e){let t,n=null,a=[];this.nesting+=1,this.object_nesting+=1,this.addTerminable(e);let l=this.nextToken();for(l.type===Token.TYPE_EXTENDS&&(n=this.assertExpression(),l=this.nextToken());;){if(l.type===Token.TYPE_END)return this.nesting-=1,this.object_nesting-=1,this.endTerminable(),new CreateClass(e,n,a);if(l.type!==Token.TYPE_IDENTIFIER&&l.reserved_keyword&&(l.type=Token.TYPE_IDENTIFIER),l.type===Token.TYPE_STRING&&(l.type=Token.TYPE_IDENTIFIER),l.type===Token.TYPE_IDENTIFIER)this.assert(Token.TYPE_EQUALS,"Expected '='"),t=this.assertExpression(),a.push({field:l.value,value:t});else return this.error("Malformed object");l=this.nextToken()}}parseNew(e){let t=this.assertExpression(null,!0);return new NewCall(e,t)}parseAfter(e){let t,n=null,a=[];this.nesting+=1,this.addTerminable(e);let l=this.assertExpression(),h=this.nextToken();if(h.type===Token.TYPE_IDENTIFIER&&ne.multipliers[h.value]&&(n=ne.multipliers[h.value],h=this.nextToken()),h==null||h.type!==Token.TYPE_DO)return this.error("Expected keyword 'do'");for(;;){if(h=this.nextToken(),h.type===Token.TYPE_END)return this.nesting-=1,this.endTerminable(),new After(e,l,a,h,n);this.tokenizer.pushBack(h),t=this.parseLine(),t!=null?a.push(t):this.error("Unexpected data while parsing after")}}parseEvery(e){let t,n=null,a=[];this.nesting+=1,this.addTerminable(e);let l=this.assertExpression(),h=this.nextToken();if(h.type===Token.TYPE_IDENTIFIER&&ne.multipliers[h.value]&&(n=ne.multipliers[h.value],h=this.nextToken()),h==null||h.type!==Token.TYPE_DO)return this.error("Expected keyword 'do'");for(;;){if(h=this.nextToken(),h.type===Token.TYPE_END)return this.nesting-=1,this.endTerminable(),new Every(e,l,a,h,n);this.tokenizer.pushBack(h),t=this.parseLine(),t!=null?a.push(t):this.error("Unexpected data while parsing after")}}parseDo(e){let t,n=[];for(this.nesting+=1,this.addTerminable(e);;){let a=this.nextToken();if(a.type===Token.TYPE_END)return this.nesting-=1,this.endTerminable(),new Do(e,n,a);this.tokenizer.pushBack(a),t=this.parseLine(),t!=null?n.push(t):this.error("Unexpected data while parsing after")}}parseSleep(e){let t=null,n=this.assertExpression(),a=this.nextToken();return a!=null&&(a.type===Token.TYPE_IDENTIFIER&&ne.multipliers[a.value]?t=ne.multipliers[a.value]:this.tokenizer.pushBack(a)),new Sleep(e,n,t)}parseDelete(e){let t=this.parseExpression();return t==null||!(t instanceof Variable||t instanceof Field)?this.error("expecting variable name or property access after keyword `delete`"):new Delete(e,t)}parseTemplate(e){let t=e.value,n=0,a=[];for(;n<t.length;){let h=t.indexOf("${",n);if(h===-1){n<t.length&&a.push(new Value(e,Value.TYPE_STRING,t.substring(n)));break}h>n&&a.push(new Value(e,Value.TYPE_STRING,t.substring(n,h)));let m=1,E=h+2,O=!1,g="";for(;E<t.length&&m>0;){let D=t[E];O?D===g&&t[E-1]!=="\\"&&(O=!1):D==='"'||D==="'"||D==="`"?(O=!0,g=D):D==="{"?m++:D==="}"&&m--,m>0&&E++}if(m>0)throw this.error("Unclosed template interpolation");let R=t.substring(h+2,E),T=new this.constructor(R,e.tokenizer.filename).parseExpression();T&&a.push(T),n=E+1}if(a.length===0)return new Value(e,Value.TYPE_STRING,"");let l=a[0];for(let h=1;h<a.length;h++)l=new Operation(e,"+",l,a[h]);return l}},IC_STATE={UNINITIALIZED:0,MONOMORPHIC:1,POLYMORPHIC:2,MEGAMORPHIC:3},Processor=class H{static{b(this,"_Processor")}static{__name(this,"Processor")}runner;routine;locals;stack;call_stack;call_stack_frames;log;time_limit;done;local_index;stack_index;op_index;call_stack_index;global;object;locals_offset;call_super;call_supername;metrics;profilingEnabled;static arrayPool=[];static objectPool=[];static MAX_POOL_SIZE=1e3;constructor(e){this.runner=e,this.locals=[],this.stack=[],this.call_stack=[],this.call_stack_frames=[],this.log=!1,this.time_limit=Number.POSITIVE_INFINITY,this.done=!0,this.local_index=0,this.stack_index=-1,this.op_index=0,this.call_stack_index=0,this.global=null,this.object=null,this.locals_offset=0,this.call_super=null,this.call_supername="",this.metrics={ops:0,allocations:0,cacheHits:0,cacheMisses:0},this.profilingEnabled=!1}getArray(){if(H.arrayPool.length>0){let e=H.arrayPool.pop();return e.length=0,e}return[]}recycleArray(e){H.arrayPool.length<H.MAX_POOL_SIZE&&H.arrayPool.push(e)}getObject(){return H.objectPool.length>0?H.objectPool.pop():{}}recycleObject(e){if(H.objectPool.length<H.MAX_POOL_SIZE){for(let t in e)delete e[t];H.objectPool.push(e)}}load(e){this.routine=e,this.resetState()}resetState(){this.local_index=0,this.stack_index=-1,this.op_index=0,this.call_stack_index=0,this.call_stack_frames=[],this.global=null,this.object=this.routine.object||null,this.locals_offset=0,this.call_super=null,this.call_supername="",this.done=!1}generateStackTrace(){return[...this.call_stack_frames].reverse()}formatStackTrace(){let e=this.generateStackTrace();return e.length===0?"":e.map(t=>`  at ${t.functionName} (${t.file}:${t.line}:${t.column})`).join(`
`)}resolveParentClass(e,t){if(e.class!=null&&typeof e.class=="string"){if(t[e.class]!=null&&(e.class=t[e.class],typeof e.class!="string"))return this.resolveParentClass(e.class,t)}else if(e.class!=null&&typeof e.class!="string")return this.resolveParentClass(e.class,t)}applyFunction(e){}resolvePropertyIC(e,t,n){if(e==null)return null;if(n.state===IC_STATE.MONOMORPHIC){let a=e.class||e.constructor;if(a===n.shape)return n.hits++,e[t];n.misses++,n.state=IC_STATE.POLYMORPHIC,n.shapes=[n.shape,a],n.offsets=[0,0]}else if(n.state===IC_STATE.POLYMORPHIC){let a=e.class||e.constructor;if(n.shapes&&n.shapes.length<4){for(let l=0;l<n.shapes.length;l++)if(n.shapes[l]===a)return n.hits++,e[t];n.shapes.push(a),n.misses++}else n.state=IC_STATE.MEGAMORPHIC}return n.state===IC_STATE.UNINITIALIZED&&(n.state=IC_STATE.MONOMORPHIC,n.shape=e.class||e.constructor,n.property=t,n.hits=1),e[t]}routineAsFunction(e,t){let n,a;return a=new H(this.runner),n=__name(function(){let l,h,m,E,O,g,R;for(h=Math.min(e.num_args,arguments.length),a.load(e),m=E=0,g=h-1;E<=g;m=E+=1)a.stack[++a.stack_index]=arguments[m]||0;if(a.stack[++a.stack_index]=arguments.length,e.uses_arguments){for(l=[...arguments],m=O=0,R=l.length-1;O<=R;m=O+=1)l[m]==null&&(l[m]=0);a.stack[++a.stack_index]=l}return a.run(t)},"f"),n}routineAsApplicableFunction(e,t){let n,a;return a=new H(this.runner),n=__name(function(){let l,h,m,E,O,g,R;for(h=e.num_args,a.load(e),a.object=this,m=E=0,g=h-1;E<=g;m=E+=1)a.stack[++a.stack_index]=arguments[m]||0;if(a.stack[++a.stack_index]=arguments.length,e.uses_arguments){for(l=[...arguments],m=O=0,R=l.length-1;O<=R;m=O+=1)l[m]==null&&(l[m]=0);a.stack[++a.stack_index]=l}return a.run(t),a.stack[0]},"f"),n}argToNative(e,t){return e instanceof Routine?this.routineAsFunction(e,t):e??0}modulo(e,t,n){let a,l;if(Array.isArray(t))l=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t%=n,isFinite(t)?t:0;l=e.global.String}else l=t;for(a=l["%"];a==null&&l.class!=null;)l=l.class,a=l["%"];return a==null&&(a=e.global.Object["%"]),a!=null&&a instanceof Routine?(a.as_function==null&&(a.as_function=this.routineAsApplicableFunction(a,e)),a=a.as_function,a.call(e.global,t,n)):0}add(e,t,n,a){let l,h;for(Array.isArray(t)?h=e.global.List:typeof t=="string"?h=e.global.String:h=t,l=h["+"];l==null&&h.class!=null;)h=h.class,l=h["+"];if(l==null&&(l=e.global.Object["+"]),l!=null){if(l instanceof Routine)return l.as_function==null&&(l.as_function=this.routineAsApplicableFunction(l,e)),l=l.as_function,l.call(e.global,t,n,a);if(typeof l=="function")return l.call(e.global,t,n,a)}else return 0}sub(e,t,n,a){let l,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t-=n,isFinite(t)?t:0;h=e.global.String}else h=t;for(l=h["-"];l==null&&h.class!=null;)h=h.class,l=h["-"];if(l==null&&(l=e.global.Object["-"]),l!=null){if(l instanceof Routine)return l.as_function==null&&(l.as_function=this.routineAsApplicableFunction(l,e)),l=l.as_function,l.call(e.global,t,n,a);if(typeof l=="function")return l.call(e.global,t,n,a)}else return 0}negate(e,t){let n,a;if(Array.isArray(t))a=e.global.List;else if(typeof t=="string"){if(isFinite(t))return-t;a=e.global.String}else a=t;for(n=a["-"];n==null&&a.class!=null;)a=a.class,n=a["-"];if(n==null&&(n=e.global.Object["-"]),n!=null){if(n instanceof Routine)return n.as_function==null&&(n.as_function=this.routineAsApplicableFunction(n,e)),n=n.as_function,n.call(e.global,0,t);if(typeof n=="function")return n.call(e.global,0,t)}else return 0}mul(e,t,n,a){let l,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t*=n,isFinite(t)?t:0;h=e.global.String}else h=t;for(l=h["*"];l==null&&h.class!=null;)h=h.class,l=h["*"];if(l==null&&(l=e.global.Object["*"]),l!=null){if(l instanceof Routine)return l.as_function==null&&(l.as_function=this.routineAsApplicableFunction(l,e)),l=l.as_function,l.call(e.global,t,n,a);if(typeof l=="function")return l.call(e.global,t,n,a)}else return 0}div(e,t,n,a){let l,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t/=n,isFinite(t)?t:0;h=e.global.String}else h=t;for(l=h["/"];l==null&&h.class!=null;)h=h.class,l=h["/"];if(l==null&&(l=e.global.Object["/"]),l!=null){if(l instanceof Routine)return l.as_function==null&&(l.as_function=this.routineAsApplicableFunction(l,e)),l=l.as_function,l.call(e.global,t,n,a);if(typeof l=="function")return l.call(e.global,t,n,a)}else return 0}band(e,t,n,a){let l,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t&=n,isFinite(t)?t:0;h=e.global.String}else h=t;for(l=h["&"];l==null&&h.class!=null;)h=h.class,l=h["&"];if(l==null&&(l=e.global.Object["&"]),l!=null){if(l instanceof Routine)return l.as_function==null&&(l.as_function=this.routineAsApplicableFunction(l,e)),l=l.as_function,l.call(e.global,t,n,a);if(typeof l=="function")return l.call(e.global,t,n,a)}else return 0}bor(e,t,n,a){let l,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t|=n,isFinite(t)?t:0;h=e.global.String}else h=t;for(l=h["|"];l==null&&h.class!=null;)h=h.class,l=h["|"];if(l==null&&(l=e.global.Object["|"]),l!=null){if(l instanceof Routine)return l.as_function==null&&(l.as_function=this.routineAsApplicableFunction(l,e)),l=l.as_function,l.call(e.global,t,n,a);if(typeof l=="function")return l.call(e.global,t,n,a)}else return 0}run(e){let t,n,a,l,h,m,E,O,g,R,x,T,D,d,U,$,Y,C,J,re,I,ge,Te,W,V,Oe,Pe,ke,ce,Be,G,Ae,F,v,K,se,X,be,S,ue,L,N,Z,p,M,Le,Re,Se,pe,oe,Ve,je,ze,Je,qe,ye,ae,Ge,$e,He,ee,ie,A,Ce,Qe,xe,u,c,z,le,P,De,_,te,Ye;A=this.routine,M=this.routine.opcodes,n=this.routine.arg1,G=M.length,p=this.op_index,u=this.stack,c=this.stack_index,F=this.locals,Ae=this.local_index,Y=this.global||e.global,N=this.object||Y,E=this.call_stack,O=this.call_stack_index,g=this.call_super||Y,R=this.call_supername||"",v=this.locals_offset,Z=0,ie=-1;let fe=this.profilingEnabled;for(;p<G;)switch(fe&&this.metrics.ops++,M[p]){case 1:switch(_=u[c],typeof _){case"number":u[c]="number";break;case"string":u[c]="string";break;case"function":u[c]="function";break;case"object":Array.isArray(_)?u[c]="list":_ instanceof Routine?u[c]="function":u[c]="object"}p++;break;case 2:if(_=N[n[p]],_==null&&(_=Y[n[p]]),_==null)u[++c]=0;else switch(typeof _){case"number":u[++c]="number";break;case"string":u[++c]="string";break;case"function":u[++c]="function";break;default:Array.isArray(_)?u[++c]="list":_ instanceof Routine?u[++c]="function":u[++c]="object"}p++;break;case 3:if(_=u[c-1][u[c]],_==null)u[--c]=0;else switch(typeof _){case"number":u[--c]="number";break;case"string":u[--c]="string";break;case"function":u[--c]="function";break;default:Array.isArray(_)?u[--c]="list":_ instanceof Routine?u[--c]="function":u[--c]="object"}p++;break;case 4:u[++c]=A.import_values[n[p++]];break;case 5:u[++c]=N,p++;break;case 6:u[++c]=Y,p++;break;case 10:u[++c]=n[p++];break;case 11:u[++c]=F[v+n[p++]];break;case 12:if(S=n[p],_=N[S],_==null&&N.class!=null)for(L=N;_==null&&L.class!=null;)L=L.class,_=L[S];_==null&&(_=Y[S]),_==null&&!A.ref[p].nowarning&&(P=A.ref[p].token,I=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.using_undefined_variable[I]||(e.warnings.using_undefined_variable[I]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:S})),u[++c]=_??0,p++;break;case 13:ue=F[v+n[p]],typeof ue!="object"&&(ue=F[v+n[p]]={},P=A.ref[p].token,I=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.assigning_field_to_undefined[I]||(e.warnings.assigning_field_to_undefined[I]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:P.value})),u[++c]=ue,p++;break;case 14:for(S=n[p],L=N,_=L[S];_==null&&L.class!=null;)L=L.class,_=L[S];_==null&&Y[S]!=null&&(L=Y,_=Y[S]),(_==null||typeof _!="object")&&(_=L[S]={},P=A.ref[p].token,I=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.assigning_field_to_undefined[I]||(e.warnings.assigning_field_to_undefined[I]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:n[p]})),u[++c]=_,p++;break;case 15:c--,p++;break;case 16:L=u[c-1],S=u[c];let ve=A.ics[p];if(ve||(ve=A.ics[p]={state:IC_STATE.UNINITIALIZED,hits:0,misses:0,property:S}),_=this.resolvePropertyIC(L,S,ve),_==null&&L.class!=null){let y=L;for(;_==null&&y.class!=null;)y=y.class,_=y[S]}_==null&&(_=0,A.ref[p].nowarning||(A.ref[p].nowarning=!0,Array.isArray(L)||(P=A.ref[p].token,I=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.using_undefined_variable[I]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:S}))),u[--c]=_,p++;break;case 17:_=u[c-1][u[c]],typeof _!="object"&&(_=u[c-1][u[c]]={},P=A.ref[p].token,I=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.assigning_field_to_undefined[I]||(e.warnings.assigning_field_to_undefined[I]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:u[c]})),u[--c]=_,p++;break;case 18:fe&&this.metrics.allocations++,u[++c]=this.getObject(),p++;break;case 19:typeof u[c]!="object"&&(fe&&this.metrics.allocations++,u[c]=this.getObject()),p++;break;case 20:fe&&this.metrics.allocations++,u[++c]=this.getArray(),p++;break;case 21:F[v+n[p]]=u[c],p++;break;case 22:F[v+n[p]]=u[c--],p++;break;case 23:N[n[p++]]=u[c];break;case 24:L=u[c-2],$=u[c-1],L[$]=u[c],c-=2,p++;break;case 25:L=u[c-2],$=u[c-1],u[c-2]=L[$]=u[c],c-=2,p++;break;case 26:L=u[c-1],$=u[c],delete L[$],u[c-=1]=0,p++;break;case 27:if(S=n[p],N[S]!=null&&typeof N[S]=="object"){L=N[S],xe=u[c];for(ke in xe)te=xe[ke],L[ke]=te}else N[S]=u[c];p++;break;case 28:ee={},Re=u[c],Re?ee.class=Re:n[p]&&(ee.class=n[p]),u[c]=ee,p++;break;case 29:if(m=u[c],a=n[p],typeof m=="function"){for(t=[],C=Oe=0,Ve=a-1;Oe<=Ve;C=Oe+=1)t.push(u[c-a+C]);c-=a,u[c-1]=new m(...t),p++}else{for(this.resolveParentClass(m,Y),ee={class:m},x=m.constructor;!x&&m.class!=null;)m=m.class,x=m.constructor;if(x!=null&&x instanceof Routine){if(u[c-a-1]=ee,c--,T=E[O]||(E[O]={}),O++,T.routine=A,T.object=N,T.super=g,T.supername=R,T.op_index=p+1,v+=A.locals_size,A=x,M=x.opcodes,n=x.arg1,p=0,G=M.length,N=ee,g=m,R="constructor",A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<x.num_args)for(C=Pe=a+1,qe=x.num_args;Pe<=qe;C=Pe+=1)u[++c]=0;else a>x.num_args&&(c-=a-x.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else c-=a,u[c-1]=ee,p++}break;case 30:h=u[c--],t=u[c],typeof t=="number"?(t+=h,u[c]=isFinite(t)||typeof h=="string"?t:0):u[c]=this.add(e,t,h,n[p]),p++;break;case 31:h=u[c--],t=u[c],typeof t=="number"?(t-=h,u[c]=isFinite(t)?t:0):u[c]=this.sub(e,t,h,n[p]),p++;break;case 32:h=u[c--],t=u[c],typeof t=="number"?(t*=h,u[c]=isFinite(t)?t:0):u[c]=this.mul(e,t,h,0),p++;break;case 33:h=u[c--],t=u[c],typeof t=="number"?(t/=h,u[c]=isFinite(t)?t:0):u[c]=this.div(e,t,h,0),p++;break;case 34:h=u[c--],t=u[c],typeof t=="number"&&typeof h=="number"?(t%=h,u[c]=isFinite(t)?t:0):u[c]=this.modulo(e,t,h),p++;break;case 35:h=u[c--],t=u[c],typeof t=="number"?(t&=h,u[c]=isFinite(t)?t:0):u[c]=this.band(e,t,h,0),p++;break;case 36:h=u[c--],t=u[c],typeof t=="number"?(t|=h,u[c]=isFinite(t)?t:0):u[c]=this.bor(e,t,h,0),p++;break;case 37:_=u[c-1]<<u[c],u[--c]=isFinite(_)?_:0,p++;break;case 38:_=u[c-1]>>u[c],u[--c]=isFinite(_)?_:0,p++;break;case 39:t=u[c],typeof t=="number"?u[c]=-t:u[c]=this.negate(e,t),p++;break;case 50:u[c]=u[c]?0:1,p++;break;case 68:for(L=u[c-1],S=u[c],_=L[S];_==null&&L.class!=null;)L=L.class,_=L[S];_==null&&(_=0,A.ref[p].nowarning||(A.ref[p].nowarning=!0,Array.isArray(L)||(P=A.ref[p].token,I=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.using_undefined_variable[I]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:S}))),u[++c]=_,p++;break;case 40:u[c-1]=u[c]===u[c-1]?1:0,c--,p++;break;case 41:u[c-1]=u[c]!==u[c-1]?1:0,c--,p++;break;case 42:u[c-1]=u[c-1]<u[c]?1:0,c--,p++;break;case 43:u[c-1]=u[c-1]>u[c]?1:0,c--,p++;break;case 44:u[c-1]=u[c-1]<=u[c]?1:0,c--,p++;break;case 45:u[c-1]=u[c-1]>=u[c]?1:0,c--,p++;break;case 95:W=n[p][0],se=F[v+W+1]=u[c-1],K=u[c],V=F[v+W],u[--c]=0,K===0?(F[v+W+2]=se>V?1:-1,p++):(F[v+W+2]=K,K>0&&V>se||K<0&&V<se?p=n[p][1]:p++);break;case 96:W=n[p][0],K=F[v+W+2],se=F[v+W+1],V=F[v+W],V+=K,K>0&&V>se||K<0&&V<se?p++:(F[v+W]=V,p=n[p][1]),Z++>100&&(Z=0,Date.now()>this.time_limit&&(ie=p,p=G));break;case 97:_=u[c],u[c]=0,V=n[p][0],typeof _=="object"?Array.isArray(_)?F[v+V+1]=_:_=F[v+V+1]=Object.keys(_):typeof _=="string"?_=F[v+V+1]=_.split(""):_=F[v+V+1]=[],_.length===0?p=n[p][1]:(te=_[0],F[v+n[p][0]]=te??0,F[v+V+2]=0,p++);break;case 98:V=n[p][0],ge=F[v+V+2]+=1,_=F[v+V+1],ge<_.length?(te=_[ge],F[v+V]=te??0,p=n[p][1]):p++,Z++>100&&(Z=0,Date.now()>this.time_limit&&(ie=p,p=G));break;case 80:p=n[p],Z++>100&&(Z=0,Date.now()>this.time_limit&&(ie=p,p=G));break;case 81:u[c--]?p=n[p]:p++;break;case 82:u[c--]?p++:p=n[p];break;case 83:u[c]?p=n[p]:p++;break;case 84:u[c]?p++:p=n[p];break;case 89:for(pe=n[p++],oe=pe.clone(),ye=pe.import_refs,ce=0,Be=ye.length;ce<Be;ce++)Te=ye[ce],Te===pe.import_self?oe.import_values.push(oe):oe.import_values.push(F[v+Te]);oe.object=N,u[++c]=oe;break;case 90:if(a=n[p],d=u[c],d instanceof Routine){c--,T=E[O]||(E[O]={}),O++,T.routine=A,T.object=N,T.super=g,T.supername=R,T.op_index=p+1;let y=A.ref[p]?.token;if(y&&this.call_stack_frames.push({functionName:d.source||"[anonymous function]",file:y.tokenizer.filename,line:y.line,column:y.column}),v+=A.locals_size,A=d,M=d.opcodes,n=d.arg1,p=0,G=M.length,N=A.object!=null?A.object:Y,g=Y,R="",A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<d.num_args)for(C=X=a+1,ae=d.num_args;X<=ae;C=X+=1)u[++c]=0;else a>d.num_args&&(c-=a-d.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else if(typeof d=="function"){switch(a){case 0:try{_=d()}catch(y){D=y,console.error(D),_=0}u[c]=_??0;break;case 1:try{_=d(this.argToNative(u[c-1],e))}catch(y){D=y,console.error(D),_=0}u[c-1]=_??0,c-=1;break;default:for(l=[],c-=a,C=be=0,Ge=a-1;be<=Ge;C=be+=1)l[C]=this.argToNative(u[c+C],e);try{_=d.apply(null,l)}catch(y){D=y,console.error(D),_=0}u[c]=_??0}p++}else c-=a,u[c]=d??0,P=A.ref[p].token,I=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.invoking_non_function[I]||(U=A.ref[p],J=U.expression.token.start,re=U.token.start+U.token.length,e.warnings.invoking_non_function[I]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:U.token.tokenizer.input.substring(J,re)}),p++;break;case 91:if(S=u[c],z=L=N,d=L[S],d==null){for(;d==null&&z.class!=null;)z=z.class,d=z[S];d==null&&(d=Y.Object[S]),d==null&&(d=Y[S],z=Y,L=Y)}if(a=n[p],d instanceof Routine){if(c-=1,T=E[O]||(E[O]={}),O++,T.routine=A,T.object=N,T.super=g,T.supername=R,T.op_index=p+1,v+=A.locals_size,A=d,M=d.opcodes,n=d.arg1,p=0,G=M.length,N=L,g=z,R=S,A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<d.num_args)for(C=Le=a+1,$e=d.num_args;Le<=$e;C=Le+=1)u[++c]=0;else a>d.num_args&&(c-=a-d.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else if(typeof d=="function"){switch(a){case 0:try{_=d.call(L)}catch(y){D=y,console.error(D),_=0}u[c]=_??0;break;case 1:try{_=d.call(L,this.argToNative(u[c-1],e))}catch(y){D=y,console.error(D),_=0}u[--c]=_??0;break;default:for(l=[],c-=a,C=Se=0,He=a-1;Se<=He;C=Se+=1)l[C]=this.argToNative(u[c+C],e);try{_=d.apply(L,l)}catch(y){D=y,console.error(D),_=0}u[c]=_??0}p++}else c-=a,u[c]=d??0,P=A.ref[p].token,I=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.invoking_non_function[I]||(U=A.ref[p],J=U.expression.token.start,re=U.token.start+U.token.length,e.warnings.invoking_non_function[I]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:U.token.tokenizer.input.substring(J,re)}),p++;break;case 92:for(L=u[c-1],z=L,S=u[c],d=L[S];d==null&&z.class!=null;)z=z.class,d=z[S];if(a=n[p],d==null&&(L instanceof Routine?d=Y.Function[S]:typeof L=="string"?d=Y.String[S]:typeof L=="number"?d=Y.Number[S]:Array.isArray(L)?d=Y.List[S]:typeof L=="object"&&(d=Y.Object[S])),d instanceof Routine){if(c-=2,T=E[O]||(E[O]={}),O++,T.object=N,T.super=g,T.supername=R,T.routine=A,T.op_index=p+1,v+=A.locals_size,A=d,M=d.opcodes,n=d.arg1,p=0,G=M.length,N=L,g=z,R=S,A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<d.num_args)for(C=Ce=a+1,je=d.num_args;Ce<=je;C=Ce+=1)u[++c]=0;else a>d.num_args&&(c-=a-d.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else if(typeof d=="function"){switch(a){case 0:try{_=d.call(L)}catch(y){D=y,console.error(D),_=0}u[--c]=_??0;break;case 1:try{_=d.call(L,this.argToNative(u[c-2],e))}catch(y){D=y,console.error(D),_=0}u[c-2]=_??0,c-=2;break;default:for(l=[],c-=a+1,C=De=0,ze=a-1;De<=ze;C=De+=1)l[C]=this.argToNative(u[c+C],e);try{_=d.apply(L,l)}catch(y){D=y,console.error(D),_=0}u[c]=_??0}p++}else c-=a+1,u[c]=d??0,P=A.ref[p].token,I=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.invoking_non_function[I]||(U=A.ref[p],J=U.expression.token.start,re=U.token.start+U.token.length,e.warnings.invoking_non_function[I]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:U.token.tokenizer.input.substring(J,re)}),p++;break;case 93:if(g!=null&&R!=null){for(z=g,d=null;d==null&&z.class!=null;)z=z.class,d=z[R];if(d!=null&&d instanceof Routine){if(a=n[p],T=E[O]||(E[O]={}),O++,T.object=N,T.super=g,T.supername=R,T.routine=A,T.op_index=p+1,v+=A.locals_size,A=d,M=d.opcodes,n=d.arg1,p=0,G=M.length,g=z,A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<d.num_args)for(C=Ye=a+1,Je=d.num_args;Ye<=Je;C=Ye+=1)u[++c]=0;else a>d.num_args&&(c-=a-d.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else a=n[p],c-=a,u[++c]=0,p++}else a=n[p],c-=a,u[++c]=0,p++;break;case 94:Ae-=n[p],O<=0?p=G:(T=E[--O],N=T.object,g=T.super,R=T.supername,A=T.routine,p=T.op_index,M=A.opcodes,n=A.arg1,v-=A.locals_size,G=M.length);break;case 100:_=n[p](u[c]),u[c]=isFinite(_)?_:0,p++;break;case 101:_=n[p](u[c-1],u[c]),u[--c]=isFinite(_)?_:0,p++;break;case 110:le=this.runner.createThread(u[c-1],u[c],!1),u[--c]=le,p+=1;break;case 111:le=this.runner.createThread(u[c-1],u[c],!0),u[--c]=le,p+=1;break;case 112:le=this.runner.createThread(u[c],0,!1),u[c]=le,p+=1;break;case 113:Qe=isFinite(u[c])?u[c]:0,this.runner.sleep(Qe),p+=1,ie=p,p=G;break;case 120:if(S=n[p].name,a=n[p].args,_=N[S],_==null&&N.class!=null)for(L=N;_==null&&L.class!=null;)L=L.class,_=L[S];if(_==null&&(_=Y[S]),_==null&&!A.ref[p].nowarning&&(P=A.ref[p].token,I=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.using_undefined_variable[I]||(e.warnings.using_undefined_variable[I]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:S})),d=_??0,d instanceof Routine){T=E[O]||(E[O]={}),O++,T.routine=A,T.object=N,T.super=g,T.supername=R,T.op_index=p+1;let y=A.ref[p]?.token;if(y&&this.call_stack_frames.push({functionName:d.source||"[anonymous function]",file:y.tokenizer.filename,line:y.line,column:y.column}),v+=A.locals_size,A=d,M=d.opcodes,n=d.arg1,p=0,G=M.length,N=A.object!=null?A.object:Y,g=Y,R="",A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<d.num_args)for(C=X=a+1,ae=d.num_args;X<=ae;C=X+=1)u[++c]=0;else a>d.num_args&&(c-=a-d.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else if(typeof d=="function"){switch(a){case 0:try{_=d()}catch(y){console.error(y),_=0}u[++c]=_??0;break;case 1:try{_=d(this.argToNative(u[c],e))}catch(y){console.error(y),_=0}u[c]=_??0;break;default:for(l=[],c-=a-1,C=0;C<a;C++)l[C]=this.argToNative(u[c+C],e);try{_=d.apply(null,l)}catch(y){console.error(y),_=0}u[c]=_??0}p++}else c-=a,u[++c]=d??0,p++;break;case 121:for(a=n[p],L=u[c-1],S=u[c],_=L[S];_==null&&L.class!=null;)L=L.class,_=L[S];if(_==null&&(_=0,A.ref[p].nowarning||(A.ref[p].nowarning=!0,Array.isArray(L)||(P=A.ref[p].token,I=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.using_undefined_variable[I]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:S}))),d=_,u[--c]=d,d instanceof Routine){c--,T=E[O]||(E[O]={}),O++,T.routine=A,T.object=N,T.super=g,T.supername=R,T.op_index=p+1;let y=A.ref[p]?.token;if(y&&this.call_stack_frames.push({functionName:d.source||"[anonymous function]",file:y.tokenizer.filename,line:y.line,column:y.column}),v+=A.locals_size,A=d,M=d.opcodes,n=d.arg1,p=0,G=M.length,N=A.object!=null?A.object:Y,g=Y,R="",A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<d.num_args)for(C=X=a+1,ae=d.num_args;X<=ae;C=X+=1)u[++c]=0;else a>d.num_args&&(c-=a-d.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else if(typeof d=="function"){switch(a){case 0:try{_=d()}catch(y){console.error(y),_=0}u[c]=_??0;break;case 1:try{_=d(this.argToNative(u[c-1],e))}catch(y){console.error(y),_=0}u[c-1]=_??0,c--;break;default:for(l=[],c-=a,C=0;C<a;C++)l[C]=this.argToNative(u[c+C],e);try{_=d.apply(null,l)}catch(y){console.error(y),_=0}u[c]=_??0}p++}else c-=a,u[c]=d??0,p++;break;case 122:t=n[p],h=u[c],typeof h=="number"?(h+=t,u[c]=isFinite(h)?h:0):u[c]=this.add(e,h,t,0),p++;break;case 200:c=n[p](u,c,F,v,N,Y),p++;break;default:throw`Unsupported operation: ${M[p]}`}return ie>=0?(this.op_index=ie,this.routine=A,this.stack_index=c,this.local_index=Ae,this.object=N,this.call_stack_index=O,this.call_super=g,this.call_supername=R,this.locals_offset=v,this.done=!1):(this.op_index=0,this.done=!0,this.routine.callback!=null&&(this.routine.callback(u[c]),this.routine.callback=null)),this.log&&(console.info("total operations: "+Z),console.info(`stack_index: ${c}`),console.info(`result: ${u[c]}`)),u[c]}},import_stdlib=q("@l8b/stdlib"),VMProfiler=class{static{b(this,"VMProfiler")}static{__name(this,"VMProfiler")}startTime=0;startOps=0;startAllocations=0;frameCount=0;samples=[];processor;constructor(o){this.processor=o}start(){this.startTime=performance.now(),this.startOps=this.processor.metrics?.ops||0,this.startAllocations=this.processor.metrics?.allocations||0,this.frameCount=0}stop(){let e=performance.now()-this.startTime,t=this.processor.metrics?.ops||0,n=this.processor.metrics?.allocations||0,a={ops:t-this.startOps,time:e,allocations:n-this.startAllocations,frames:this.frameCount,samples:this.samples.length,opsPerSec:(t-this.startOps)/e*1e3,avgFrameTime:e/(this.frameCount||1)};return this.samples.push(a),a}frame(){this.frameCount++}getAverageMetrics(){if(this.samples.length===0)return this.stop();let o=this.samples.reduce((e,t)=>({ops:e.ops+t.ops,time:e.time+t.time,allocations:e.allocations+t.allocations,frames:e.frames+t.frames,samples:e.samples+t.samples,opsPerSec:e.opsPerSec+t.opsPerSec,avgFrameTime:e.avgFrameTime+t.avgFrameTime}));return{ops:o.ops/this.samples.length,time:o.time/this.samples.length,allocations:o.allocations/this.samples.length,frames:o.frames/this.samples.length,samples:this.samples.length,opsPerSec:o.opsPerSec/this.samples.length,avgFrameTime:o.avgFrameTime/this.samples.length}}},Thread=class{static{b(this,"Thread")}static{__name(this,"Thread")}runner;loop;processor;paused;terminated;next_calls;interface;routine;start_time;delay;repeat;sleep_until;constructor(o){this.runner=o,this.loop=!1,this.processor=new Processor(this.runner),this.paused=!1,this.terminated=!1,this.next_calls=[],this.interface={pause:__name(()=>this.pause(),"pause"),resume:__name(()=>this.resume(),"resume"),stop:__name(()=>this.stop(),"stop"),status:"running"}}addCall(o){this.next_calls.indexOf(o)<0&&this.next_calls.push(o)}loadNext(){let o,e,t,n;return this.next_calls.length>0?(e=this.next_calls.splice(0,1)[0],e instanceof Routine?this.processor.load(e):(t=new Parser(e,""),t.parse(),n=t.program,o=new globalThis.Compiler(n),this.processor.load(o.routine),(e==="update()"||e==="serverUpdate()")&&this.runner.updateControls!=null&&this.runner.updateControls()),!0):!1}pause(){return this.interface.status==="running"?(this.interface.status="paused",this.paused=!0,1):0}resume(){return this.interface.status==="paused"?(this.interface.status="running",this.paused=!1,1):0}stop(){return this.interface.status="stopped",this.terminated=!0,1}},Runner=class{static{b(this,"Runner")}static{__name(this,"Runner")}l8bvm;initialized;system;main_thread;threads;current_thread;thread_index;fps;fps_max;cpu_load;triggers_controls_update;updateControls;profiler;constructor(o){this.l8bvm=o,this.initialized=!1,this.threads=[],this.current_thread=null,this.thread_index=0,this.fps=60,this.fps_max=60,this.cpu_load=0,this.triggers_controls_update=!1,this.profiler=new VMProfiler(null)}init(){return this.initialized=!0,this.l8bvm.context.global.system||(this.l8bvm.context.global.system={}),this.system=this.l8bvm.context.global.system,this.system.preemptive=1,this.system.threads=[],this.main_thread=new Thread(this),this.threads=[this.main_thread],this.current_thread=this.main_thread,this.thread_index=0,this.profiler=new VMProfiler(this.main_thread.processor),this.system.profiler={start:__name(()=>{this.main_thread.processor.profilingEnabled=!0,this.profiler.start()},"start"),stop:__name(()=>(this.main_thread.processor.profilingEnabled=!1,this.profiler.stop()),"stop"),getMetrics:__name(()=>this.profiler.getAverageMetrics(),"getMetrics")},this.l8bvm.context.global.print=this.l8bvm.context.meta.print,this.l8bvm.context.global.random=new Random(0),this.l8bvm.context.global.Function={bind:__name(function(o){let e;return this instanceof Routine?(e=this.clone(),e.object=o,e):this},"bind")},this.l8bvm.context.global.Math=import_stdlib.MathLib,this.l8bvm.context.global.JSON=import_stdlib.JSONLib,this.l8bvm.context.global.List=import_stdlib.ListLib,this.l8bvm.context.global.Function={bind:__name((...o)=>o[0].bind.apply(o[0],o.slice(1)),"bind")},this.l8bvm.context.global.String={...import_stdlib.StringLib,fromCharCode:__name(function(){return String.fromCharCode.apply(null,arguments)},"fromCharCode")},this.l8bvm.context.global.Number={parse:__name(function(o){let e=Number.parseFloat(o);return isFinite(e)?e:0},"parse"),toString:__name(function(){return this.toString()},"toString")},this.l8bvm.context.global.Object={"+":__name((o,e)=>o!=null?o+e:e,"+"),"-":__name((o,e)=>o-e,"-"),"*":__name((o,e)=>o*e,"*"),"/":__name((o,e)=>o/e,"/"),"%":__name((o,e)=>o%e,"%")},this.fps=60,this.fps_max=60,this.cpu_load=0,this.l8bvm.context.meta.print("LootiScript 1.0"),this.triggers_controls_update=!0}run(o,e="",t){let n,a,l,h,m,E,O,g,R=null,x;if(this.initialized||this.init(),E=new Parser(o,e),E.parse(),E.error_info!=null)throw a=E.error_info,a.type="compile",a;if(E.warnings.length>0)for(g=E.warnings,h=0,m=g.length;h<m;h++)switch(x=g[h],l=e+"-"+x.line+"-"+x.column,x.type){case"assigning_api_variable":this.l8bvm.context.warnings.assigning_api_variable[l]==null&&(this.l8bvm.context.warnings.assigning_api_variable[l]={file:e,line:x.line,column:x.column,expression:x.identifier});break;case"assignment_as_condition":this.l8bvm.context.warnings.assignment_as_condition[l]==null&&(this.l8bvm.context.warnings.assignment_as_condition[l]={file:e,line:x.line,column:x.column})}return O=E.program,n=new globalThis.Compiler(O),R=null,n.routine.callback=T=>t!=null?t(Program.toString(T)):R=T,this.main_thread.addCall(n.routine),this.tick(),R}call(o,e){let t,n;if(o==="draw"||o==="update"||o==="serverUpdate"){this.l8bvm.context.global[o]!=null&&this.main_thread.addCall(`${o}()`);return}if(this.l8bvm.context.global[o]!=null)if(e==null||!e.length)this.main_thread.addCall(`${o}()`);else{if(n=this.l8bvm.context.global[o],n instanceof Routine)return t=this.main_thread.processor.routineAsFunction(n,this.l8bvm.context),t(...e);if(typeof n=="function")return n(...e)}else return 0}toString(o){return Program.toString(o)}process(o,e){let t;return t=o.processor,t.time_limit=e,this.current_thread=o,t.run(this.l8bvm.context)}tick(){let o,e,t,n,a,l,h,m,E,O,g,R,x,T;for(this.system.fps!=null&&(this.fps=this.fps*.9+this.system.fps*.1),this.fps_max=Math.max(this.fps,this.fps_max),this.fps<59?h=10:h=Math.floor(1e3/this.fps*.8),R=Date.now(),x=R+100,T=this.system.preemptive?x:1/0,E=this.main_thread.processor,E.done||(this.main_thread.sleep_until!=null?Date.now()>=this.main_thread.sleep_until&&(delete this.main_thread.sleep_until,this.process(this.main_thread,T)):this.process(this.main_thread,T));E.done&&Date.now()<T&&this.main_thread.loadNext();)this.process(this.main_thread,T);for(x=R+h,T=this.system.preemptive?x:1/0,this.main_thread.processor.profilingEnabled&&this.profiler.frame(),m=!0;m;){for(m=!1,O=this.threads,n=0,a=O.length;n<a;n++)if(g=O[n],g!==this.main_thread){if(g.paused||g.terminated)continue;if(E=g.processor,!E.done)g.sleep_until!=null?Date.now()>=g.sleep_until&&(delete g.sleep_until,this.process(g,T),m=!0):(this.process(g,T),m=!0);else if(g.start_time!=null)if(g.repeat)for(;R>=g.start_time&&!(g.paused||g.terminated);)R>=g.start_time+150?g.start_time=R+(g.delay||0):g.start_time+=g.delay||0,E.load(g.routine),this.process(g,T),m=!0;else R>=g.start_time&&(delete g.start_time,E.load(g.routine),this.process(g,T),m=!0);else g.terminated=!0}if(Date.now()>x)break}for(e=this.threads.length-1;e>=1;e--)g=this.threads[e],g.terminated&&(this.threads.splice(e,1),t=this.system.threads.indexOf(g.interface),t>=0&&this.system.threads.splice(t,1));g=this.threads[0],o=Date.now()-R;let D=x-R;l=o/D*100,this.cpu_load=this.cpu_load*.9+l*.1,this.system.cpu_load=Math.min(100,Math.round(this.cpu_load))}createThread(o,e,t){let n,a;for(a=new Thread(this),a.routine=o,this.threads.push(a),a.start_time=Date.now()+e-1e3/this.fps,t&&(a.repeat=t,a.delay=e),this.system.threads.push(a.interface),n=0;n<o.import_values.length;n++)o.import_values[n]===o&&(o.import_values[n]=a.interface);return a.interface}sleep(o){this.current_thread!=null&&(this.current_thread.sleep_until=Date.now()+Math.max(0,o))}},Stack=class{static{b(this,"Stack")}static{__name(this,"Stack")}stack;index;touched;constructor(){this.stack=["stack[stack_index]"],this.index=0,this.touched={}}push(o){return this.stack[++this.index]=o,this.touched[this.index]=!0}pop(){let o;return this.index>=0?o=this.stack.splice(this.index,1)[0]:this.stack[this.index]!=null?o=this.stack[this.index]:o="stack[stack_index-"+this.index+"]",this.index-=1,o}get(o=0){let e;return o==null&&(o=0),e=this.index+o,e>=0?this.stack[e]:this.stack[e]!=null?this.stack[e]:"stack[stack_index-"+-e+"]"}},Transpiler2=class{static{b(this,"Transpiler2")}static{__name(this,"Transpiler")}vcount=0;stack;locals;variables;opcodeHandlers;constructor(){this.opcodeHandlers={LOAD_VALUE:this.LOAD_VALUE.bind(this),LOAD_LOCAL:this.LOAD_LOCAL.bind(this),LOAD_LOCAL_OBJECT:this.LOAD_LOCAL_OBJECT.bind(this),STORE_LOCAL:this.STORE_LOCAL.bind(this),POP:this.POP.bind(this),CREATE_PROPERTY:this.CREATE_PROPERTY.bind(this),LOAD_PROPERTY:this.LOAD_PROPERTY.bind(this),LOAD_PROPERTY_ATOP:this.LOAD_PROPERTY_ATOP.bind(this),NEW_OBJECT:this.NEW_OBJECT.bind(this),NEW_ARRAY:this.NEW_ARRAY.bind(this),MAKE_OBJECT:this.MAKE_OBJECT.bind(this),STORE_VARIABLE:this.STORE_VARIABLE.bind(this),STORE_PROPERTY:this.STORE_PROPERTY.bind(this)}}transpile(o){for(let e=0;e<o.opcodes.length;e++){let t=OPCODES[o.opcodes[e]];if(this.transpilable(t,o.arg1[e])){let n=e+1;for(;n<o.opcodes.length&&o.removeable(n)&&this.transpilable(OPCODES[o.opcodes[n]],o.arg1[n]);)n+=1;n-=1,n-e>=2&&this.transpileSegment(o,e,n)}}}transpileSegment(r,i,j){let comp,err,index,k,s;for(this.vcount=0,this.stack=new Stack,this.locals={},this.variables={},s=`f = function(stack,stack_index,locals,locals_offset,object,global) {
`,k=i;k<=j;k++){let o=OPCODES[r.opcodes[k]],e=this.opcodeHandlers[o];e?comp=e(r.arg1[k]):comp=void 0,comp&&(s+=comp+`
`)}for(index in this.stack.touched)if(this.stack.touched[index]){let o=Number(index);o<0?s+="stack[stack_index-"+Math.abs(o)+"] = "+this.stack.stack[o]+` ;
`:o>0?s+="stack[stack_index+"+index+"] = "+this.stack.stack[o]+` ;
`:s+="stack[stack_index] = "+this.stack.stack[o]+` ;
`}this.stack.index<0?s+="stack_index -= "+Math.abs(this.stack.index)+` ;
`:this.stack.index>0&&(s+="stack_index += "+this.stack.index+` ;
`),s+=`return stack_index ;
}`,console.info(s);try{eval(s)}catch(o){err=o,console.error(s),console.error(err)}r.opcodes[i]=OPCODES.COMPILED;let f=globalThis.f;for(r.arg1[i]=f,k=i+1;k<=j;k++)r.remove(i+1)}createVariable(){return"v"+this.vcount++}transpilable(o,e){return o==="LOAD_VALUE"?typeof e=="string"||typeof e=="number":this.opcodeHandlers[o]!=null}LOAD_VALUE(o){return typeof o=="string"?this.stack.push(' "'+o.replace(/"/g,'\\"')+'" '):typeof o=="number"&&this.stack.push(o+""),""}LOAD_LOCAL(o){let e=this.createVariable();return this.stack.push(e),"let "+e+" = locals[locals_offset+"+o+"] ; // LOAD_LOCAL"}LOAD_LOCAL_OBJECT(o){let e,t;return this.locals[o]!=null?(t=this.locals[o],this.stack.push(t),"if (typeof "+t+' != "object") { '+t+" = locals[locals_offset+"+o+"] = {} } ;"):(t=this.createVariable(),e="let "+t+" = locals[locals_offset+"+o+`] ;
if (typeof `+t+' != "object") { '+t+" = locals[locals_offset+"+o+"] = {} } ;",this.stack.push(t),this.locals[o]=t,e)}STORE_LOCAL(o){let e=this.stack.get();return"locals[locals_offset+"+o+"] = "+e+" ; // STORE_LOCAL"}POP(){return this.stack.pop(),""}CREATE_PROPERTY(o){let e=this.stack.get(-2)+"["+this.stack.get(-1)+"] = "+this.stack.get()+" ;";return this.stack.pop(),this.stack.pop(),e}LOAD_PROPERTY(o){let e,t;return t=this.createVariable(),e="let "+t+" = "+this.stack.get(-1)+"["+this.stack.get()+`] ; // LOAD_PROPERTY
if (`+t+" == null) { "+t+" = 0 ; }",this.stack.pop(),this.stack.pop(),this.stack.push(t),e}LOAD_PROPERTY_ATOP(o){let e,t;return t=this.createVariable(),e="let "+t+" = "+this.stack.get(-1)+"["+this.stack.get()+`] ; // LOAD_PROPERTY_ATOP
if (`+t+" == null) { "+t+" = 0 ; }",this.stack.push(t),e}NEW_OBJECT(){let o=this.createVariable();return this.stack.push(o),"let "+o+" = {} ;"}NEW_ARRAY(){let o=this.createVariable();return this.stack.push(o),"let "+o+" = [] ;"}MAKE_OBJECT(){let o,e;return e=this.createVariable(),o="let "+e+" = "+this.stack.get()+` ;
if (typeof `+e+' != "object") '+e+" = {} ; ",this.stack.pop(),this.stack.push(e),o}STORE_VARIABLE(o){return this.variables[o]!=null?this.variables[o]+' = object["'+o+'"] = '+this.stack.get()+" ; // STORE_VARIABLE":'object["'+o+'"] = '+this.stack.get()+" ; // STORE_VARIABLE"}STORE_PROPERTY(o){let e,t;return t=this.createVariable(),e="let "+t+" = "+this.stack.get(-2)+"["+this.stack.get(-1)+"] = "+this.stack.get(0)+" ; // STORE_PROPERTY",this.stack.pop(),this.stack.pop(),this.stack.pop(),this.stack.push(t),e}}});var Yt=Ke(ut()),vt=Ke(pt());var export_Routine=vt.Routine;var export_Runtime=Yt.Runtime;export{export_Routine as Routine,export_Runtime as Runtime};
