var ut=Object.create;var Ne=Object.defineProperty;var pt=Object.getOwnPropertyDescriptor;var ft=Object.getOwnPropertyNames;var _t=Object.getPrototypeOf,dt=Object.prototype.hasOwnProperty;var b=(n,e)=>Ne(n,"name",{value:e,configurable:!0}),q=(n=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(n,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):n)(function(n){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+n+'" is not supported')});var We=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var Et=(n,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of ft(e))!dt.call(n,a)&&a!==t&&Ne(n,a,{get:()=>e[a],enumerable:!(o=pt(e,a))||o.enumerable});return n};var Ke=(n,e,t)=>(t=n!=null?ut(_t(n)):{},Et(e||!n||!n.__esModule?Ne(t,"default",{value:n,enumerable:!0}):t,n));var ht=We((Nt,Fe)=>{"use strict";var Ee=Object.defineProperty,mt=Object.getOwnPropertyDescriptor,gt=Object.getOwnPropertyNames,Tt=Object.prototype.hasOwnProperty,B=b((n,e)=>Ee(n,"name",{value:e,configurable:!0}),"__name"),Ot=b((n,e)=>{for(var t in e)Ee(n,t,{get:e[t],enumerable:!0})},"__export"),Ie=b((n,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of gt(e))!Tt.call(n,a)&&a!==t&&Ee(n,a,{get:()=>e[a],enumerable:!(o=mt(e,a))||o.enumerable});return n},"__copyProps"),Ze=b((n,e,t)=>(Ie(n,e,"default"),t&&Ie(t,e,"default")),"__reExport"),Pt=b(n=>Ie(Ee({},"__esModule",{value:!0}),n),"__toCommonJS"),we={};Ot(we,{AssetLoader:()=>st,GameLoop:()=>rt,Image:()=>de.Image,InputManager:()=>nt,Map:()=>tt.Map,ObjectPool:()=>at,Runtime:()=>Xe,RuntimeOrchestrator:()=>Xe,Sound:()=>et.Sound,SourceUpdater:()=>it,Sprite:()=>de.Sprite,StorageService:()=>xt.StorageService,System:()=>ot,createSoundClass:()=>Ue});Fe.exports=Pt(we);var et=q("@l8b/audio"),tt=q("@l8b/map"),de=q("@l8b/sprites");function Ue(n){return et.Sound}b(Ue,"createSoundClass");B(Ue,"createSoundClass");var kt=q("@l8b/map"),At=q("@l8b/sprites"),st=class{static{b(this,"AssetLoader")}static{B(this,"AssetLoader")}url;resources;collections;loadingBarTime=null;constructor(n,e){this.url=n,this.resources=e,this.collections={sprites:{},maps:{},sounds:{},music:{},assets:{}}}async loadAll(){return await Promise.all([this.loadSprites(),this.loadMaps(),this.loadSounds(),this.loadMusic(),this.loadGenericAssets()]),this.collections}async loadSprites(){if(!this.resources.images)return;let n=this.resources.images.map(e=>new Promise(t=>{let o=e.file.split(".")[0].replace(/-/g,"/"),a=`${this.url}sprites/${e.file}?v=${e.version||0}`;try{let l=(0,At.loadSprite)(a,e.properties,()=>{t()});this.collections.sprites[o]=l}catch(l){console.error(`Failed to load sprite ${o}:`,l),this.collections.sprites[o]={name:o,ready:!1,frames:[],fps:e.properties?.frames||5,width:0,height:0},t()}}));await Promise.all(n)}async loadMaps(){if(!this.resources.maps)return;let n=this.resources.maps.map(e=>new Promise(t=>{let o=e.file.split(".")[0].replace(/-/g,"/"),a=`${this.url}maps/${e.file}?v=${e.version||0}`;try{let l=(0,kt.loadMap)(a,this.collections.sprites,()=>{t()});this.collections.maps[o]=l}catch(l){console.error(`Failed to load map ${o}:`,l),this.collections.maps[o]={name:o,ready:!1,width:0,height:0,block_width:16,block_height:16,data:[]},t()}}));await Promise.all(n)}async loadSounds(){if(!this.resources.sounds)return;let n=this.resources.sounds.map(async e=>{let t=e.file.split(".")[0],o=`${this.url}sounds/${e.file}?v=${e.version||0}`;try{let a=new Audio;a.src=o,await new Promise((l,h)=>{a.addEventListener("canplaythrough",()=>l(),{once:!0}),a.addEventListener("error",h,{once:!0}),a.load()}),this.collections.sounds[t]={name:t,url:o,audio:a,ready:!0}}catch(a){console.error(`Failed to load sound ${t}:`,a),this.collections.sounds[t]={name:t,url:o,ready:!1}}});await Promise.all(n)}async loadMusic(){if(!this.resources.music)return;let n=this.resources.music.map(async e=>{let t=e.file.split(".")[0],o=`${this.url}music/${e.file}?v=${e.version||0}`;try{let a=new Audio;a.src=o,a.loop=!0,await new Promise((l,h)=>{a.addEventListener("canplaythrough",()=>l(),{once:!0}),a.addEventListener("error",h,{once:!0}),a.load()}),this.collections.music[t]={name:t,url:o,audio:a,ready:!0}}catch(a){console.error(`Failed to load music ${t}:`,a),this.collections.music[t]={name:t,url:o,ready:!1}}});await Promise.all(n)}async loadGenericAssets(){if(this.resources.assets)for(let n of this.resources.assets){let e=n.file.split(".")[0].replace(/-/g,"/");this.collections.assets[e]={name:e,file:n.file,version:n.version}}}isReady(){return this.countReady()===this.countTotal()}getProgress(){let n=this.countTotal();return n===0?1:this.countReady()/n}countTotal(){let n=0;return n+=Object.keys(this.collections.sprites).length,n+=Object.keys(this.collections.maps).length,n+=Object.keys(this.collections.sounds).length,n+=Object.keys(this.collections.music).length,n}countReady(){let n=0;for(let e of Object.values(this.collections.sprites))e.ready&&n++;for(let e of Object.values(this.collections.maps))e.ready&&n++;for(let e of Object.values(this.collections.sounds))e.ready&&n++;for(let e of Object.values(this.collections.music))e.ready&&n++;return n}showLoadingBar(n){if(this.loadingBarTime&&Date.now()<this.loadingBarTime+16)return;this.loadingBarTime=Date.now();let e=this.getProgress();n.clear("#000"),n.drawRect(0,0,100,10,"#DDD"),n.fillRect(-(1-e)*48,0,e*96,6,"#DDD")}getCollections(){return this.collections}},bt=q("@l8b/audio"),Lt=q("@l8b/lootiscript"),Rt=q("@l8b/vm"),St=q("@l8b/screen"),yt=q("@l8b/time"),it=class{static{b(this,"SourceUpdater")}static{B(this,"SourceUpdater")}vm;listener;updateMemory={};previousInit=null;constructor(n,e){this.vm=n,this.listener=e}updateSource(n,e,t=!1){if(e===this.updateMemory[n])return!1;this.updateMemory[n]=e;try{if(this.vm.run(e,3e3,n),this.listener.postMessage&&this.listener.postMessage({name:"compile_success",file:n}),this.vm.error_info){let o=Object.assign({},this.vm.error_info);return o.type="init",o.file=n,this.reportError(o),!1}if(t&&this.vm.runner.getFunctionSource){let o=this.vm.runner.getFunctionSource("init");if(o&&o!==this.previousInit&&(this.previousInit=o,this.vm.call("init"),this.vm.error_info)){let a=Object.assign({},this.vm.error_info);a.type="init",this.reportError(a)}}return!0}catch(o){console.error("Parse/Runtime error:",o);let h=(this.vm.error_info?{...this.vm.error_info}:null)||{error:B(()=>{if(typeof o=="string")return o;if(o?.message)return o.message;if(typeof o?.error=="string")return o.error;if(typeof o?.error=="function")return"Parse error (function)";if(o?.error)try{return JSON.stringify(o.error)}catch{return String(o.error)}try{return JSON.stringify(o)}catch{return String(o)}},"getMessage")(),type:o?.type||"init",file:o?.file||n,line:o?.line,column:o?.column,stack:o?.stack};return h.file||(h.file=n),this.reportError(h),!1}}reportError(n){this.listener.reportError&&this.listener.reportError(n)}},_e=q("@l8b/input"),nt=class{static{b(this,"InputManager")}static{B(this,"InputManager")}keyboard;mouse;touch;gamepad;constructor(n){this.keyboard=new _e.KeyboardInput,this.mouse=new _e.MouseInput,this.touch=new _e.TouchInput(this.mouse),this.gamepad=new _e.GamepadInput,n&&this.attachCanvas(n)}attachCanvas(n){this.mouse.setCanvas(n),this.touch.setCanvas(n)}update(){this.keyboard.update(),this.mouse.update(),this.touch.update(),this.gamepad.update()}getStates(){return{keyboard:this.keyboard.state,mouse:this.mouse.state,touch:this.touch.state,gamepad:this.gamepad.status}}},rt=class{static{b(this,"GameLoop")}static{B(this,"GameLoop")}callbacks;state;stopped=!1;animationFrameId=null;constructor(n){this.callbacks=n,this.state={currentFrame:0,floatingFrame:0,dt:1e3/60,lastTime:performance.now(),fps:60,updateRate:60},this.loop=this.loop.bind(this)}start(){this.stopped=!1,this.state.lastTime=performance.now(),this.state.currentFrame=0,this.state.floatingFrame=0,this.loop()}stop(){this.stopped=!0,this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}resume(){this.stopped&&(this.stopped=!1,this.state.lastTime=performance.now(),this.loop())}loop(){if(this.stopped)return;this.animationFrameId=requestAnimationFrame(this.loop);let n=performance.now();Math.abs(n-this.state.lastTime)>160&&(this.state.lastTime=n-16);let e=n-this.state.lastTime;this.state.dt=this.state.dt*.9+e*.1,this.state.lastTime=n,this.state.fps=Math.round(1e3/this.state.dt),this.state.floatingFrame+=this.state.dt*this.state.updateRate/1e3;let t=Math.min(10,Math.round(this.state.floatingFrame-this.state.currentFrame));(t===0||t===2)&&this.state.updateRate===60&&Math.abs(this.state.fps-60)<2&&(t=1,this.state.floatingFrame=this.state.currentFrame+1);for(let o=0;o<t;o++)this.callbacks.onUpdate(),o<t-1&&this.callbacks.onTick&&this.callbacks.onTick();this.state.currentFrame+=t,this.callbacks.onDraw(),this.callbacks.onTick&&this.callbacks.onTick()}getState(){return{...this.state}}setUpdateRate(n){n>0&&Number.isFinite(n)&&(this.state.updateRate=n)}getFPS(){return this.state.fps}},ot=class{static{b(this,"System")}static{B(this,"System")}listener;systemAPI;constructor(n={}){this.listener=n,this.systemAPI={get time(){return Date.now()},fps:60,cpu_load:0,update_rate:60,get language(){return typeof navigator<"u"?navigator.language:"en"},inputs:{get keyboard(){return 1},get mouse(){return 1},get touch(){return typeof window<"u"&&"ontouchstart"in window?1:0},get gamepad(){return typeof navigator<"u"&&typeof navigator.getGamepads=="function"?1:0}},loading:0,pause:B(()=>{this.listener.codePaused&&this.listener.codePaused()},"pause"),exit:B(()=>{typeof window<"u"&&window.close()},"exit"),prompt:B((e,t)=>{if(typeof window<"u"){let o=window.prompt(e);o!==null&&t&&t(o)}},"prompt"),say:B(e=>{typeof window<"u"&&window.alert(e)},"say"),file:{dropped:0},javascript:{},threads:[],disable_autofullscreen:0,preemptive:1}}getAPI(){return this.systemAPI}setFPS(n){this.systemAPI.fps=n}setCPULoad(n){this.systemAPI.cpu_load=n}setLoading(n){this.systemAPI.loading=n}},at=class{static{b(this,"ObjectPool")}static{B(this,"ObjectPool")}pool=[];factory;reset;maxSize;constructor(n,e,t=100){this.factory=n,this.reset=e,this.maxSize=t}acquire(){return this.pool.length>0?this.pool.pop():this.factory()}release(n){this.pool.length>=this.maxSize||(this.reset(n),this.pool.push(n))}clear(){this.pool=[]}size(){return this.pool.length}getMaxSize(){return this.maxSize}setMaxSize(n){this.maxSize=n,this.pool.length>n&&(this.pool=this.pool.slice(0,n))}},Ct=q("@l8b/scene"),Xe=class{static{b(this,"RuntimeOrchestrator")}static{B(this,"RuntimeOrchestrator")}options;listener;screen;audio;input;system;sceneManager;vm=null;sprites={};maps={};sounds={};music={};assets={};assetLoader;gameLoop=null;sourceUpdater=null;timeMachine=null;lastInputDebug;lastScreenDebug;frameCount=0;DEBUG_UPDATE_FREQUENCY=10;constructor(n={}){this.options=n,this.listener=n.listener||{},this.screen=new St.Screen({runtime:this,canvas:n.canvas,width:n.width||400,height:n.height||400}),this.audio=new bt.AudioCore(this),this.input=new nt(this.screen.getCanvas()),this.system=new ot(this.listener),this.sceneManager=new Ct.SceneManager,this.assetLoader=new st(n.url||"",n.resources||{}),this.logStep("RuntimeOrchestrator constructed",{width:this.screen.width,height:this.screen.height,resources:{images:n.resources?.images?.length??0,sounds:n.resources?.sounds?.length??0,music:n.resources?.music?.length??0}})}async start(){this.logStep("startup: begin"),this.logStep("startup: loading assets"),await this.loadAssets(),this.logStep("startup: assets loaded",{sprites:Object.keys(this.sprites).length,maps:Object.keys(this.maps).length,sounds:Object.keys(this.sounds).length,music:Object.keys(this.music).length,assets:Object.keys(this.assets).length}),this.logStep("startup: waiting for asset readiness"),await this.waitForAssetsReady(),this.logStep("startup: assets ready"),this.logStep("startup: initializing VM"),this.initializeVM(),this.logStep("startup: VM ready",{sourceFiles:Object.keys(this.options.sources||{}).length}),this.logStep("startup: starting game loop"),this.startGameLoop(),this.logStep("startup: completed")}async loadAssets(){let n=await this.assetLoader.loadAll();this.sprites=n.sprites,this.maps=n.maps,this.sounds=n.sounds,this.music=n.music,this.assets=n.assets}async waitForAssetsReady(){return new Promise(n=>{let e=B(()=>{if(this.assetLoader.isReady()){this.system.setLoading(100),n();return}let t=this.assetLoader.getProgress();this.system.setLoading(Math.floor(t*100)),this.assetLoader.showLoadingBar(this.screen.getInterface()),requestAnimationFrame(e)},"checkReady");e()})}initializeVM(){this.logStep("vm: building meta/global APIs");let n={print:B(m=>{(typeof m=="object"||typeof m=="function")&&this.vm&&(m=this.vm.toString(m)),this.listener.log?this.listener.log(String(m)):console.log(m)},"print")},e=this.input.getStates(),t={screen:this.screen.getInterface(),audio:this.audio.getInterface(),keyboard:e.keyboard,mouse:e.mouse,touch:e.touch,gamepad:e.gamepad,sprites:this.sprites,maps:this.maps,sounds:this.sounds,music:this.music,assets:this.assets,system:this.system.getAPI(),scene:B((m,O)=>this.sceneManager.registerScene(m,O),"scene"),route:B((m,O)=>this.sceneManager.registerRoute(m,O),"route"),router:this.sceneManager.router.getInterface(),Image:de.Image,Sprite:de.Sprite,Map:tt.Map,Sound:Ue(this.audio),Random:Lt.Random,ObjectPool:at};this.vm=new Rt.L8BVM(n,t,this.options.namespace||"/l8b",this.options.preserveStorage||!1),this.sourceUpdater=new it(this.vm,this.listener),this.timeMachine=new yt.TimeMachine(this),this.listener.postMessage&&this.timeMachine.onStatus(m=>{this.listener.postMessage?.({name:"time_machine_status",status:m})});let o=this.options.compiledRoutines||{},a=this.options.sources||{};if(Object.keys(o).length>0){this.logStep("vm: loading compiled routines",{files:Object.keys(o)});for(let[m,O]of Object.entries(o))try{this.vm.loadRoutine(O,m)}catch(g){this.reportError({error:g.message||String(g),type:"compile",stack:g.stack,file:m}),this.logStep("vm: routine load error",{file:m,message:g?.message||String(g)})}}else if(Object.keys(a).length>0){this.logStep("vm: executing sources",{files:Object.keys(a)});for(let[m,O]of Object.entries(a))this.sourceUpdater.updateSource(m,O,!1)}else this.logStep("vm: no sources or compiled routines provided");try{this.vm.call("init"),this.logStep("vm: init() executed")}catch(m){this.reportError({error:m.message||String(m),type:"init",stack:m.stack}),this.logStep("vm: init() error",{message:m?.message||String(m)})}let l=this.sceneManager.registry.getNames();this.logStep("router: initializing",{registeredScenes:l.length,sceneNames:l}),this.sceneManager.router.init();let h=this.sceneManager.hasActiveScene()?this.sceneManager.getCurrentSceneName?.()||"unknown":null,E=this.sceneManager.router.getState();this.logStep("router: initialized",{activeScene:h||"none",path:E.path,hasActiveScene:this.sceneManager.hasActiveScene()}),this.listener.postMessage&&this.listener.postMessage({name:"started"})}startGameLoop(){this.logStep("loop: creating game loop"),this.gameLoop=new rt({onUpdate:B(()=>this.handleUpdate(),"onUpdate"),onDraw:B(()=>this.handleDraw(),"onDraw"),onTick:B(()=>this.handleTick(),"onTick")}),this.gameLoop.start(),this.logStep("loop: started")}handleUpdate(){if(this.vm){this.frameCount++,this.input.update(),this.frameCount%this.DEBUG_UPDATE_FREQUENCY===0&&(this.debugInputs(),this.debugScreen()),this.gameLoop&&this.system.setFPS(this.gameLoop.getFPS());try{if(this.sceneManager.hasActiveScene()?this.sceneManager.update():this.vm.call("update"),this.vm.error_info){let n=Object.assign({},this.vm.error_info);n.type="update",this.reportError(n)}}catch(n){this.reportError({error:n.message||String(n),type:"update",stack:n.stack})}}}debugInputs(){if(!this.options.debug?.input)return;let n=this.createInputSnapshot();n&&(this.lastInputDebug&&this.shallowEqual(n,this.lastInputDebug)||(this.lastInputDebug=n,console.debug("[@l8b/runtime][input]",n)))}debugScreen(){if(!this.options.debug?.screen)return;let n=this.screen.getCanvas(),e={width:this.screen.width,height:this.screen.height,canvasWidth:n.width,canvasHeight:n.height};this.lastScreenDebug&&e.width===this.lastScreenDebug.width&&e.height===this.lastScreenDebug.height&&e.canvasWidth===this.lastScreenDebug.canvasWidth&&e.canvasHeight===this.lastScreenDebug.canvasHeight||(this.lastScreenDebug=e,console.debug("[@l8b/runtime][screen]",{screen:{width:this.screen.width,height:this.screen.height},canvas:{width:n.width,height:n.height,clientWidth:n.clientWidth,clientHeight:n.clientHeight,style:{width:n.style.width,height:n.style.height}}}))}shallowEqual(n,e){if(n===e)return!0;if(!n||!e||typeof n!="object"||typeof e!="object")return!1;let t=Object.keys(n),o=Object.keys(e);if(t.length!==o.length)return!1;for(let a of t){let l=n[a],h=e[a];if(l!==h){if(l==null||h==null){if(l!==h)return!1;continue}if(typeof l=="object"&&typeof h=="object"){let E=Object.keys(l),m=Object.keys(h);if(E.length!==m.length)return!1;for(let O of E)if(l[O]!==h[O])return!1}else return!1}}return!0}createInputSnapshot(){let n=this.options.debug?.input;if(!n)return null;let e=this.getEnabledInputChannels(n);if(e.length===0)return null;let t=this.input.getStates(),o={};return e.includes("touch")&&(o.touch={touching:t.touch.touching,press:t.touch.press,release:t.touch.release,x:Number(t.touch.x?.toFixed?.(2)??t.touch.x),y:Number(t.touch.y?.toFixed?.(2)??t.touch.y),count:t.touch.touches?.length??0}),e.includes("mouse")&&(o.mouse={pressed:t.mouse.pressed,left:t.mouse.left,x:Number(t.mouse.x?.toFixed?.(2)??t.mouse.x),y:Number(t.mouse.y?.toFixed?.(2)??t.mouse.y),wheel:t.mouse.wheel}),e.includes("keyboard")&&(o.keyboard={UP:t.keyboard.UP,DOWN:t.keyboard.DOWN,LEFT:t.keyboard.LEFT,RIGHT:t.keyboard.RIGHT,press:t.keyboard.press,release:t.keyboard.release}),e.includes("gamepad")&&(o.gamepad={count:this.input.gamepad.count,A:t.gamepad.A,B:t.gamepad.B,UP:t.gamepad.UP,DOWN:t.gamepad.DOWN,LEFT:t.gamepad.LEFT,RIGHT:t.gamepad.RIGHT}),Object.keys(o).length===0?null:o}getEnabledInputChannels(n){if(typeof n=="boolean")return n?["keyboard","mouse","touch","gamepad"]:[];let e=[];return n.keyboard&&e.push("keyboard"),n.mouse&&e.push("mouse"),n.touch&&e.push("touch"),n.gamepad&&e.push("gamepad"),e}handleDraw(){if(this.vm){try{if(this.sceneManager.hasActiveScene()?this.sceneManager.draw():this.vm.call("draw"),this.vm.error_info){let n=Object.assign({},this.vm.error_info);n.type="draw",this.reportError(n)}}catch(n){this.reportError({error:n.message||String(n),type:"draw",stack:n.stack})}this.timeMachine&&this.timeMachine.step()}}handleTick(){this.vm?.runner&&this.vm.runner.tick?.()}updateCall(){this.handleUpdate()}drawCall(){this.handleDraw()}updateSource(n,e,t=!1){return this.sourceUpdater?this.sourceUpdater.updateSource(n,e,t):!1}handleMessage(n){n.name==="time_machine"&&this.timeMachine&&this.timeMachine.messageReceived(n)}stop(){this.logStep("lifecycle: stop requested"),this.gameLoop?.stop()}resume(){this.logStep("lifecycle: resume requested"),this.gameLoop?.resume()}getCanvas(){return this.screen.getCanvas()}runCommand(n,e){if(this.vm)try{let t=this.vm.run(n,3e3,"console");e&&e(t)}catch(t){e&&e(`Error: ${t.message||String(t)}`)}}formatError(n){if(n.code||n.context||n.suggestions)return n;let e={...n,formatted:this.formatErrorMessage(n)};return n.suggestions&&(e.suggestions=n.suggestions),n.related&&(e.related=n.related),e}formatErrorMessage(n){let e="";if(n.code&&(e+=`[${n.code}] `),e+=`${n.error||n.message||"Unknown error"}
`,n.stackTrace&&n.stackTrace.length>0){e+=`
Stack trace:
`;for(let t of n.stackTrace){let o=t.functionName||"<anonymous>",a=t.file||"<unknown>",l=t.line!==void 0?`:${t.line}`:"",h=t.column!==void 0?`:${t.column}`:"";e+=`  at ${o} (${a}${l}${h})
`}}else n.file&&(e+=`  at ${n.file}`,n.line!==void 0&&(e+=`:${n.line}`,n.column!==void 0&&(e+=`:${n.column}`)),e+=`
`);if(n.context&&(e+=`
${n.context}
`),n.suggestions&&n.suggestions.length>0){e+=`
Suggestions:
`;for(let t of n.suggestions)e+=`  \u2022 ${t}
`}return n.related&&(e+=`
Related: ${n.related.message} at ${n.related.file}:${n.related.line}:${n.related.column}
`),e}reportError(n){if(this.listener.reportError){let e=this.formatError(n);this.listener.reportError(e)}}logStep(n,e){if(!this.options.debug?.lifecycle)return;let t="[@l8b/runtime][lifecycle]";if(e!==void 0?console.info(`${t} ${n}`,e):console.info(`${t} ${n}`),this.listener.log)try{let o=e===void 0?"":` ${JSON.stringify(e)}`;this.listener.log(`${t} ${n}${o}`)}catch{this.listener.log(`${t} ${n}`)}}},xt=q("@l8b/io"),lt={};Ze(lt,q("@l8b/vm"));Ze(we,lt,Fe.exports)});var ct=We((exports,module)=>{"use strict";var __defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,__name=b((n,e)=>__defProp(n,"name",{value:e,configurable:!0}),"__name"),__export=b((n,e)=>{for(var t in e)__defProp(n,t,{get:e[t],enumerable:!0})},"__export"),__copyProps=b((n,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of __getOwnPropNames(e))!__hasOwnProp.call(n,a)&&a!==t&&__defProp(n,a,{get:()=>e[a],enumerable:!(o=__getOwnPropDesc(e,a))||o.enumerable});return n},"__copyProps"),__toCommonJS=b(n=>__copyProps(__defProp({},"__esModule",{value:!0}),n),"__toCommonJS"),index_exports={};__export(index_exports,{After:()=>After,Assignment:()=>Assignment,Braced:()=>Braced,Break:()=>Break,Compiler:()=>Compiler2,Condition:()=>Condition,Continue:()=>Continue,CreateClass:()=>CreateClass,CreateObject:()=>CreateObject,Delete:()=>Delete,Do:()=>Do,Every:()=>Every,Expression:()=>Expression,Field:()=>Field,For:()=>For,ForIn:()=>ForIn,Function:()=>Function,FunctionCall:()=>FunctionCall,LocalLayer:()=>LocalLayer,Locals:()=>Locals,Negate:()=>Negate,NewCall:()=>NewCall,Not:()=>Not,OPCODES:()=>OPCODES,Operation:()=>Operation,Parser:()=>Parser,Processor:()=>Processor,Program:()=>Program,Random:()=>Random,Return:()=>Return,Routine:()=>Routine,Runner:()=>Runner,SelfAssignment:()=>SelfAssignment,Sleep:()=>Sleep,Thread:()=>Thread,Token:()=>Token,Tokenizer:()=>Tokenizer,Transpiler:()=>Transpiler2,Value:()=>Value,Variable:()=>Variable,While:()=>While});module.exports=__toCommonJS(index_exports);var Random=class Me{static{b(this,"_Random")}static{__name(this,"Random")}_seed;a=13971;b=12345;size=1<<30;mask;norm;constructor(e,t=!0){this._seed=e??Math.random(),this._seed===0&&(this._seed=Math.random()),this._seed<1&&(this._seed*=1<<30),this.mask=this.size-1,this.norm=1/this.size,t&&(this.nextSeed(),this.nextSeed(),this.nextSeed())}next(){return this._seed=this._seed*this.a+this.b&this.mask,this._seed*this.norm}nextInt(e){return Math.floor(this.next()*e)}nextSeed(){return this._seed=this._seed*this.a+this.b&this.mask}seed(e){return this._seed=e??Math.random(),this._seed<1&&(this._seed*=1<<30),this.nextSeed(),this.nextSeed(),this.nextSeed()}clone(e){return e!=null?new Me(e):new Me(this._seed,!1)}},OPCODES_CLASS=class{static{b(this,"OPCODES_CLASS2")}static{__name(this,"OPCODES_CLASS")}table={};set(e,t){return this[e]=t,this[t]=e,this.table[e]=t,this.table[t]=e,t}TYPE=1;VARIABLE_TYPE=2;PROPERTY_TYPE=3;LOAD_IMPORT=4;LOAD_THIS=5;LOAD_GLOBAL=6;LOAD_VALUE=10;LOAD_LOCAL=11;LOAD_VARIABLE=12;LOAD_LOCAL_OBJECT=13;LOAD_VARIABLE_OBJECT=14;POP=15;LOAD_PROPERTY=16;LOAD_PROPERTY_OBJECT=17;CREATE_OBJECT=18;MAKE_OBJECT=19;CREATE_ARRAY=20;STORE_LOCAL=21;STORE_VARIABLE=23;CREATE_PROPERTY=24;STORE_PROPERTY=25;DELETE=26;UPDATE_CLASS=27;CREATE_CLASS=28;NEW_CALL=29;ADD=30;SUB=31;MUL=32;DIV=33;MODULO=34;BINARY_AND=35;BINARY_OR=36;SHIFT_LEFT=37;SHIFT_RIGHT=38;NEGATE=39;EQ=40;NEQ=41;LT=42;GT=43;LTE=44;GTE=45;NOT=50;LOAD_PROPERTY_ATOP=68;JUMP=80;JUMPY=81;JUMPN=82;JUMPY_NOPOP=83;JUMPN_NOPOP=84;LOAD_ROUTINE=89;FUNCTION_CALL=90;FUNCTION_APPLY_VARIABLE=91;FUNCTION_APPLY_PROPERTY=92;SUPER_CALL=93;RETURN=94;FORLOOP_INIT=95;FORLOOP_CONTROL=96;FORIN_INIT=97;FORIN_CONTROL=98;UNARY_OP=100;BINARY_OP=101;COMPILED=200;AFTER=110;EVERY=111;DO=112;SLEEP=113;LOAD_VAR_CALL=120;LOAD_PROP_CALL=121;LOAD_CONST_ADD=122;constructor(){this.set("TYPE",1),this.set("VARIABLE_TYPE",2),this.set("PROPERTY_TYPE",3),this.set("LOAD_IMPORT",4),this.set("LOAD_THIS",5),this.set("LOAD_GLOBAL",6),this.set("LOAD_VALUE",10),this.set("LOAD_LOCAL",11),this.set("LOAD_VARIABLE",12),this.set("LOAD_LOCAL_OBJECT",13),this.set("LOAD_VARIABLE_OBJECT",14),this.set("POP",15),this.set("LOAD_PROPERTY",16),this.set("LOAD_PROPERTY_OBJECT",17),this.set("CREATE_OBJECT",18),this.set("MAKE_OBJECT",19),this.set("CREATE_ARRAY",20),this.set("STORE_LOCAL",21),this.set("STORE_VARIABLE",23),this.set("CREATE_PROPERTY",24),this.set("STORE_PROPERTY",25),this.set("DELETE",26),this.set("UPDATE_CLASS",27),this.set("CREATE_CLASS",28),this.set("NEW_CALL",29),this.set("ADD",30),this.set("SUB",31),this.set("MUL",32),this.set("DIV",33),this.set("MODULO",34),this.set("BINARY_AND",35),this.set("BINARY_OR",36),this.set("SHIFT_LEFT",37),this.set("SHIFT_RIGHT",38),this.set("NEGATE",39),this.set("EQ",40),this.set("NEQ",41),this.set("LT",42),this.set("GT",43),this.set("LTE",44),this.set("GTE",45),this.set("NOT",50),this.set("LOAD_PROPERTY_ATOP",68),this.set("JUMP",80),this.set("JUMPY",81),this.set("JUMPN",82),this.set("JUMPY_NOPOP",83),this.set("JUMPN_NOPOP",84),this.set("LOAD_ROUTINE",89),this.set("FUNCTION_CALL",90),this.set("FUNCTION_APPLY_VARIABLE",91),this.set("FUNCTION_APPLY_PROPERTY",92),this.set("SUPER_CALL",93),this.set("RETURN",94),this.set("FORLOOP_INIT",95),this.set("FORLOOP_CONTROL",96),this.set("FORIN_INIT",97),this.set("FORIN_CONTROL",98),this.set("UNARY_OP",100),this.set("BINARY_OP",101),this.set("COMPILED",200),this.set("AFTER",110),this.set("EVERY",111),this.set("DO",112),this.set("SLEEP",113),this.set("LOAD_VAR_CALL",120),this.set("LOAD_PROP_CALL",121),this.set("LOAD_CONST_ADD",122)}},OPCODES=new OPCODES_CLASS,Routine=class me{static{b(this,"_Routine")}static{__name(this,"Routine")}num_args;ops;opcodes;arg1;ref;label_count;labels;transpile;import_refs;import_values;import_self;locals_size;uses_arguments;as_function;object;callback;ics;constructor(e=0){this.num_args=e,this.ops=[],this.opcodes=[],this.arg1=[],this.ref=[],this.label_count=0,this.labels={},this.transpile=!1,this.import_refs=[],this.import_values=[],this.import_self=-1,this.ics={}}clone(){let e=new me(this.num_args);return e.opcodes=this.opcodes,e.arg1=this.arg1,e.ref=this.ref,e.locals_size=this.locals_size,e.uses_arguments=this.uses_arguments,e}createLabel(e="label"){return":"+e+"_"+this.label_count++}setLabel(e){return this.labels[e]=this.opcodes.length}optimize(){this.transpile&&new Transpiler().transpile(this)}removeable(e){let t=this.labels;for(let o in t)if(t[o]===e)return!1;return!0}remove(e){let t=this.labels;for(let o in t){let a=t[o];if(a===e)return!1;a>e&&(this.labels[o]-=1)}return this.opcodes.splice(e,1),this.arg1.splice(e,1),this.ref.splice(e,1),!0}resolveLabels(){for(let e=0;e<this.opcodes.length;e++){let t=this.opcodes[e];if(t===OPCODES.JUMP||t===OPCODES.JUMPY||t===OPCODES.JUMPN||t===OPCODES.JUMPY_NOPOP||t===OPCODES.JUMPN_NOPOP)this.labels[this.arg1[e]]&&(this.arg1[e]=this.labels[this.arg1[e]]);else if(t===OPCODES.FORLOOP_CONTROL||t===OPCODES.FORLOOP_INIT||t===OPCODES.FORIN_CONTROL||t===OPCODES.FORIN_INIT){let o=this.arg1[e];o&&this.labels[o[1]]&&(o[1]=this.labels[o[1]])}}}OP(e,t,o=0){return this.opcodes.push(e),this.arg1.push(o),this.ref.push(t)}OP_INSERT(e,t,o=0,a){this.opcodes.splice(a,0,e),this.arg1.splice(a,0,o),this.ref.splice(a,0,t);let l=this.labels;for(let h in l)l[h]>=a&&(this.labels[h]+=1)}TYPE(e){return this.OP(OPCODES.TYPE,e)}VARIABLE_TYPE(e,t){return this.OP(OPCODES.VARIABLE_TYPE,t,e)}PROPERTY_TYPE(e){return this.OP(OPCODES.PROPERTY_TYPE,e)}LOAD_THIS(e){return this.OP(OPCODES.LOAD_THIS,e)}LOAD_GLOBAL(e){return this.OP(OPCODES.LOAD_GLOBAL,e)}LOAD_VALUE(e,t){return this.OP(OPCODES.LOAD_VALUE,t,e)}LOAD_LOCAL(e,t){return this.OP(OPCODES.LOAD_LOCAL,t,e)}LOAD_VARIABLE(e,t){return this.OP(OPCODES.LOAD_VARIABLE,t,e)}LOAD_LOCAL_OBJECT(e,t){return this.OP(OPCODES.LOAD_LOCAL_OBJECT,t,e)}LOAD_VARIABLE_OBJECT(e,t){return this.OP(OPCODES.LOAD_VARIABLE_OBJECT,t,e)}POP(e){return this.OP(OPCODES.POP,e)}LOAD_PROPERTY(e){return this.OP(OPCODES.LOAD_PROPERTY,e)}LOAD_PROPERTY_OBJECT(e){return this.OP(OPCODES.LOAD_PROPERTY_OBJECT,e)}CREATE_OBJECT(e){return this.OP(OPCODES.CREATE_OBJECT,e)}MAKE_OBJECT(e){return this.OP(OPCODES.MAKE_OBJECT,e)}CREATE_ARRAY(e){return this.OP(OPCODES.CREATE_ARRAY,e)}CREATE_CLASS(e,t){return this.OP(OPCODES.CREATE_CLASS,t,e)}UPDATE_CLASS(e,t){return this.OP(OPCODES.UPDATE_CLASS,t,e)}NEW_CALL(e,t){return this.OP(OPCODES.NEW_CALL,t,e)}ADD(e,t=0){return this.OP(OPCODES.ADD,e,t)}SUB(e,t=0){return this.OP(OPCODES.SUB,e,t)}MUL(e){return this.OP(OPCODES.MUL,e)}DIV(e){return this.OP(OPCODES.DIV,e)}MODULO(e){return this.OP(OPCODES.MODULO,e)}BINARY_AND(e){return this.OP(OPCODES.BINARY_AND,e)}BINARY_OR(e){return this.OP(OPCODES.BINARY_OR,e)}SHIFT_LEFT(e){return this.OP(OPCODES.SHIFT_LEFT,e)}SHIFT_RIGHT(e){return this.OP(OPCODES.SHIFT_RIGHT,e)}NEGATE(e){return this.OP(OPCODES.NEGATE,e)}LOAD_PROPERTY_ATOP(e){return this.OP(OPCODES.LOAD_PROPERTY_ATOP,e)}EQ(e){return this.OP(OPCODES.EQ,e)}NEQ(e){return this.OP(OPCODES.NEQ,e)}LT(e){return this.OP(OPCODES.LT,e)}GT(e){return this.OP(OPCODES.GT,e)}LTE(e){return this.OP(OPCODES.LTE,e)}GTE(e){return this.OP(OPCODES.GTE,e)}NOT(e){return this.OP(OPCODES.NOT,e)}FORLOOP_INIT(e,t){return this.OP(OPCODES.FORLOOP_INIT,t,e)}FORLOOP_CONTROL(e,t){return this.OP(OPCODES.FORLOOP_CONTROL,t,e)}FORIN_INIT(e,t){return this.OP(OPCODES.FORIN_INIT,t,e)}FORIN_CONTROL(e,t){return this.OP(OPCODES.FORIN_CONTROL,t,e)}JUMP(e,t){return this.OP(OPCODES.JUMP,t,e)}JUMPY(e,t){return this.OP(OPCODES.JUMPY,t,e)}JUMPN(e,t){return this.OP(OPCODES.JUMPN,t,e)}JUMPY_NOPOP(e,t){return this.OP(OPCODES.JUMPY_NOPOP,t,e)}JUMPN_NOPOP(e,t){return this.OP(OPCODES.JUMPN_NOPOP,t,e)}STORE_LOCAL(e,t){return this.OP(OPCODES.STORE_LOCAL,t,e)}STORE_VARIABLE(e,t){return this.OP(OPCODES.STORE_VARIABLE,t,e)}CREATE_PROPERTY(e){return this.OP(OPCODES.CREATE_PROPERTY,e)}STORE_PROPERTY(e){return this.OP(OPCODES.STORE_PROPERTY,e)}LOAD_ROUTINE(e,t){return this.OP(OPCODES.LOAD_ROUTINE,t,e)}FUNCTION_CALL(e,t){return this.OP(OPCODES.FUNCTION_CALL,t,e)}FUNCTION_APPLY_VARIABLE(e,t){return this.OP(OPCODES.FUNCTION_APPLY_VARIABLE,t,e)}FUNCTION_APPLY_PROPERTY(e,t){return this.OP(OPCODES.FUNCTION_APPLY_PROPERTY,t,e)}SUPER_CALL(e,t){return this.OP(OPCODES.SUPER_CALL,t,e)}RETURN(e){return this.OP(OPCODES.RETURN,e)}AFTER(e){return this.OP(OPCODES.AFTER,e)}EVERY(e){return this.OP(OPCODES.EVERY,e)}DO(e){return this.OP(OPCODES.DO,e)}SLEEP(e){return this.OP(OPCODES.SLEEP,e)}DELETE(e){return this.OP(OPCODES.DELETE,e)}UNARY_OP(e,t){return this.OP(OPCODES.UNARY_OP,t,e)}BINARY_OP(e,t){return this.OP(OPCODES.BINARY_OP,t,e)}toString(){let e="";for(let t=0;t<this.opcodes.length;t++){let o=this.opcodes[t];e+=OPCODES[o],this.arg1[t]!=null&&(e+=` ${this.arg1[t]}`),e+=`
`}return e}exportArg(e){return e==null?0:e instanceof me?e.export():typeof e=="function"?e.name:e}export(){let e=[];for(let t=0;t<this.arg1.length;t++)e[t]=this.exportArg(this.arg1[t]);return{num_args:this.num_args,ops:this.opcodes,args:e,import_refs:this.import_refs,import_values:this.import_values,import_self:this.import_self,locals_size:this.locals_size}}import(e){this.num_args=e.num_args,this.opcodes=e.ops,this.arg1=e.args,this.import_refs=e.import_refs,this.import_values=e.import_values,this.import_self=e.import_self,this.locals_size=e.locals_size;let t={line:0,column:0,start:0,length:0,index:0,tokenizer:{filename:"filename",input:""}},o={expression:{token:t},token:t};for(let a=0;a<this.opcodes.length;a++)this.opcodes[a]===100?this.arg1[a]=Compiler.predefined_unary_functions[this.arg1[a]]:this.opcodes[a]===101?this.arg1[a]=Compiler.predefined_binary_functions[this.arg1[a]]:typeof this.arg1[a]=="object"&&!Array.isArray(this.arg1[a])&&(this.arg1[a]=new me(0).import(this.arg1[a])),this.ref[a]=o;return this}},Expression=class{static{b(this,"Expression")}static{__name(this,"Expression")}nowarning;nopop;constructor(){}},Program=class he{static{b(this,"_Program")}static{__name(this,"Program")}statements=[];static Field;static Variable;static Assignment;constructor(){this.statements=[]}add(e){return this.statements.push(e)}isAssignment(){return this.statements.length>0&&this.statements[this.statements.length-1]instanceof Assignment}static toString(e,t=0){let o,a,l,h,E;if(e instanceof Routine)return t===0&&e.source||"[function]";if(typeof e=="function")return"[native function]";if(typeof e=="string")return`"${e}"`;if(Array.isArray(e)){if(t>=1)return"[list]";for(h="[",o=0;o<e.length;o++)E=e[o],h+=he.toString(E,t+1)+(o<e.length-1?",":"");return h+"]"}else if(typeof e=="object"&&e!==null){if(t>=1)return"[object]";for(h=`object
`,l="",o=1;o<=t;o++)l+="  ";for(a in e)E=e[a],h+=l+`  ${a} = ${he.toString(E,t+1)}
`;return h+l+"end"}return e||0}static Precedence={"^":21,"/":20,"*":19,"%":18,"+":17,"-":17,"<":16,"<=":15,">":14,">=":13,"==":12,"!=":11,"<<":10,">>":9,"&":8,"|":7,and:6,or:5};static CreateFieldAccess(e,t,o){return t instanceof Field?(t.appendField(o),t):new Field(e,t,[o])}static BuildOperations(e,t){let o,a,l,h,E,m;for(;e.length>1;){for(o=0;o<e.length-1&&(l=e[o],h=e[o+1],!(he.Precedence[h.operation]<=he.Precedence[l.operation]));)o++;E=t[o],m=t[o+1],a=new Operation(e[o].token,e[o].operation,E,m),t.splice(o,2,a),e.splice(o,1)}return new Operation(e[0].token,e[0].operation,t[0],t[1])}},Assignment=class extends Expression{static{b(this,"Assignment")}static{__name(this,"Assignment")}token;field;expression;local;constructor(n,e,t,o){super(),this.token=n,this.field=e,this.expression=t,this.local=o}},SelfAssignment=class extends Expression{static{b(this,"SelfAssignment")}static{__name(this,"SelfAssignment")}token;field;operation;expression;constructor(n,e,t,o){super(),this.token=n,this.field=e,this.operation=t,this.expression=o}},Value=class extends Expression{static{b(this,"Value")}static{__name(this,"Value")}token;type;value;static TYPE_NUMBER=1;static TYPE_STRING=2;static TYPE_ARRAY=3;static TYPE_OBJECT=4;static TYPE_FUNCTION=5;static TYPE_CLASS=6;constructor(n,e,t){super(),this.token=n,this.type=e,this.value=t}},Variable=class extends Expression{static{b(this,"Variable")}static{__name(this,"Variable")}token;identifier;constructor(n,e){super(),this.token=n,this.identifier=e}},Field=class extends Expression{static{b(this,"Field")}static{__name(this,"Field")}token;expression;chain;constructor(n,e,t){super(),this.token=n,this.expression=e,this.chain=t,this.token=e instanceof Expression?e.token:n}appendField(n){return this.chain.push(n)}},Operation=class extends Expression{static{b(this,"Operation")}static{__name(this,"Operation")}token;operation;term1;term2;constructor(n,e,t,o){super(),this.token=n,this.operation=e,this.term1=t,this.term2=o}},Negate=class extends Expression{static{b(this,"Negate")}static{__name(this,"Negate")}token;expression;constructor(n,e){super(),this.token=n,this.expression=e}},Not=class extends Expression{static{b(this,"Not")}static{__name(this,"Not")}token;expression;constructor(n,e){super(),this.token=n,this.expression=e}},Braced=class extends Expression{static{b(this,"Braced")}static{__name(this,"Braced")}token;expression;constructor(n,e){super(),this.token=n,this.expression=e}},Return=class extends Expression{static{b(this,"Return")}static{__name(this,"Return")}token;expression;constructor(n,e){super(),this.token=n,this.expression=e}},Condition=class extends Expression{static{b(this,"Condition")}static{__name(this,"Condition")}token;chain;constructor(n,e){super(),this.token=n,this.chain=e}},For=class extends Expression{static{b(this,"For")}static{__name(this,"For")}token;iterator;range_from;range_to;range_by;sequence;constructor(n,e,t,o,a,l){super(),this.token=n,this.iterator=e,this.range_from=t,this.range_to=o,this.range_by=a,this.sequence=l}},ForIn=class extends Expression{static{b(this,"ForIn")}static{__name(this,"ForIn")}token;iterator;list;sequence;constructor(n,e,t,o){super(),this.token=n,this.iterator=e,this.list=t,this.sequence=o}},While=class extends Expression{static{b(this,"While")}static{__name(this,"While")}token;condition;sequence;constructor(n,e,t){super(),this.token=n,this.condition=e,this.sequence=t}},Break=class extends Expression{static{b(this,"Break")}static{__name(this,"Break")}token;nopop=!0;constructor(n){super(),this.token=n,this.nopop=!0}},Continue=class extends Expression{static{b(this,"Continue")}static{__name(this,"Continue")}token;nopop=!0;constructor(n){super(),this.token=n,this.nopop=!0}},Function=class extends Expression{static{b(this,"Function")}static{__name(this,"Function")}token;args;sequence;source;constructor(n,e,t,o){super(),this.token=n,this.args=e,this.sequence=t,this.source="function"+n.tokenizer.input.substring(n.index,o.index+2)}},FunctionCall=class extends Expression{static{b(this,"FunctionCall")}static{__name(this,"FunctionCall")}token;expression;args;constructor(n,e,t){super(),this.token=n,this.expression=e,this.args=t}},CreateObject=class extends Expression{static{b(this,"CreateObject")}static{__name(this,"CreateObject")}token;fields;constructor(n,e){super(),this.token=n,this.fields=e}},CreateClass=class extends Expression{static{b(this,"CreateClass")}static{__name(this,"CreateClass")}token;ext;fields;constructor(n,e,t){super(),this.token=n,this.ext=e,this.fields=t}},NewCall=class extends Expression{static{b(this,"NewCall")}static{__name(this,"NewCall")}token;expression;constructor(n,e){super(),this.token=n,this.expression=e,this.expression instanceof FunctionCall||(this.expression=new FunctionCall(this.token,this.expression,[]))}},After=class extends Expression{static{b(this,"After")}static{__name(this,"After")}token;delay;sequence;multiplier;source;constructor(n,e,t,o,a){super(),this.token=n,this.delay=e,this.sequence=t,this.multiplier=a,this.source="after "+n.tokenizer.input.substring(n.index,o.index+2)}},Every=class extends Expression{static{b(this,"Every")}static{__name(this,"Every")}token;delay;sequence;multiplier;source;constructor(n,e,t,o,a){super(),this.token=n,this.delay=e,this.sequence=t,this.multiplier=a,this.source="every "+n.tokenizer.input.substring(n.index,o.index+2)}},Do=class extends Expression{static{b(this,"Do")}static{__name(this,"Do")}token;sequence;source;constructor(n,e,t){super(),this.token=n,this.sequence=e,this.source="do "+n.tokenizer.input.substring(n.index,t.index+2)}},Sleep=class extends Expression{static{b(this,"Sleep")}static{__name(this,"Sleep")}token;delay;multiplier;constructor(n,e,t){super(),this.token=n,this.delay=e,this.multiplier=t}},Delete=class extends Expression{static{b(this,"Delete")}static{__name(this,"Delete")}token;field;constructor(n,e){super(),this.token=n,this.field=e}};Program.Field=Field;Program.Variable=Variable;Program.Assignment=Assignment;var Compiler2=class Q{static{b(this,"_Compiler")}static{__name(this,"Compiler")}program;code_saves;code;routine;locals;count;break_label;continue_label;processor;constructor(e){let t,o,a,l,h;for(this.program=e,this.code_saves=[],this.code=[""],this.routine=new Routine(0),this.locals=new Locals(this),this.count=0,this.break_label=null,this.continue_label=null,l=this.program.statements,t=o=0,a=l.length;o<a&&(h=l[t],this.compile(h),t<this.program.statements.length-1&&this.routine.POP(h),!(h instanceof Return||h instanceof Break||h instanceof Continue));t=++o);this.routine.optimize(),this.routine.resolveLabels(),this.optimizeFusedOpcodes(),this.count+=this.routine.opcodes.length,this.routine.locals_size=this.locals.max_index}optimizeFusedOpcodes(){let e=this.routine.opcodes,t=this.routine.arg1,o=this.routine.ref,a=0;for(;a<e.length-1;){if(e[a]===OPCODES.LOAD_VARIABLE&&e[a+1]===OPCODES.FUNCTION_CALL){let l=t[a],h=t[a+1],E=o[a+1];e[a]=OPCODES.LOAD_VAR_CALL,t[a]={name:l,args:h},o[a]=E,e.splice(a+1,1),t.splice(a+1,1),o.splice(a+1,1);continue}if(e[a]===OPCODES.LOAD_PROPERTY&&e[a+1]===OPCODES.FUNCTION_CALL){let l=t[a+1],h=o[a+1];e[a]=OPCODES.LOAD_PROP_CALL,t[a]=l,o[a]=h,e.splice(a+1,1),t.splice(a+1,1),o.splice(a+1,1);continue}if(e[a]===OPCODES.LOAD_VALUE&&typeof t[a]=="number"&&e[a+1]===OPCODES.ADD){let l=t[a],h=o[a+1];e[a]=OPCODES.LOAD_CONST_ADD,t[a]=l,o[a]=h,e.splice(a+1,1),t.splice(a+1,1),o.splice(a+1,1);continue}a++}}compile(e){if(e instanceof Value)this.compileValue(e);else if(e instanceof Operation)this.compileOperation(e);else if(e instanceof Assignment)this.compileAssignment(e);else if(e instanceof Variable)this.compileVariable(e);else if(e instanceof Function)this.compileFunction(e);else if(e instanceof FunctionCall)this.compileFunctionCall(e);else if(e instanceof While)this.compileWhile(e);else if(e instanceof SelfAssignment)this.compileSelfAssignment(e);else if(e instanceof Braced)this.compileBraced(e);else if(e instanceof CreateObject)this.compileCreateObject(e);else if(e instanceof Field)this.compileField(e);else if(e instanceof Negate)this.compileNegate(e);else if(e instanceof For)this.compileFor(e);else if(e instanceof ForIn)this.compileForIn(e);else if(e instanceof Not)this.compileNot(e);else if(e instanceof Return)this.compileReturn(e);else if(e instanceof Condition)this.compileCondition(e);else if(e instanceof Break)this.compileBreak(e);else if(e instanceof Continue)this.compileContinue(e);else if(e instanceof CreateClass)this.compileCreateClass(e);else if(e instanceof NewCall)this.compileNewCall(e);else if(e instanceof After)this.compileAfter(e);else if(e instanceof Every)this.compileEvery(e);else if(e instanceof Do)this.compileDo(e);else if(e instanceof Sleep)this.compileSleep(e);else if(e instanceof Delete)this.compileDelete(e);else throw console.info(e),"Not implemented"}compileAssignment(e){let t,o,a,l,h,E;if(e.local)if(e.field instanceof Variable)e.expression instanceof Function?(l=this.locals.register(e.field.identifier),this.compile(e.expression),this.routine.arg1[this.routine.arg1.length-1].import_self=l,this.routine.STORE_LOCAL(l,e)):e.expression instanceof After||e.expression instanceof Do||e.expression instanceof Every?(l=this.locals.register(e.field.identifier),t=this.routine.arg1.length,this.compile(e.expression),this.routine.arg1[t].import_self=l,this.routine.STORE_LOCAL(l,e)):(this.compile(e.expression),l=this.locals.register(e.field.identifier),this.routine.STORE_LOCAL(l,e));else throw"illegal";else if(e.field instanceof Variable)this.locals.get(e.field.identifier)!=null?(this.compile(e.expression),l=this.locals.get(e.field.identifier),this.routine.STORE_LOCAL(l,e)):e.expression instanceof CreateClass?this.compileUpdateClass(e.expression,e.field.identifier):(this.compile(e.expression),this.routine.STORE_VARIABLE(e.field.identifier,e));else{for(o=e.field,o.expression instanceof Variable?o.expression.identifier==="this"?this.routine.LOAD_THIS(o):this.locals.get(o.expression.identifier)!=null?(l=this.locals.get(o.expression.identifier),this.routine.LOAD_LOCAL_OBJECT(l,o.expression)):o.expression.identifier==="global"?this.routine.LOAD_GLOBAL(o):this.routine.LOAD_VARIABLE_OBJECT(o.expression.identifier,e):(this.compile(o.expression),this.routine.MAKE_OBJECT(e)),a=h=0,E=o.chain.length-2;h<=E;a=h+=1)this.compile(o.chain[a]),this.routine.LOAD_PROPERTY_OBJECT(o.chain[a]);this.compile(o.chain[o.chain.length-1]),this.compile(e.expression),this.routine.STORE_PROPERTY(e)}}compileSelfAssignment(e){let t,o,a,l,h,E;switch(e.operation){case"+=":h="ADD";break;case"-=":h="SUB";break;case"*=":h="MUL";break;case"/=":h="DIV";break;case"%=":h="MODULO";break;case"&=":h="BINARY_AND";break;case"|=":h="BINARY_OR";break;default:throw"Unknown self-assignment operation: "+e.operation}if(e.field instanceof Variable)this.locals.get(e.field.identifier)!=null?(a=this.locals.get(e.field.identifier),this.routine.LOAD_LOCAL(a,e),this.compile(e.expression),this.routine[h](e),this.routine.STORE_LOCAL(a,e)):(this.routine.LOAD_VARIABLE(e.field.identifier,e),this.compile(e.expression),this.routine[h](e),this.routine.STORE_VARIABLE(e.field.identifier,e));else{for(t=e.field,t.expression instanceof Variable?t.expression.identifier==="this"?this.routine.LOAD_THIS(t):this.locals.get(t.expression.identifier)!=null?(a=this.locals.get(t.expression.identifier),this.routine.LOAD_LOCAL_OBJECT(a,e)):t.expression.identifier==="global"?this.routine.LOAD_GLOBAL(t):this.routine.LOAD_VARIABLE_OBJECT(t.expression.identifier,e):(this.compile(t.expression),this.routine.MAKE_OBJECT(e)),o=l=0,E=t.chain.length-2;l<=E;o=l+=1)this.compile(t.chain[o]),this.routine.LOAD_PROPERTY_OBJECT(t.chain[o]);this.compile(t.chain[t.chain.length-1]),this.routine.LOAD_PROPERTY_ATOP(e),this.compile(e.expression),this.routine[h](e),this.routine.STORE_PROPERTY(e)}}compileOperation(e){let t,o,a;if((o=e.operation)==="+"||o==="-"||o==="*"||o==="/"||o==="%"||o==="&"||o==="|"||o==="<<"||o===">>"){if(e.term1 instanceof Value&&e.term1.type===Value.TYPE_NUMBER&&e.term2 instanceof Value&&e.term2.type===Value.TYPE_NUMBER){let l,h=e.term1.value,E=e.term2.value;switch(e.operation){case"+":l=h+E;break;case"-":l=h-E;break;case"*":l=h*E;break;case"/":l=h/E;break;case"%":l=h%E;break;case"&":l=h&E;break;case"|":l=h|E;break;case"<<":l=h<<E;break;case">>":l=h>>E;break;default:l=0}this.routine.LOAD_VALUE(l,e);return}switch(this.compile(e.term1),this.compile(e.term2),e.operation){case"+":this.routine.ADD(e);break;case"-":this.routine.SUB(e);break;case"*":this.routine.MUL(e);break;case"/":this.routine.DIV(e);break;case"%":this.routine.MODULO(e);break;case"&":this.routine.BINARY_AND(e);break;case"|":this.routine.BINARY_OR(e);break;case"<<":this.routine.SHIFT_LEFT(e);break;case">>":this.routine.SHIFT_RIGHT(e)}}else if((a=e.operation)==="=="||a==="!="||a==="<"||a===">"||a==="<="||a===">=")switch(this.compile(e.term1),this.compile(e.term2),e.operation){case"==":this.routine.EQ(e);break;case"!=":this.routine.NEQ(e);break;case"<":this.routine.LT(e);break;case">":this.routine.GT(e);break;case"<=":this.routine.LTE(e);break;case">=":this.routine.GTE(e)}else e.operation==="and"?(t=this.routine.createLabel("and"),e.term1.nowarning=!0,e.term2.nowarning=!0,this.compile(e.term1),this.routine.JUMPN_NOPOP(t,e),this.routine.POP(e),this.compile(e.term2),this.routine.setLabel(t)):e.operation==="or"?(t=this.routine.createLabel("or"),e.term1.nowarning=!0,e.term2.nowarning=!0,this.compile(e.term1),this.routine.JUMPY_NOPOP(t,e),this.routine.POP(e),this.compile(e.term2),this.routine.setLabel(t)):e.operation==="^"&&(this.compile(e.term1),this.compile(e.term2),this.routine.BINARY_OP(Q.predefined_binary_functions.pow,e))}compileBraced(e){this.compile(e.expression)}compileNegate(e){e.expression instanceof Value&&e.expression.type===Value.TYPE_NUMBER?this.routine.LOAD_VALUE(-e.expression.value,e):(this.compile(e.expression),this.routine.NEGATE(e))}compileNot(e){e.expression.nowarning=!0,this.compile(e.expression),this.routine.NOT(e)}compileValue(e){let t,o,a;switch(e.type){case Value.TYPE_NUMBER:this.routine.LOAD_VALUE(e.value,e);break;case Value.TYPE_STRING:this.routine.LOAD_VALUE(e.value,e);break;case Value.TYPE_ARRAY:for(this.routine.CREATE_ARRAY(e),t=o=0,a=e.value.length-1;o<=a;t=o+=1)this.routine.LOAD_VALUE(t,e),this.compile(e.value[t]),this.routine.CREATE_PROPERTY(e)}}compileVariable(e){let t,o;o=e.identifier,o==="this"?this.routine.LOAD_THIS(e):o==="global"?this.routine.LOAD_GLOBAL(e):Q.predefined_values[o]!=null?this.routine.LOAD_VALUE(Q.predefined_values[o],e):this.locals.get(o)!=null?(t=this.locals.get(o),this.routine.LOAD_LOCAL(t,e)):this.routine.LOAD_VARIABLE(o,e)}compileField(e){var t,o,a,l,h,E,m,O,g;if((e.expression.identifier==="keyboard"||e.expression.identifier==="gamepad")&&(e.nowarning=!0),t=e.chain[e.chain.length-1],t instanceof Value&&t.value==="type")if(e.chain.length===1)e.expression instanceof Variable?(a=e.expression.identifier,this.locals.get(a)!=null?(l=this.locals.get(a),this.routine.LOAD_LOCAL(l,e),this.routine.TYPE(e)):Q.predefined_values[a]!=null?this.routine.LOAD_VALUE("number",e):Q.predefined_unary_functions[a]!=null||Q.predefined_binary_functions[a]?this.routine.LOAD_VALUE("function",e):this.routine.VARIABLE_TYPE(a,e.expression)):(this.compile(e.expression),this.routine.TYPE(e));else{for(this.compile(e.expression),o=h=0,O=e.chain.length-3;h<=O;o=h+=1)this.compile(e.chain[o]),this.routine.LOAD_PROPERTY(e);this.compile(e.chain[e.chain.length-2]),this.routine.PROPERTY_TYPE(e.expression)}else for(this.compile(e.expression),g=e.chain,E=0,m=g.length;E<m;E++)t=g[E],this.compile(t),this.routine.LOAD_PROPERTY(e)}compileFieldParent(e){var t,o,a,l;for(this.compile(e.expression),o=a=0,l=e.chain.length-2;a<=l;o=a+=1)t=e.chain[o],this.compile(t),this.routine.LOAD_PROPERTY(e)}compileFunctionCall(e){var t,o,a,l,h,E,m,O,g,R,x,T,D,d,F,G,Y,C,$;if(e.expression instanceof Field){for(F=e.args,a=h=0,O=F.length;h<O;a=++h)t=F[a],this.compile(t);this.compileFieldParent(e.expression),this.compile(e.expression.chain[e.expression.chain.length-1]),this.routine.FUNCTION_APPLY_PROPERTY(e.args.length,e)}else if(e.expression instanceof Variable)if(Q.predefined_unary_functions[e.expression.identifier]!=null)o=Q.predefined_unary_functions[e.expression.identifier],e.args.length>0?this.compile(e.args[0]):this.routine.LOAD_VALUE(0,e),this.routine.UNARY_OP(o,e);else if(Q.predefined_binary_functions[e.expression.identifier]!=null)o=Q.predefined_binary_functions[e.expression.identifier],e.args.length>0?this.compile(e.args[0]):this.routine.LOAD_VALUE(0,e),e.args.length>1?this.compile(e.args[1]):this.routine.LOAD_VALUE(0,e),this.routine.BINARY_OP(o,e);else if(e.expression.identifier==="super"){for(G=e.args,a=E=0,g=G.length;E<g;a=++E)t=G[a],this.compile(t);this.routine.SUPER_CALL(e.args.length,e)}else if(this.locals.get(e.expression.identifier)!=null){for(Y=e.args,a=m=0,R=Y.length;m<R;a=++m)t=Y[a],this.compile(t);l=this.locals.get(e.expression.identifier),this.routine.LOAD_LOCAL(l,e),this.routine.FUNCTION_CALL(e.args.length,e)}else{for(C=e.args,a=D=0,x=C.length;D<x;a=++D)t=C[a],this.compile(t);this.routine.LOAD_VALUE(e.expression.identifier,e),this.routine.FUNCTION_APPLY_VARIABLE(e.args.length,e)}else{for($=e.args,d=0,T=$.length;d<T;d++)t=$[d],this.compile(t);this.compile(e.expression),this.routine.FUNCTION_CALL(e.args.length,e)}}compileFor(e){if(e.range_from instanceof Value&&e.range_from.type===Value.TYPE_NUMBER&&e.range_to instanceof Value&&e.range_to.type===Value.TYPE_NUMBER&&(e.range_by==null||e.range_by instanceof Value&&e.range_by.type===Value.TYPE_NUMBER)){let m=e.range_from.value,O=e.range_to.value,g=e.range_by instanceof Value?e.range_by.value:1,R=0;if(g>0&&O>=m?R=Math.floor((O-m)/g)+1:g<0&&O<=m&&(R=Math.floor((m-O)/Math.abs(g))+1),R>0&&R<=5){let x=this.locals.register(e.iterator);this.locals.push();for(let T=0;T<R;T++){let D=m+T*g;this.routine.LOAD_VALUE(D,e),this.routine.STORE_LOCAL(x,e),this.routine.POP(e),this.compileSequence(e.sequence)}this.locals.pop();return}}var t,o,a,l,h,E;l=this.locals.register(e.iterator),this.locals.allocate(),this.locals.allocate(),this.compile(e.range_from),this.routine.STORE_LOCAL(l,e),this.routine.POP(e),this.compile(e.range_to),e.range_by!=null?this.compile(e.range_by):this.routine.LOAD_VALUE(0,e),a=this.routine.createLabel("for_start"),t=this.routine.createLabel("for_continue"),o=this.routine.createLabel("for_end"),this.routine.FORLOOP_INIT([l,o],e),this.routine.setLabel(a),this.locals.push(),h=this.break_label,E=this.continue_label,this.break_label=o,this.continue_label=t,this.compileSequence(e.sequence),this.break_label=h,this.continue_label=E,this.routine.setLabel(t),this.routine.FORLOOP_CONTROL([l,a],e),this.routine.setLabel(o),this.locals.pop()}compileForIn(e){var t,o,a,l,h,E;l=this.locals.register(e.iterator),this.locals.allocate(),this.locals.allocate(),this.compile(e.list),a=this.routine.createLabel("for_start"),t=this.routine.createLabel("for_continue"),o=this.routine.createLabel("for_end"),this.routine.FORIN_INIT([l,o],e),this.routine.setLabel(a),this.locals.push(),h=this.break_label,E=this.continue_label,this.break_label=o,this.continue_label=t,this.compileSequence(e.sequence),this.break_label=h,this.continue_label=E,this.routine.setLabel(t),this.routine.FORIN_CONTROL([l,a],e),this.routine.setLabel(o),this.locals.pop()}compileSequence(e){var t,o,a;for(t=o=0,a=e.length-1;o<=a&&(e[t].nopop||this.routine.POP(e[t]),this.compile(e[t]),!(e[t]instanceof Return||e[t]instanceof Break||e[t]instanceof Continue));t=o+=1);}compileWhile(e){var t,o,a,l;this.locals.push(),l=this.routine.createLabel("while_start"),t=this.routine.createLabel("while_end"),this.routine.LOAD_VALUE(0,e),this.routine.setLabel(l),this.compile(e.condition),this.routine.JUMPN(t),o=this.break_label,a=this.continue_label,this.break_label=t,this.continue_label=l,this.compileSequence(e.sequence),this.routine.JUMP(l,e),this.break_label=o,this.continue_label=a,this.routine.setLabel(t),this.locals.pop()}compileBreak(e){this.break_label!=null&&this.routine.JUMP(this.break_label,e)}compileContinue(e){this.continue_label!=null&&this.routine.JUMP(this.continue_label,e)}compileFunction(e){var t;t=this.compileFunctionBody(e),this.routine.LOAD_ROUTINE(t,e)}compileFunctionBody(e){let t="args"in e&&e.args!=null;var o,a,l,h,E,m,O,g,R,x,T,D,d,F,G,Y,C;if(C=this.routine,x=this.locals,this.routine=new Routine(t?e.args.length:0),this.locals=new Locals(this,x),this.routine.uses_arguments=!0,t){let $=e.args;for(this.routine.uses_arguments&&(a=this.locals.register("arguments"),this.routine.STORE_LOCAL(a,e),this.routine.POP(e)),D=this.locals.register("+numargs"),this.routine.STORE_LOCAL(D,e),this.routine.POP(e),l=E=F=$.length-1;E>=0;l=E+=-1)o=$[l],h=this.locals.register(o.name),this.routine.STORE_LOCAL(h,e),this.routine.POP(e);for(l=m=0,F=$.length-1;m<=F;l=m+=1)o=$[l],o.default!=null&&(h=this.locals.get(o.name),g=this.routine.createLabel("default_arg"),this.routine.LOAD_VALUE(l,e),this.routine.LOAD_LOCAL(D,e),this.routine.LT(e),this.routine.JUMPY(g,e),this.compile(o.default),this.routine.STORE_LOCAL(h,e),this.routine.POP(e),this.routine.setLabel(g))}if(e.sequence.length>0)for(l=O=0,G=e.sequence.length-1;O<=G;l=O+=1)this.compile(e.sequence[l]),l<e.sequence.length-1?this.routine.POP(e.sequence[l]):this.routine.RETURN(e.sequence[l]);else this.routine.LOAD_VALUE(0,e),this.routine.RETURN(e);for(t&&!this.locals.arguments_used&&(this.routine.uses_arguments=!1,this.routine.remove(0),this.routine.remove(0)),h=0,Y=this.locals.imports,T=0,R=Y.length;T<R;T++){let $=Y[T];this.routine.OP_INSERT(OPCODES.LOAD_IMPORT,e,h,h*3),this.routine.OP_INSERT(OPCODES.STORE_LOCAL,e,$.index,h*3+1),this.routine.OP_INSERT(OPCODES.POP,e,0,h*3+2),this.routine.import_refs.push($.source),h+=1}return this.routine.optimize(),this.routine.resolveLabels(),this.count+=this.routine.opcodes.length,d=this.routine,this.routine.locals_size=this.locals.max_index,this.routine=C,this.locals=x,d}compileReturn(e){e.expression!=null?(this.compile(e.expression),this.routine.RETURN(e)):(this.routine.LOAD_VALUE(0,e),this.routine.RETURN(e))}compileCondition(e){var t,o,a,l,h,E,m;for(o=e.chain,this.routine.LOAD_VALUE(0,e),a=this.routine.createLabel("condition_end"),h=E=0,m=o.length-1;E<=m;h=E+=1)l=this.routine.createLabel("condition_next"),t=o[h],t.condition.nowarning=!0,this.compile(t.condition),this.routine.JUMPN(l),this.locals.push(),this.compileSequence(t.sequence),this.locals.pop(),this.routine.JUMP(a,e),this.routine.setLabel(l),h===o.length-1&&t.else!=null&&(this.locals.push(),this.compileSequence(t.else),this.locals.pop());this.routine.setLabel(a)}formatField(e){return e==="constructor"&&(e="_constructor"),String(e).replace(/"/g,'\\"')}compileCreateObject(e){let t,o,a,l;for(this.routine.CREATE_OBJECT(e),l=e.fields,o=0,a=l.length;o<a;o++)t=l[o],this.routine.LOAD_VALUE(t.field,e),this.compile(t.value),this.routine.CREATE_PROPERTY(e)}compileCreateClass(e){let t,o,a,l,h;for(e.ext!=null?(e.ext.nowarning=!0,this.compile(e.ext)):this.routine.LOAD_VALUE(0,e),h=e.ext!=null&&e.ext instanceof Variable?e.ext.identifier:0,this.routine.CREATE_CLASS(h,e),l=e.fields,o=0,a=l.length;o<a;o++)t=l[o],this.routine.LOAD_VALUE(t.field,e),this.compile(t.value),this.routine.CREATE_PROPERTY(e)}compileUpdateClass(e,t){this.compileCreateClass(e),this.routine.UPDATE_CLASS(t,e)}compileNewCall(e){let t,o,a,l,h,E;for(o=e.expression,this.routine.LOAD_VALUE(0,e),E=o.args,a=l=0,h=E.length;l<h;a=++l)t=E[a],this.compile(t);this.compile(o.expression),this.routine.NEW_CALL(o.args.length,e),this.routine.POP(e)}compileAfter(e){let t;t=this.compileFunctionBody(e),this.routine.LOAD_ROUTINE(t,e),this.compile(e.delay),e.multiplier!=null&&e.multiplier!==1&&(this.routine.LOAD_VALUE(e.multiplier,e),this.routine.MUL(e)),this.routine.AFTER(e)}compileEvery(e){let t;t=this.compileFunctionBody(e),this.routine.LOAD_ROUTINE(t,e),this.compile(e.delay),e.multiplier!=null&&e.multiplier!==1&&(this.routine.LOAD_VALUE(e.multiplier,e),this.routine.MUL(e)),this.routine.EVERY(e)}compileDo(e){let t;t=this.compileFunctionBody(e),this.routine.LOAD_ROUTINE(t,e),this.routine.DO(e)}compileSleep(e){this.compile(e.delay),e.multiplier!=null&&e.multiplier!==1&&(this.routine.LOAD_VALUE(e.multiplier,e),this.routine.MUL(e)),this.routine.SLEEP(e)}compileDelete(e){let t,o,a,l;if(e.field instanceof Variable)this.routine.LOAD_THIS(e),this.routine.LOAD_VALUE(e.field.identifier,e),this.routine.DELETE(e);else if(e.field instanceof Field){for(this.compile(e.field.expression),t=e.field.chain,o=a=0,l=t.length-1;a<=l;o=a+=1)this.compile(t[o]),o<t.length-1&&this.routine.LOAD_PROPERTY(e);this.routine.DELETE(e)}else throw"Delete expects variable or field access"}exec(e){if(this.processor||(this.processor=new globalThis.Processor),!this.routine)throw new Error("No routine to execute");return this.processor.load(this.routine),this.processor.run(e)}static predefined_unary_functions={round:Math.round,floor:Math.floor,ceil:Math.ceil,abs:Math.abs,sqrt:Math.sqrt,sin:Math.sin,cos:Math.cos,tan:Math.tan,acos:Math.acos,asin:Math.asin,atan:Math.atan,sind:__name(e=>Math.sin(e*Math.PI/180),"sind"),cosd:__name(e=>Math.cos(e*Math.PI/180),"cosd"),tand:__name(e=>Math.tan(e*Math.PI/180),"tand"),asind:__name(e=>Math.asin(e)/Math.PI*180,"asind"),acosd:__name(e=>Math.acos(e)/Math.PI*180,"acosd"),atand:__name(e=>Math.atan(e)/Math.PI*180,"atand"),log:Math.log,exp:Math.exp};static predefined_binary_functions={min:Math.min,max:Math.max,pow:Math.pow,atan2:Math.atan2,atan2d:__name((e,t)=>Math.atan2(e,t)/Math.PI*180,"atan2d")};static predefined_values={PI:Math.PI,true:1,false:0}},Locals=class{static{b(this,"Locals")}static{__name(this,"Locals")}compiler;parent;layers;index;max_index;imports;arguments_used;constructor(n,e=null){this.compiler=n,this.parent=e,this.layers=[],this.index=0,this.max_index=0,this.imports=[],this.push()}increment(){let n=this.index++;return this.max_index=Math.max(this.index,this.max_index),n}push(){return this.layers.push(new LocalLayer(this))}pop(){return this.layers.splice(this.layers.length-1,1)}register(n){return this.layers[this.layers.length-1].register(n)}allocate(){return this.layers[this.layers.length-1].allocate()}get(n){let e,t,o,a;for(n==="arguments"&&(this.arguments_used=!0),e=o=this.layers.length-1;o>=0;e=o-=1)if(a=this.layers[e].get(n),a!=null)return a;return this.parent!=null&&(a=this.parent.get(n),a!=null)?(t=this.register(n),this.imports.push({name:n,index:t,source:a}),t):null}},LocalLayer=class{static{b(this,"LocalLayer")}static{__name(this,"LocalLayer")}locals;start_index;registered;constructor(n){this.locals=n,this.start_index=this.locals.index,this.registered={}}register(n){return this.registered[n]=this.locals.increment()}allocate(){return this.locals.increment()}get(n){return this.registered[n]!=null?this.registered[n]:null}},Token=class I{static{b(this,"_Token")}static{__name(this,"Token")}tokenizer;type;value;string_value;line;column;start;length;index;reserved_keyword;is_binary_operator;constructor(e,t,o,a){this.tokenizer=e,this.type=t,this.value=o,this.string_value=a,this.line=e.line,this.column=e.column,this.start=e.token_start,this.length=e.index-this.start,this.index=e.index,this.type===I.TYPE_IDENTIFIER&&Object.hasOwn(I.predefined,String(this.value))&&(this.type=I.predefined[String(this.value)],this.reserved_keyword=!0),this.is_binary_operator=this.type>=30&&this.type<=39||this.type>=200&&this.type<=201||this.type>=2&&this.type<=7}toString(){return String(this.value)+" : "+this.type}static TYPE_EQUALS=1;static TYPE_DOUBLE_EQUALS=2;static TYPE_GREATER=3;static TYPE_GREATER_OR_EQUALS=4;static TYPE_LOWER=5;static TYPE_LOWER_OR_EQUALS=6;static TYPE_UNEQUALS=7;static TYPE_IDENTIFIER=10;static TYPE_NUMBER=11;static TYPE_STRING=12;static TYPE_OPEN_BRACE=20;static TYPE_CLOSED_BRACE=21;static TYPE_OPEN_BRACKET=24;static TYPE_CLOSED_BRACKET=25;static TYPE_COMMA=26;static TYPE_DOT=27;static TYPE_COLON=28;static TYPE_PLUS=30;static TYPE_MINUS=31;static TYPE_MULTIPLY=32;static TYPE_DIVIDE=33;static TYPE_POWER=34;static TYPE_MODULO=35;static TYPE_BINARY_AND=36;static TYPE_BINARY_OR=37;static TYPE_SHIFT_LEFT=38;static TYPE_SHIFT_RIGHT=39;static TYPE_PLUS_EQUALS=40;static TYPE_MINUS_EQUALS=41;static TYPE_MULTIPLY_EQUALS=42;static TYPE_DIVIDE_EQUALS=43;static TYPE_MODULO_EQUALS=44;static TYPE_AND_EQUALS=45;static TYPE_OR_EQUALS=46;static TYPE_RETURN=100;static TYPE_BREAK=101;static TYPE_CONTINUE=102;static TYPE_FUNCTION=103;static TYPE_IF=104;static TYPE_THEN=105;static TYPE_ELSE=106;static TYPE_ELSIF=107;static TYPE_END=108;static TYPE_FOR=109;static TYPE_TO=110;static TYPE_BY=111;static TYPE_IN=112;static TYPE_WHILE=113;static TYPE_OBJECT=114;static TYPE_CLASS=115;static TYPE_EXTENDS=116;static TYPE_NEW=117;static TYPE_ARROW=118;static TYPE_TEMPLATE=119;static TYPE_AFTER=61;static TYPE_EVERY=62;static TYPE_DO=63;static TYPE_SLEEP=64;static TYPE_LOCAL=70;static TYPE_AND=200;static TYPE_OR=201;static TYPE_NOT=202;static TYPE_ERROR=404;static TYPE_DELETE=403;static predefined={return:I.TYPE_RETURN,break:I.TYPE_BREAK,continue:I.TYPE_CONTINUE,function:I.TYPE_FUNCTION,for:I.TYPE_FOR,to:I.TYPE_TO,by:I.TYPE_BY,in:I.TYPE_IN,while:I.TYPE_WHILE,if:I.TYPE_IF,then:I.TYPE_THEN,else:I.TYPE_ELSE,elsif:I.TYPE_ELSIF,end:I.TYPE_END,object:I.TYPE_OBJECT,class:I.TYPE_CLASS,extends:I.TYPE_EXTENDS,new:I.TYPE_NEW,and:I.TYPE_AND,or:I.TYPE_OR,not:I.TYPE_NOT,after:I.TYPE_AFTER,every:I.TYPE_EVERY,do:I.TYPE_DO,sleep:I.TYPE_SLEEP,delete:I.TYPE_DELETE,local:I.TYPE_LOCAL,var:I.TYPE_LOCAL,let:I.TYPE_LOCAL}},Tokenizer=class{static{b(this,"Tokenizer")}static{__name(this,"Tokenizer")}input;filename;index=0;line=1;column=0;last_column=0;buffer=[];token_start=0;chars={};doubles={};shifts={};letter_regex=/^\p{L}/u;constructor(n,e){this.input=n,this.filename=e,this.chars["("]=Token.TYPE_OPEN_BRACE,this.chars[")"]=Token.TYPE_CLOSED_BRACE,this.chars["["]=Token.TYPE_OPEN_BRACKET,this.chars["]"]=Token.TYPE_CLOSED_BRACKET,this.chars["{"]=22,this.chars["}"]=23,this.chars["^"]=Token.TYPE_POWER,this.chars[","]=Token.TYPE_COMMA,this.chars["."]=Token.TYPE_DOT,this.chars[":"]=Token.TYPE_COLON,this.doubles[">"]=[Token.TYPE_GREATER,Token.TYPE_GREATER_OR_EQUALS],this.doubles["<"]=[Token.TYPE_LOWER,Token.TYPE_LOWER_OR_EQUALS],this.doubles["="]=[Token.TYPE_EQUALS,Token.TYPE_DOUBLE_EQUALS],this.doubles["+"]=[Token.TYPE_PLUS,Token.TYPE_PLUS_EQUALS],this.doubles["-"]=[Token.TYPE_MINUS,Token.TYPE_MINUS_EQUALS],this.doubles["*"]=[Token.TYPE_MULTIPLY,Token.TYPE_MULTIPLY_EQUALS],this.doubles["/"]=[Token.TYPE_DIVIDE,Token.TYPE_DIVIDE_EQUALS],this.doubles["%"]=[Token.TYPE_MODULO,Token.TYPE_MODULO_EQUALS],this.doubles["&"]=[Token.TYPE_BINARY_AND,Token.TYPE_AND_EQUALS],this.doubles["|"]=[Token.TYPE_BINARY_OR,Token.TYPE_OR_EQUALS],this.shifts["<"]=Token.TYPE_SHIFT_LEFT,this.shifts[">"]=Token.TYPE_SHIFT_RIGHT}pushBack(n){return this.buffer.splice(0,0,n),n}peek(){if(this.buffer.length>0)return this.buffer[0];let n=this.next();return n&&this.pushBack(n),n}finished(){return this.index>=this.input.length&&this.buffer.length===0}nextChar(n=!1){let e,t;if(e=this.input.charAt(this.index++),e===`
`)this.line+=1,this.last_column=this.column,this.column=0;else if(e==="/"&&!n){if(this.input.charAt(this.index)==="/"){for(;e=this.input.charAt(this.index++),!(e===`
`||this.index>=this.input.length););return this.line+=1,this.last_column=this.column,this.column=0,this.nextChar()}else if(this.input.charAt(this.index)==="*"){for(t=0;;){if(e=this.input.charAt(this.index++),e===`
`)this.line+=1,this.last_column=this.column,this.column=0,t=0;else if(e==="*")t=1;else{if(e==="/"&&t===1)break;t=0}if(this.index>=this.input.length)break}return this.nextChar()}}else this.column+=1;return e}rewind(){this.index-=1,this.column-=1,this.input.charAt(this.index)===`
`&&(this.line-=1,this.column=this.last_column)}next(){let n,e;if(this.buffer.length>0)return this.buffer.splice(0,1)[0];for(;;){if(this.index>=this.input.length)return null;if(n=this.nextChar(),e=n.charCodeAt(0),e>32&&e!==160)break}return this.token_start=this.index-1,this.doubles[n]!=null?this.parseDouble(n,this.doubles[n]):this.chars[n]!=null?new Token(this,this.chars[n],n):n==="!"?this.parseUnequals(n):e>=48&&e<=57?this.parseNumber(n):e>=65&&e<=90||e>=97&&e<=122||e===95||this.letter_regex.test(n)?this.parseIdentifier(n):n==='"'?this.parseString(n,'"'):n==="'"?this.parseString(n,"'"):n==="`"?this.parseString(n,"`"):this.error("Syntax Error")}changeNumberToIdentifier(){let n,e,t,o=[];if(e=this.next(),e!=null&&e.type===Token.TYPE_NUMBER){for(t=(e.string_value||String(e.value)).split("."),n=t.length-1;n>=0;n--)t[n].length>0&&this.pushBack(new Token(this,Token.TYPE_IDENTIFIER,t[n])),n>0&&o.push(this.pushBack(new Token(this,Token.TYPE_DOT,".")));return o}else return e!=null&&e.type===Token.TYPE_STRING?this.pushBack(new Token(this,Token.TYPE_IDENTIFIER,e.value)):e?this.pushBack(e):void 0}parseDouble(n,e){let t=this.input.charAt(this.index);return n==="="&&t===">"?(this.nextChar(),new Token(this,Token.TYPE_ARROW,"=>")):this.shifts[n]!=null&&this.index<this.input.length&&t===n?(this.nextChar(),new Token(this,this.shifts[n],n+n)):e&&this.index<this.input.length&&t==="="?(this.nextChar(),new Token(this,e[1],n+"=")):new Token(this,e?e[0]:this.chars[n],n)}parseEquals(n){return this.index<this.input.length&&this.input.charAt(this.index)==="="?(this.nextChar(),new Token(this,Token.TYPE_DOUBLE_EQUALS,"==")):new Token(this,Token.TYPE_EQUALS,"=")}parseGreater(n){return this.index<this.input.length&&this.input.charAt(this.index)==="="?(this.nextChar(),new Token(this,Token.TYPE_GREATER_OR_EQUALS,">=")):new Token(this,Token.TYPE_GREATER,">")}parseLower(n){return this.index<this.input.length&&this.input.charAt(this.index)==="="?(this.nextChar(),new Token(this,Token.TYPE_LOWER_OR_EQUALS,"<=")):new Token(this,Token.TYPE_LOWER,"<")}parseUnequals(n){return this.index<this.input.length&&this.input.charAt(this.index)==="="?(this.nextChar(),new Token(this,Token.TYPE_UNEQUALS,"!=")):this.error("Expected inequality !=")}parseIdentifier(n){let e,t;for(;;){if(this.index>=this.input.length)return new Token(this,Token.TYPE_IDENTIFIER,n);if(e=this.nextChar(),t=e.charCodeAt(0),t>=65&&t<=90||t>=97&&t<=122||t===95||t>=48&&t<=57||this.letter_regex.test(e))n+=e;else return this.rewind(),new Token(this,Token.TYPE_IDENTIFIER,n)}}parseNumber(n){let e,t,o=!1,a=!1;for(;;){if(this.index>=this.input.length)return new Token(this,Token.TYPE_NUMBER,Number.parseFloat(n),n);if(e=this.nextChar(),t=e.charCodeAt(0),e==="."&&!a&&!o)a=!0,n+=e;else if(t>=48&&t<=57)n+=e;else if((e==="e"||e==="E")&&!o&&this.index<this.input.length)o=!0,n+=e,e=this.nextChar(),e==="+"||e==="-"?n+=e:this.rewind();else return(e==="x"||e==="X")&&n==="0"?this.parseHexNumber("0x"):(this.rewind(),new Token(this,Token.TYPE_NUMBER,Number.parseFloat(n),n))}}parseHexNumber(n){let e;for(;;){if(this.index>=this.input.length)return new Token(this,Token.TYPE_NUMBER,Number.parseInt(n),n);if(e=this.nextChar(),/[a-fA-F0-9]/.test(e))n+=e;else return this.rewind(),new Token(this,Token.TYPE_NUMBER,Number.parseInt(n),n)}}parseString(n,e){let t,o=0,a;for(e==null&&(e='"'),e==='"'&&this.input.charAt(this.index)==='"'&&this.input.charAt(this.index+1)==='"'&&this.input.charAt(this.index+2)!=='"'&&(e='"""',this.nextChar(!0),this.nextChar(!0));;){if(this.index>=this.input.length)return this.error("Unclosed string value");if(t=this.nextChar(!0),t==="\\")switch(a=this.nextChar(!0),a){case"n":n+=`
`;break;case"\\":n+="\\";break;case e:n+=e;break;default:n+="\\"+a}else if(t===e)if(a=this.nextChar(!0),a===e)n+=t;else return this.rewind(),n+=t,new Token(this,e==="`"?Token.TYPE_TEMPLATE:Token.TYPE_STRING,n.substring(1,n.length-1));else{if(e==='"""'&&t==='"'){if(o+=1,o===3)return new Token(this,Token.TYPE_STRING,n.substring(1,n.length-2))}else o=0;n+=t}}}error(n){throw new Error(n)}},ErrorCode=function(n){return n.E1001="E1001",n.E1002="E1002",n.E1003="E1003",n.E1004="E1004",n.E1005="E1005",n.E1006="E1006",n.E1007="E1007",n.E1008="E1008",n.E1009="E1009",n.E2001="E2001",n.E2002="E2002",n.E2003="E2003",n.E2004="E2004",n.E2005="E2005",n.E3001="E3001",n}({}),LootiScriptError=class extends Error{static{b(this,"LootiScriptError")}static{__name(this,"LootiScriptError")}file;line;column;stackTrace;constructor(n,e,t,o,a){super(n),this.file=e,this.line=t,this.column=o,this.stackTrace=a,this.name="LootiScriptError"}toString(){let n=`${this.name}: ${this.message}
`;if(n+=`  at ${this.file}:${this.line}:${this.column}
`,this.stackTrace&&this.stackTrace.length>0){n+=`
Stack trace:
`;for(let e of this.stackTrace)n+=`  at ${e.functionName} (${e.file}:${e.line}:${e.column})
`}return n}},SyntaxError=class extends LootiScriptError{static{b(this,"SyntaxError")}static{__name(this,"SyntaxError")}context;code;suggestions;related;constructor(n,e,t,o,a,l,h,E){super(n,e,t,o),this.context=a,this.code=l,this.suggestions=h,this.related=E,this.name="SyntaxError"}toString(){let n="";if(this.code&&(n+=`[${this.code}] `),n+=`${this.name}: ${this.message}
`,n+=`  at ${this.file}:${this.line}:${this.column}
`,this.context&&(n+=`
${this.context}
`),this.suggestions&&this.suggestions.length>0){n+=`
Suggestions:
`;for(let e of this.suggestions)n+=`  \u2022 ${e}
`}return this.related&&(n+=`
Related: ${this.related.message} at ${this.related.file}:${this.related.line}:${this.related.column}
`),n}};function formatSourceContext(n,e,t,o=3,a=1){let l=n.split(`
`),h=Math.max(0,e-o-1),E=Math.min(l.length-1,e+o-1),m=`
Source context:
`;for(let O=h;O<=E;O++){let g=O+1,R=g===e?">":" ",x=String(g).padStart(4," "),T=l[O]||"";if(m+=`${R} ${x} | ${T}
`,g===e){let d=" ".repeat(8+Math.max(0,t-1))+"^".repeat(Math.max(1,a));m+=`${d}
`}}return m}b(formatSourceContext,"formatSourceContext");__name(formatSourceContext,"formatSourceContext");var Parser=class ne{static{b(this,"_Parser")}static{__name(this,"Parser")}input;filename;tokenizer;program;current_block;current;verbose;nesting;object_nesting;not_terminated;function_stack;api_reserved;warnings;unexpected_eof;error_info;last_function_call;static multipliers={millisecond:1,milliseconds:1,second:1e3,seconds:1e3,minute:6e4,minutes:6e4,hour:6e4*60,hours:6e4*60,day:6e4*60*24,days:6e4*60*24};constructor(e,t=""){this.input=e,this.filename=t,/^\s*\/\/\s*javascript\s*\n/.test(this.input)&&(this.input=`system.javascript("""

`+this.input.replace(/\\/g,"\\\\")+`

""")`),this.tokenizer=new Tokenizer(this.input,this.filename),this.program=new Program,this.current_block=[],this.current={line:1,column:1,tokenizer:this.tokenizer,type:0,value:"",start:0,length:0,index:0,is_binary_operator:!1},this.verbose=!1,this.nesting=0,this.object_nesting=0,this.not_terminated=[],this.function_stack=[],this.api_reserved={screen:!0,audio:!0,keyboard:!0,gamepad:!0,sprites:!0,sounds:!0,music:!0,assets:!0,asset_manager:!0,maps:!0,touch:!0,mouse:!0,fonts:!0,Sound:!0,Image:!0,Sprite:!0,Map:!0,system:!0,storage:!0,print:!0,random:!0,Function:!0,List:!0,Object:!0,String:!0,Number:!0,scenes:!0},this.warnings=[]}nextToken(){let e=this.tokenizer.next();if(e==null)throw this.unexpected_eof=!0,"Unexpected end of file";return this.current=e}nextTokenOptional(){let e=this.tokenizer.next();return e!=null&&(this.current=e),e}parse(){let e,t,o,a;try{for(this.warnings=[];;){if(t=this.parseLine(),t==null&&!this.tokenizer.finished())if(a=this.tokenizer.next(),a!=null&&a.reserved_keyword)if(a.value==="end"){let l=formatSourceContext(this.input,a.line,a.column,3,3),h=["Remove this extra 'end' statement","Check if you're missing an opening statement (if, for, while, function)","Verify all blocks are properly matched"];return this.error_info={error:"Too many 'end' statements - no matching opening statement found",line:a.line,column:a.column,context:l,code:ErrorCode.E1002,suggestions:h}}else this.error(`Misuse of reserved keyword: '${a.value}'`);else this.error("Unexpected data");if(t===null)break;this.current_block.push(t),this.program.add(t),this.verbose&&console.info(t)}return this}catch(l){if(e=l,e instanceof SyntaxError)return this.error_info={error:e.message,line:e.line,column:e.column,context:e.context};if(this.not_terminated.length>0&&e==="Unexpected end of file"){o=this.not_terminated[this.not_terminated.length-1];let h=null,E=null,m=null;if(o.value==="function")for(let D=this.function_stack.length-1;D>=0;D--){let d=this.function_stack[D];if(d.token===o){h=d.name,E=d.line,m=d.column;break}}let O=typeof o.value=="string"?o.value.length:1,g=formatSourceContext(o.tokenizer.input,o.line,o.column,3,O),R,x=[],T;return o.value==="function"&&h?(R=`Function '${h}' started at line ${E} is not closed`,x=[`Add 'end' after the last statement to close function '${h}'`,"Check if you have an extra 'end' statement somewhere","Verify all nested blocks (if, for, while) are properly closed"],T={file:this.filename,line:E,column:m,message:`Function '${h}' started here`}):(R=`Unterminated '${o.value}' ; no matching 'end' found`,x=[`Add 'end' to close the '${o.value}' statement`,"Check if you have nested blocks that need to be closed first"]),this.error_info={error:R,line:o.line,column:o.column,context:g,code:ErrorCode.E1001,suggestions:x,related:T}}else{let h=formatSourceContext(this.input,this.current.line,this.current.column,3,1);return this.error_info={error:typeof e=="string"?e:e.message||String(e),line:this.current.line,column:this.current.column,context:h,code:ErrorCode.E1004}}}}parseLine(){let e=this.nextTokenOptional();if(e==null)return null;switch(e.type){case Token.TYPE_RETURN:return new Return(e,this.parseExpression());case Token.TYPE_BREAK:return new Break(e);case Token.TYPE_CONTINUE:return new Continue(e);case Token.TYPE_LOCAL:return this.parseLocalAssignment(e);default:return this.tokenizer.pushBack(e),this.parseExpression()}}parseExpression(e,t=!1){let o,a;if(a=this.parseExpressionStart(),a==null)return null;for(;;){if(o=this.parseExpressionSuffix(a,e),o==null)return a;if(t&&o instanceof FunctionCall)return o;a=o}}assertExpression(e,t=!1){let o=this.parseExpression(e,t);if(o==null)throw"Expression expected";return o}parseExpressionSuffix(e,t){let o,a,l=this.nextTokenOptional();if(l==null)return t==="self"?e:null;switch(l.type){case Token.TYPE_DOT:return e instanceof Value&&e.type===Value.TYPE_NUMBER?(this.tokenizer.pushBack(l),null):(this.tokenizer.changeNumberToIdentifier(),a=this.assertBroadIdentifier("Expected identifier"),Program.CreateFieldAccess(l,e,new Value(a,Value.TYPE_STRING,a.value)));case Token.TYPE_OPEN_BRACKET:return o=this.assertExpression(),this.assert(Token.TYPE_CLOSED_BRACKET,"Expected ']'"),Program.CreateFieldAccess(l,e,o);case Token.TYPE_OPEN_BRACE:return this.parseFunctionCall(l,e);case Token.TYPE_EQUALS:return this.parseAssignment(l,e);case Token.TYPE_PLUS_EQUALS:return this.parseSelfAssignment(l,e,l.type);case Token.TYPE_MINUS_EQUALS:return this.parseSelfAssignment(l,e,l.type);case Token.TYPE_MULTIPLY_EQUALS:return this.parseSelfAssignment(l,e,l.type);case Token.TYPE_DIVIDE_EQUALS:return this.parseSelfAssignment(l,e,l.type);case Token.TYPE_MODULO_EQUALS:case Token.TYPE_AND_EQUALS:case Token.TYPE_OR_EQUALS:return this.parseSelfAssignment(l,e,l.type);default:return t==="self"?(this.tokenizer.pushBack(l),e):l.is_binary_operator&&t!=="noop"?this.parseBinaryOperation(l,e):(this.tokenizer.pushBack(l),null)}}parseExpressionStart(){let e,t=this.nextTokenOptional();if(t==null)return null;switch(t.type){case Token.TYPE_IDENTIFIER:return new Variable(t,t.value);case Token.TYPE_NUMBER:return this.parseNumberExpression(t);case Token.TYPE_PLUS:return this.assertExpression();case Token.TYPE_MINUS:return this.parseExpressionSuffix(new Negate(t,this.assertExpression("noop")),"self");case Token.TYPE_NOT:return this.parseExpressionSuffix(new Not(t,this.assertExpression("noop")),"self");case Token.TYPE_STRING:return this.parseStringExpression(t);case Token.TYPE_TEMPLATE:return this.parseTemplate(t);case Token.TYPE_IF:return this.parseIf(t);case Token.TYPE_FOR:return this.parseFor(t);case Token.TYPE_WHILE:return this.parseWhile(t);case Token.TYPE_OPEN_BRACE:return this.parseBracedExpression(t);case Token.TYPE_OPEN_BRACKET:return this.parseArray(t);case Token.TYPE_FUNCTION:return this.parseFunction(t);case Token.TYPE_OBJECT:return this.parseObject(t);case Token.TYPE_CLASS:return this.parseClass(t);case Token.TYPE_NEW:return this.parseNew(t);case Token.TYPE_DOT:if(e=this.assert(Token.TYPE_NUMBER,"malformed number"),!Number.isInteger(e.value))throw"malformed number";return new Value(t,Value.TYPE_NUMBER,Number.parseFloat(`.${e.string_value}`));case Token.TYPE_AFTER:return this.parseAfter(t);case Token.TYPE_EVERY:return this.parseEvery(t);case Token.TYPE_DO:return this.parseDo(t);case Token.TYPE_SLEEP:return this.parseSleep(t);case Token.TYPE_DELETE:return this.parseDelete(t);default:return this.tokenizer.pushBack(t),null}}parseNumberExpression(e){return new Value(e,Value.TYPE_NUMBER,e.value)}parseStringExpression(e){let t=this.nextTokenOptional();return t!=null&&this.tokenizer.pushBack(t),new Value(e,Value.TYPE_STRING,e.value)}parseArray(e){let t=[];for(;;){let o=this.nextToken();if(o.type===Token.TYPE_CLOSED_BRACKET)return new Value(e,Value.TYPE_ARRAY,t);o.type===Token.TYPE_COMMA||(this.tokenizer.pushBack(o),t.push(this.assertExpression()))}}parseBinaryOperation(e,t){let o=[{token:e,operation:e.value}],a=[t];for(a.push(this.assertExpression("noop"));;){let l=this.nextTokenOptional();if(l==null)break;if(!l.is_binary_operator){this.tokenizer.pushBack(l);break}o.push({token:l,operation:l.value}),a.push(this.assertExpression("noop"))}return Program.BuildOperations(o,a)}parseAssignment(e,t){let o;if(!(t instanceof Variable||t instanceof Field))throw"Expected variable identifier or property";this.object_nesting===0&&t instanceof Variable&&this.api_reserved[t.identifier]&&this.warnings.push({type:"assigning_api_variable",identifier:t.identifier,line:e.line,column:e.column});let a=this.tokenizer.peek(),l=null;t instanceof Variable&&(l=t.identifier),a&&(a.type,Token.TYPE_FUNCTION);let h=this.assertExpression();if(h instanceof Function&&l&&this.function_stack.length>0){let E=h.token;for(let m=this.function_stack.length-1;m>=0;m--){let O=this.function_stack[m];if(O.token===E&&O.name==="anonymous"){O.name=l;break}}}return t instanceof Field?(this.object_nesting+=1,o=new Assignment(e,t,h,!1),this.object_nesting-=1):o=new Assignment(e,t,h,!1),o}parseSelfAssignment(e,t,o){if(!(t instanceof Variable||t instanceof Field))throw"Expected variable identifier or property";let a;return o===Token.TYPE_PLUS_EQUALS?a="+=":o===Token.TYPE_MINUS_EQUALS?a="-=":o===Token.TYPE_MULTIPLY_EQUALS?a="*=":o===Token.TYPE_DIVIDE_EQUALS?a="/=":o===Token.TYPE_MODULO_EQUALS?a="%=":o===Token.TYPE_AND_EQUALS?a="&=":o===Token.TYPE_OR_EQUALS?a="|=":a=String(o),new SelfAssignment(e,t,a,this.assertExpression())}parseLocalAssignment(e){let t=this.assert(Token.TYPE_IDENTIFIER,"Expected identifier");return this.parseOptionalType(),this.assert(Token.TYPE_EQUALS,"Expected '='"),new Assignment(e,new Variable(t,t.value),this.assertExpression(),!0)}parseBracedExpression(e){if(this.current.type===Token.TYPE_CLOSED_BRACE){let a=this.nextToken(),l=this.nextToken();return l.type===Token.TYPE_ARROW?this.parseArrowFunction(l,[]):(this.tokenizer.pushBack(l),this.current=a,this.error("Unexpected ')'"))}let t=this.assertExpression();this.parseOptionalType();let o=this.nextToken();if(o.type===Token.TYPE_CLOSED_BRACE){let a=this.nextToken();return a.type===Token.TYPE_ARROW?this.parseArrowFunction(a,[t]):(this.tokenizer.pushBack(a),this.current=o,new Braced(e,t))}else if(o.type===Token.TYPE_COMMA){let a=[t];for(;;){a.push(this.assertExpression()),this.parseOptionalType();let h=this.nextToken();if(h.type===Token.TYPE_CLOSED_BRACE)break;if(h.type!==Token.TYPE_COMMA)return this.error("Expected ',' or ')'")}let l=this.nextToken();return l.type===Token.TYPE_ARROW?this.parseArrowFunction(l,a):this.error("Expected '=>' after parameter list")}else return this.error("missing closing parenthese")}parseArrowFunction(e,t){let o=[];for(let h of t)if(h instanceof Variable)o.push({name:h.identifier,default:void 0});else throw this.error("Invalid argument in arrow function");let a=[],l=this.parseLine();return l&&(l instanceof Value||l instanceof Variable||l instanceof Operation||l instanceof FunctionCall||l instanceof Assignment||l instanceof Braced?a.push(new Return(e,l)):a.push(l)),new Function(e,o,a,e)}parseFunctionCall(e,t){let o=[];for(this.last_function_call=new FunctionCall(e,t,o);;){let a=this.nextTokenOptional();if(a==null)return this.error("missing closing parenthese");if(a.type===Token.TYPE_CLOSED_BRACE)return new FunctionCall(a,t,o);a.type===Token.TYPE_COMMA||(this.tokenizer.pushBack(a),o.push(this.assertExpression()))}}addTerminable(e){return this.not_terminated.push(e)}endTerminable(){this.not_terminated.length>0&&this.not_terminated.splice(this.not_terminated.length-1,1)}parseFunction(e){let t,o=this.parseFunctionArgs(),a=[];this.nesting+=1;let l={name:"anonymous",line:e.line,column:e.column,token:e};this.function_stack.push(l),this.addTerminable(e);try{for(;;){let h=this.nextToken();if(h.type===Token.TYPE_END)return this.nesting-=1,this.endTerminable(),this.function_stack.pop(),new Function(e,o,a,h);this.tokenizer.pushBack(h),t=this.parseLine(),t!=null?a.push(t):this.error("Unexpected data while parsing function")}}catch(h){throw this.function_stack.length>0&&this.function_stack[this.function_stack.length-1].token===e&&this.function_stack.pop(),h}}parseFunctionArgs(){let e=[],t=null,o=this.nextToken();if(o.type!==Token.TYPE_OPEN_BRACE)return this.error("Expected opening parenthese");for(;;){if(o=this.nextToken(),o.type===Token.TYPE_CLOSED_BRACE)return e;if(o.type===Token.TYPE_COMMA)t=null;else if(o.type===Token.TYPE_EQUALS&&t==="argument"){let a=this.assertExpression();e.length>0&&(e[e.length-1].default=a)}else if(o.type===Token.TYPE_IDENTIFIER)t="argument",e.push({name:o.value}),this.parseOptionalType();else return this.error("Unexpected token")}}warningAssignmentCondition(e){e instanceof Assignment&&this.warnings.push({type:"assignment_as_condition",line:e.token.line,column:e.token.column})}parseIf(e){let t,o,a=[],l={condition:this.assertExpression(),sequence:[]};if(this.addTerminable(e),this.warningAssignmentCondition(l.condition),o=this.nextToken(),o.type!==Token.TYPE_THEN)return this.error("Expected 'then'");for(;;)if(o=this.nextToken(),o.type===Token.TYPE_ELSIF)a.push(l),l={condition:this.assertExpression(),sequence:[]},this.warningAssignmentCondition(l.condition),this.assert(Token.TYPE_THEN,"Expected 'then'");else if(o.type===Token.TYPE_ELSE)l.else=[];else{if(o.type===Token.TYPE_END)return a.push(l),this.endTerminable(),new Condition(e,a);{this.tokenizer.pushBack(o);let h=this.parseLine();if(h==null)throw Error("Unexpected data while parsing if");t=h,l.else!=null?l.else.push(t):l.sequence.push(t)}}}assert(e,t){let o=this.nextToken();if(o.type!==e)throw t;return o}assertBroadIdentifier(e){let t=this.nextToken();if(t.type!==Token.TYPE_IDENTIFIER&&t.reserved_keyword&&(t.type=Token.TYPE_IDENTIFIER),t.type!==Token.TYPE_IDENTIFIER)throw e;return t}error(e){let t=this.current,o=formatSourceContext(t.tokenizer.input,t.line,t.column,2);throw new SyntaxError(e,t.tokenizer.filename,t.line,t.column,o)}parseOptionalType(){let e=this.nextTokenOptional();if(e!=null)if(e.type===Token.TYPE_COLON)for(this.assert(Token.TYPE_IDENTIFIER,"Expected type identifier");;)if(e=this.nextTokenOptional(),e&&e.type===Token.TYPE_OPEN_BRACKET)this.assert(Token.TYPE_CLOSED_BRACKET,"Expected ']'");else{e&&this.tokenizer.pushBack(e);break}else this.tokenizer.pushBack(e)}parseFor(e){let t,o,a,l,h,E=this.assertExpression();if(E instanceof Assignment){a=E.expression;let m=E.field;return h=this.nextToken(),h.type!==Token.TYPE_TO?this.error("Expected 'to'"):(l=this.assertExpression(),h=this.nextToken(),h.type===Token.TYPE_BY?o=this.assertExpression():(o=null,this.tokenizer.pushBack(h)),m instanceof Variable?new For(e,m.identifier,a,l,o,this.parseSequence(e)):this.error("Malformed for loop"))}else return E instanceof Variable?(this.assert(Token.TYPE_IN,"Error expected keyword 'in'"),t=this.assertExpression(),new ForIn(e,E.identifier,t,this.parseSequence(e))):this.error("Malformed for loop")}parseWhile(e){let t=this.assertExpression();return new While(e,t,this.parseSequence(e))}parseSequence(e){let t,o=[];for(e!=null&&this.addTerminable(e),this.nesting+=1;;){let a=this.nextToken();if(a.type===Token.TYPE_END)return e!=null&&this.endTerminable(),this.nesting-=1,o;if(this.tokenizer.pushBack(a),t=this.parseLine(),t==null)throw this.error("Unexpected data");o.push(t)}}parseObject(e){let t,o=[];for(this.nesting+=1,this.object_nesting+=1,this.addTerminable(e);;){let a=this.nextToken();if(a.type===Token.TYPE_END)return this.nesting-=1,this.object_nesting-=1,this.endTerminable(),new CreateObject(e,o);if(a.type!==Token.TYPE_IDENTIFIER&&a.reserved_keyword&&(a.type=Token.TYPE_IDENTIFIER),a.type===Token.TYPE_STRING&&(a.type=Token.TYPE_IDENTIFIER),a.type===Token.TYPE_IDENTIFIER)this.assert(Token.TYPE_EQUALS,"Expected '='"),t=this.assertExpression(),o.push({field:a.value,value:t});else return this.error("Malformed object")}}parseClass(e){let t,o=null,a=[];this.nesting+=1,this.object_nesting+=1,this.addTerminable(e);let l=this.nextToken();for(l.type===Token.TYPE_EXTENDS&&(o=this.assertExpression(),l=this.nextToken());;){if(l.type===Token.TYPE_END)return this.nesting-=1,this.object_nesting-=1,this.endTerminable(),new CreateClass(e,o,a);if(l.type!==Token.TYPE_IDENTIFIER&&l.reserved_keyword&&(l.type=Token.TYPE_IDENTIFIER),l.type===Token.TYPE_STRING&&(l.type=Token.TYPE_IDENTIFIER),l.type===Token.TYPE_IDENTIFIER)this.assert(Token.TYPE_EQUALS,"Expected '='"),t=this.assertExpression(),a.push({field:l.value,value:t});else return this.error("Malformed object");l=this.nextToken()}}parseNew(e){let t=this.assertExpression(null,!0);return new NewCall(e,t)}parseAfter(e){let t,o=null,a=[];this.nesting+=1,this.addTerminable(e);let l=this.assertExpression(),h=this.nextToken();if(h.type===Token.TYPE_IDENTIFIER&&ne.multipliers[h.value]&&(o=ne.multipliers[h.value],h=this.nextToken()),h==null||h.type!==Token.TYPE_DO)return this.error("Expected keyword 'do'");for(;;){if(h=this.nextToken(),h.type===Token.TYPE_END)return this.nesting-=1,this.endTerminable(),new After(e,l,a,h,o);this.tokenizer.pushBack(h),t=this.parseLine(),t!=null?a.push(t):this.error("Unexpected data while parsing after")}}parseEvery(e){let t,o=null,a=[];this.nesting+=1,this.addTerminable(e);let l=this.assertExpression(),h=this.nextToken();if(h.type===Token.TYPE_IDENTIFIER&&ne.multipliers[h.value]&&(o=ne.multipliers[h.value],h=this.nextToken()),h==null||h.type!==Token.TYPE_DO)return this.error("Expected keyword 'do'");for(;;){if(h=this.nextToken(),h.type===Token.TYPE_END)return this.nesting-=1,this.endTerminable(),new Every(e,l,a,h,o);this.tokenizer.pushBack(h),t=this.parseLine(),t!=null?a.push(t):this.error("Unexpected data while parsing after")}}parseDo(e){let t,o=[];for(this.nesting+=1,this.addTerminable(e);;){let a=this.nextToken();if(a.type===Token.TYPE_END)return this.nesting-=1,this.endTerminable(),new Do(e,o,a);this.tokenizer.pushBack(a),t=this.parseLine(),t!=null?o.push(t):this.error("Unexpected data while parsing after")}}parseSleep(e){let t=null,o=this.assertExpression(),a=this.nextToken();return a!=null&&(a.type===Token.TYPE_IDENTIFIER&&ne.multipliers[a.value]?t=ne.multipliers[a.value]:this.tokenizer.pushBack(a)),new Sleep(e,o,t)}parseDelete(e){let t=this.parseExpression();return t==null||!(t instanceof Variable||t instanceof Field)?this.error("expecting variable name or property access after keyword `delete`"):new Delete(e,t)}parseTemplate(e){let t=e.value,o=0,a=[];for(;o<t.length;){let h=t.indexOf("${",o);if(h===-1){o<t.length&&a.push(new Value(e,Value.TYPE_STRING,t.substring(o)));break}h>o&&a.push(new Value(e,Value.TYPE_STRING,t.substring(o,h)));let E=1,m=h+2,O=!1,g="";for(;m<t.length&&E>0;){let D=t[m];O?D===g&&t[m-1]!=="\\"&&(O=!1):D==='"'||D==="'"||D==="`"?(O=!0,g=D):D==="{"?E++:D==="}"&&E--,E>0&&m++}if(E>0)throw this.error("Unclosed template interpolation");let R=t.substring(h+2,m),T=new this.constructor(R,e.tokenizer.filename).parseExpression();T&&a.push(T),o=m+1}if(a.length===0)return new Value(e,Value.TYPE_STRING,"");let l=a[0];for(let h=1;h<a.length;h++)l=new Operation(e,"+",l,a[h]);return l}},IC_STATE={UNINITIALIZED:0,MONOMORPHIC:1,POLYMORPHIC:2,MEGAMORPHIC:3},Processor=class H{static{b(this,"_Processor")}static{__name(this,"Processor")}runner;routine;locals;stack;call_stack;call_stack_frames;log;time_limit;done;local_index;stack_index;op_index;call_stack_index;global;object;locals_offset;call_super;call_supername;metrics;profilingEnabled;static arrayPool=[];static objectPool=[];static MAX_POOL_SIZE=1e3;constructor(e){this.runner=e,this.locals=[],this.stack=[],this.call_stack=[],this.call_stack_frames=[],this.log=!1,this.time_limit=Number.POSITIVE_INFINITY,this.done=!0,this.local_index=0,this.stack_index=-1,this.op_index=0,this.call_stack_index=0,this.global=null,this.object=null,this.locals_offset=0,this.call_super=null,this.call_supername="",this.metrics={ops:0,allocations:0,cacheHits:0,cacheMisses:0},this.profilingEnabled=!1}getArray(){if(H.arrayPool.length>0){let e=H.arrayPool.pop();return e.length=0,e}return[]}recycleArray(e){H.arrayPool.length<H.MAX_POOL_SIZE&&H.arrayPool.push(e)}getObject(){return H.objectPool.length>0?H.objectPool.pop():{}}recycleObject(e){if(H.objectPool.length<H.MAX_POOL_SIZE){for(let t in e)delete e[t];H.objectPool.push(e)}}load(e){this.routine=e,this.resetState()}resetState(){this.local_index=0,this.stack_index=-1,this.op_index=0,this.call_stack_index=0,this.call_stack_frames=[],this.global=null,this.object=this.routine.object||null,this.locals_offset=0,this.call_super=null,this.call_supername="",this.done=!1}generateStackTrace(){return[...this.call_stack_frames].reverse()}formatStackTrace(){let e=this.generateStackTrace();return e.length===0?"":e.map(t=>`  at ${t.functionName} (${t.file}:${t.line}:${t.column})`).join(`
`)}resolveParentClass(e,t){if(e.class!=null&&typeof e.class=="string"){if(t[e.class]!=null&&(e.class=t[e.class],typeof e.class!="string"))return this.resolveParentClass(e.class,t)}else if(e.class!=null&&typeof e.class!="string")return this.resolveParentClass(e.class,t)}applyFunction(e){}resolvePropertyIC(e,t,o){if(e==null)return null;if(o.state===IC_STATE.MONOMORPHIC){let a=e.class||e.constructor;if(a===o.shape)return o.hits++,e[t];o.misses++,o.state=IC_STATE.POLYMORPHIC,o.shapes=[o.shape,a],o.offsets=[0,0]}else if(o.state===IC_STATE.POLYMORPHIC){let a=e.class||e.constructor;if(o.shapes&&o.shapes.length<4){for(let l=0;l<o.shapes.length;l++)if(o.shapes[l]===a)return o.hits++,e[t];o.shapes.push(a),o.misses++}else o.state=IC_STATE.MEGAMORPHIC}return o.state===IC_STATE.UNINITIALIZED&&(o.state=IC_STATE.MONOMORPHIC,o.shape=e.class||e.constructor,o.property=t,o.hits=1),e[t]}routineAsFunction(e,t){var o,a;return a=new H(this.runner),o=__name(function(){var l,h,E,m,O,g,R;for(h=Math.min(e.num_args,arguments.length),a.load(e),E=m=0,g=h-1;m<=g;E=m+=1)a.stack[++a.stack_index]=arguments[E]||0;if(a.stack[++a.stack_index]=arguments.length,e.uses_arguments){for(l=[...arguments],E=O=0,R=l.length-1;O<=R;E=O+=1)l[E]==null&&(l[E]=0);a.stack[++a.stack_index]=l}return a.run(t)},"f"),o}routineAsApplicableFunction(e,t){var o,a;return a=new H(this.runner),o=__name(function(){var l,h,E,m,O,g,R;for(h=e.num_args,a.load(e),a.object=this,E=m=0,g=h-1;m<=g;E=m+=1)a.stack[++a.stack_index]=arguments[E]||0;if(a.stack[++a.stack_index]=arguments.length,e.uses_arguments){for(l=[...arguments],E=O=0,R=l.length-1;O<=R;E=O+=1)l[E]==null&&(l[E]=0);a.stack[++a.stack_index]=l}return a.run(t),a.stack[0]},"f"),o}argToNative(e,t){return e instanceof Routine?this.routineAsFunction(e,t):e??0}modulo(e,t,o){var a,l;if(Array.isArray(t))l=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t%=o,isFinite(t)?t:0;l=e.global.String}else l=t;for(a=l["%"];a==null&&l.class!=null;)l=l.class,a=l["%"];return a==null&&(a=e.global.Object["%"]),a!=null&&a instanceof Routine?(a.as_function==null&&(a.as_function=this.routineAsApplicableFunction(a,e)),a=a.as_function,a.call(e.global,t,o)):0}add(e,t,o,a){var l,h;for(Array.isArray(t)?h=e.global.List:typeof t=="string"?h=e.global.String:h=t,l=h["+"];l==null&&h.class!=null;)h=h.class,l=h["+"];if(l==null&&(l=e.global.Object["+"]),l!=null){if(l instanceof Routine)return l.as_function==null&&(l.as_function=this.routineAsApplicableFunction(l,e)),l=l.as_function,l.call(e.global,t,o,a);if(typeof l=="function")return l.call(e.global,t,o,a)}else return 0}sub(e,t,o,a){var l,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t-=o,isFinite(t)?t:0;h=e.global.String}else h=t;for(l=h["-"];l==null&&h.class!=null;)h=h.class,l=h["-"];if(l==null&&(l=e.global.Object["-"]),l!=null){if(l instanceof Routine)return l.as_function==null&&(l.as_function=this.routineAsApplicableFunction(l,e)),l=l.as_function,l.call(e.global,t,o,a);if(typeof l=="function")return l.call(e.global,t,o,a)}else return 0}negate(e,t){var o,a;if(Array.isArray(t))a=e.global.List;else if(typeof t=="string"){if(isFinite(t))return-t;a=e.global.String}else a=t;for(o=a["-"];o==null&&a.class!=null;)a=a.class,o=a["-"];if(o==null&&(o=e.global.Object["-"]),o!=null){if(o instanceof Routine)return o.as_function==null&&(o.as_function=this.routineAsApplicableFunction(o,e)),o=o.as_function,o.call(e.global,0,t);if(typeof o=="function")return o.call(e.global,0,t)}else return 0}mul(e,t,o,a){var l,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t*=o,isFinite(t)?t:0;h=e.global.String}else h=t;for(l=h["*"];l==null&&h.class!=null;)h=h.class,l=h["*"];if(l==null&&(l=e.global.Object["*"]),l!=null){if(l instanceof Routine)return l.as_function==null&&(l.as_function=this.routineAsApplicableFunction(l,e)),l=l.as_function,l.call(e.global,t,o,a);if(typeof l=="function")return l.call(e.global,t,o,a)}else return 0}div(e,t,o,a){var l,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t/=o,isFinite(t)?t:0;h=e.global.String}else h=t;for(l=h["/"];l==null&&h.class!=null;)h=h.class,l=h["/"];if(l==null&&(l=e.global.Object["/"]),l!=null){if(l instanceof Routine)return l.as_function==null&&(l.as_function=this.routineAsApplicableFunction(l,e)),l=l.as_function,l.call(e.global,t,o,a);if(typeof l=="function")return l.call(e.global,t,o,a)}else return 0}band(e,t,o,a){var l,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t&=o,isFinite(t)?t:0;h=e.global.String}else h=t;for(l=h["&"];l==null&&h.class!=null;)h=h.class,l=h["&"];if(l==null&&(l=e.global.Object["&"]),l!=null){if(l instanceof Routine)return l.as_function==null&&(l.as_function=this.routineAsApplicableFunction(l,e)),l=l.as_function,l.call(e.global,t,o,a);if(typeof l=="function")return l.call(e.global,t,o,a)}else return 0}bor(e,t,o,a){var l,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t|=o,isFinite(t)?t:0;h=e.global.String}else h=t;for(l=h["|"];l==null&&h.class!=null;)h=h.class,l=h["|"];if(l==null&&(l=e.global.Object["|"]),l!=null){if(l instanceof Routine)return l.as_function==null&&(l.as_function=this.routineAsApplicableFunction(l,e)),l=l.as_function,l.call(e.global,t,o,a);if(typeof l=="function")return l.call(e.global,t,o,a)}else return 0}run(e){var t,o,a,l,h,E,m,O,g,R,x,T,D,d,F,G,Y,C,$,re,w,ge,Te,W,V,Oe,Pe,ke,ce,Be,J,Ae,U,v,K,se,X,be,S,ue,L,N,Z,p,M,Le,Re,Se,pe,oe,Ve,je,ze,$e,Je,ye,ae,qe,Ge,He,ee,ie,A,Ce,Qe,xe,u,c,z,le,P,De,_,te,Ye;A=this.routine,M=this.routine.opcodes,o=this.routine.arg1,J=M.length,p=this.op_index,u=this.stack,c=this.stack_index,U=this.locals,Ae=this.local_index,Y=this.global||e.global,N=this.object||Y,m=this.call_stack,O=this.call_stack_index,g=this.call_super||Y,R=this.call_supername||"",v=this.locals_offset,Z=0,ie=-1;let fe=this.profilingEnabled;for(;p<J;)switch(fe&&this.metrics.ops++,M[p]){case 1:switch(_=u[c],typeof _){case"number":u[c]="number";break;case"string":u[c]="string";break;case"function":u[c]="function";break;case"object":Array.isArray(_)?u[c]="list":_ instanceof Routine?u[c]="function":u[c]="object"}p++;break;case 2:if(_=N[o[p]],_==null&&(_=Y[o[p]]),_==null)u[++c]=0;else switch(typeof _){case"number":u[++c]="number";break;case"string":u[++c]="string";break;case"function":u[++c]="function";break;default:Array.isArray(_)?u[++c]="list":_ instanceof Routine?u[++c]="function":u[++c]="object"}p++;break;case 3:if(_=u[c-1][u[c]],_==null)u[--c]=0;else switch(typeof _){case"number":u[--c]="number";break;case"string":u[--c]="string";break;case"function":u[--c]="function";break;default:Array.isArray(_)?u[--c]="list":_ instanceof Routine?u[--c]="function":u[--c]="object"}p++;break;case 4:u[++c]=A.import_values[o[p++]];break;case 5:u[++c]=N,p++;break;case 6:u[++c]=Y,p++;break;case 10:u[++c]=o[p++];break;case 11:u[++c]=U[v+o[p++]];break;case 12:if(S=o[p],_=N[S],_==null&&N.class!=null)for(L=N;_==null&&L.class!=null;)L=L.class,_=L[S];_==null&&(_=Y[S]),_==null&&!A.ref[p].nowarning&&(P=A.ref[p].token,w=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.using_undefined_variable[w]||(e.warnings.using_undefined_variable[w]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:S})),u[++c]=_??0,p++;break;case 13:ue=U[v+o[p]],typeof ue!="object"&&(ue=U[v+o[p]]={},P=A.ref[p].token,w=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.assigning_field_to_undefined[w]||(e.warnings.assigning_field_to_undefined[w]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:P.value})),u[++c]=ue,p++;break;case 14:for(S=o[p],L=N,_=L[S];_==null&&L.class!=null;)L=L.class,_=L[S];_==null&&Y[S]!=null&&(L=Y,_=Y[S]),(_==null||typeof _!="object")&&(_=L[S]={},P=A.ref[p].token,w=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.assigning_field_to_undefined[w]||(e.warnings.assigning_field_to_undefined[w]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:o[p]})),u[++c]=_,p++;break;case 15:c--,p++;break;case 16:L=u[c-1],S=u[c];let ve=A.ics[p];if(ve||(ve=A.ics[p]={state:IC_STATE.UNINITIALIZED,hits:0,misses:0,property:S}),_=this.resolvePropertyIC(L,S,ve),_==null&&L.class!=null){let y=L;for(;_==null&&y.class!=null;)y=y.class,_=y[S]}_==null&&(_=0,A.ref[p].nowarning||(A.ref[p].nowarning=!0,Array.isArray(L)||(P=A.ref[p].token,w=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.using_undefined_variable[w]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:S}))),u[--c]=_,p++;break;case 17:_=u[c-1][u[c]],typeof _!="object"&&(_=u[c-1][u[c]]={},P=A.ref[p].token,w=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.assigning_field_to_undefined[w]||(e.warnings.assigning_field_to_undefined[w]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:u[c]})),u[--c]=_,p++;break;case 18:fe&&this.metrics.allocations++,u[++c]=this.getObject(),p++;break;case 19:typeof u[c]!="object"&&(fe&&this.metrics.allocations++,u[c]=this.getObject()),p++;break;case 20:fe&&this.metrics.allocations++,u[++c]=this.getArray(),p++;break;case 21:U[v+o[p]]=u[c],p++;break;case 22:U[v+o[p]]=u[c--],p++;break;case 23:N[o[p++]]=u[c];break;case 24:L=u[c-2],G=u[c-1],L[G]=u[c],c-=2,p++;break;case 25:L=u[c-2],G=u[c-1],u[c-2]=L[G]=u[c],c-=2,p++;break;case 26:L=u[c-1],G=u[c],delete L[G],u[c-=1]=0,p++;break;case 27:if(S=o[p],N[S]!=null&&typeof N[S]=="object"){L=N[S],xe=u[c];for(ke in xe)te=xe[ke],L[ke]=te}else N[S]=u[c];p++;break;case 28:ee={},Re=u[c],Re?ee.class=Re:o[p]&&(ee.class=o[p]),u[c]=ee,p++;break;case 29:if(E=u[c],a=o[p],typeof E=="function"){for(t=[],C=Oe=0,Ve=a-1;Oe<=Ve;C=Oe+=1)t.push(u[c-a+C]);c-=a,u[c-1]=new E(...t),p++}else{for(this.resolveParentClass(E,Y),ee={class:E},x=E.constructor;!x&&E.class!=null;)E=E.class,x=E.constructor;if(x!=null&&x instanceof Routine){if(u[c-a-1]=ee,c--,T=m[O]||(m[O]={}),O++,T.routine=A,T.object=N,T.super=g,T.supername=R,T.op_index=p+1,v+=A.locals_size,A=x,M=x.opcodes,o=x.arg1,p=0,J=M.length,N=ee,g=E,R="constructor",A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<x.num_args)for(C=Pe=a+1,Je=x.num_args;Pe<=Je;C=Pe+=1)u[++c]=0;else a>x.num_args&&(c-=a-x.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else c-=a,u[c-1]=ee,p++}break;case 30:h=u[c--],t=u[c],typeof t=="number"?(t+=h,u[c]=isFinite(t)||typeof h=="string"?t:0):u[c]=this.add(e,t,h,o[p]),p++;break;case 31:h=u[c--],t=u[c],typeof t=="number"?(t-=h,u[c]=isFinite(t)?t:0):u[c]=this.sub(e,t,h,o[p]),p++;break;case 32:h=u[c--],t=u[c],typeof t=="number"?(t*=h,u[c]=isFinite(t)?t:0):u[c]=this.mul(e,t,h,0),p++;break;case 33:h=u[c--],t=u[c],typeof t=="number"?(t/=h,u[c]=isFinite(t)?t:0):u[c]=this.div(e,t,h,0),p++;break;case 34:h=u[c--],t=u[c],typeof t=="number"&&typeof h=="number"?(t%=h,u[c]=isFinite(t)?t:0):u[c]=this.modulo(e,t,h),p++;break;case 35:h=u[c--],t=u[c],typeof t=="number"?(t&=h,u[c]=isFinite(t)?t:0):u[c]=this.band(e,t,h,0),p++;break;case 36:h=u[c--],t=u[c],typeof t=="number"?(t|=h,u[c]=isFinite(t)?t:0):u[c]=this.bor(e,t,h,0),p++;break;case 37:_=u[c-1]<<u[c],u[--c]=isFinite(_)?_:0,p++;break;case 38:_=u[c-1]>>u[c],u[--c]=isFinite(_)?_:0,p++;break;case 39:t=u[c],typeof t=="number"?u[c]=-t:u[c]=this.negate(e,t),p++;break;case 50:u[c]=u[c]?0:1,p++;break;case 68:for(L=u[c-1],S=u[c],_=L[S];_==null&&L.class!=null;)L=L.class,_=L[S];_==null&&(_=0,A.ref[p].nowarning||(A.ref[p].nowarning=!0,Array.isArray(L)||(P=A.ref[p].token,w=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.using_undefined_variable[w]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:S}))),u[++c]=_,p++;break;case 40:u[c-1]=u[c]===u[c-1]?1:0,c--,p++;break;case 41:u[c-1]=u[c]!==u[c-1]?1:0,c--,p++;break;case 42:u[c-1]=u[c-1]<u[c]?1:0,c--,p++;break;case 43:u[c-1]=u[c-1]>u[c]?1:0,c--,p++;break;case 44:u[c-1]=u[c-1]<=u[c]?1:0,c--,p++;break;case 45:u[c-1]=u[c-1]>=u[c]?1:0,c--,p++;break;case 95:W=o[p][0],se=U[v+W+1]=u[c-1],K=u[c],V=U[v+W],u[--c]=0,K===0?(U[v+W+2]=se>V?1:-1,p++):(U[v+W+2]=K,K>0&&V>se||K<0&&V<se?p=o[p][1]:p++);break;case 96:W=o[p][0],K=U[v+W+2],se=U[v+W+1],V=U[v+W],V+=K,K>0&&V>se||K<0&&V<se?p++:(U[v+W]=V,p=o[p][1]),Z++>100&&(Z=0,Date.now()>this.time_limit&&(ie=p,p=J));break;case 97:_=u[c],u[c]=0,V=o[p][0],typeof _=="object"?Array.isArray(_)?U[v+V+1]=_:_=U[v+V+1]=Object.keys(_):typeof _=="string"?_=U[v+V+1]=_.split(""):_=U[v+V+1]=[],_.length===0?p=o[p][1]:(te=_[0],U[v+o[p][0]]=te??0,U[v+V+2]=0,p++);break;case 98:V=o[p][0],ge=U[v+V+2]+=1,_=U[v+V+1],ge<_.length?(te=_[ge],U[v+V]=te??0,p=o[p][1]):p++,Z++>100&&(Z=0,Date.now()>this.time_limit&&(ie=p,p=J));break;case 80:p=o[p],Z++>100&&(Z=0,Date.now()>this.time_limit&&(ie=p,p=J));break;case 81:u[c--]?p=o[p]:p++;break;case 82:u[c--]?p++:p=o[p];break;case 83:u[c]?p=o[p]:p++;break;case 84:u[c]?p++:p=o[p];break;case 89:for(pe=o[p++],oe=pe.clone(),ye=pe.import_refs,ce=0,Be=ye.length;ce<Be;ce++)Te=ye[ce],Te===pe.import_self?oe.import_values.push(oe):oe.import_values.push(U[v+Te]);oe.object=N,u[++c]=oe;break;case 90:if(a=o[p],d=u[c],d instanceof Routine){c--,T=m[O]||(m[O]={}),O++,T.routine=A,T.object=N,T.super=g,T.supername=R,T.op_index=p+1;let y=A.ref[p]?.token;if(y&&this.call_stack_frames.push({functionName:d.source||"[anonymous function]",file:y.tokenizer.filename,line:y.line,column:y.column}),v+=A.locals_size,A=d,M=d.opcodes,o=d.arg1,p=0,J=M.length,N=A.object!=null?A.object:Y,g=Y,R="",A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<d.num_args)for(C=X=a+1,ae=d.num_args;X<=ae;C=X+=1)u[++c]=0;else a>d.num_args&&(c-=a-d.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else if(typeof d=="function"){switch(a){case 0:try{_=d()}catch(y){D=y,console.error(D),_=0}u[c]=_??0;break;case 1:try{_=d(this.argToNative(u[c-1],e))}catch(y){D=y,console.error(D),_=0}u[c-1]=_??0,c-=1;break;default:for(l=[],c-=a,C=be=0,qe=a-1;be<=qe;C=be+=1)l[C]=this.argToNative(u[c+C],e);try{_=d.apply(null,l)}catch(y){D=y,console.error(D),_=0}u[c]=_??0}p++}else c-=a,u[c]=d??0,P=A.ref[p].token,w=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.invoking_non_function[w]||(F=A.ref[p],$=F.expression.token.start,re=F.token.start+F.token.length,e.warnings.invoking_non_function[w]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:F.token.tokenizer.input.substring($,re)}),p++;break;case 91:if(S=u[c],z=L=N,d=L[S],d==null){for(;d==null&&z.class!=null;)z=z.class,d=z[S];d==null&&(d=Y.Object[S]),d==null&&(d=Y[S],z=Y,L=Y)}if(a=o[p],d instanceof Routine){if(c-=1,T=m[O]||(m[O]={}),O++,T.routine=A,T.object=N,T.super=g,T.supername=R,T.op_index=p+1,v+=A.locals_size,A=d,M=d.opcodes,o=d.arg1,p=0,J=M.length,N=L,g=z,R=S,A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<d.num_args)for(C=Le=a+1,Ge=d.num_args;Le<=Ge;C=Le+=1)u[++c]=0;else a>d.num_args&&(c-=a-d.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else if(typeof d=="function"){switch(a){case 0:try{_=d.call(L)}catch(y){D=y,console.error(D),_=0}u[c]=_??0;break;case 1:try{_=d.call(L,this.argToNative(u[c-1],e))}catch(y){D=y,console.error(D),_=0}u[--c]=_??0;break;default:for(l=[],c-=a,C=Se=0,He=a-1;Se<=He;C=Se+=1)l[C]=this.argToNative(u[c+C],e);try{_=d.apply(L,l)}catch(y){D=y,console.error(D),_=0}u[c]=_??0}p++}else c-=a,u[c]=d??0,P=A.ref[p].token,w=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.invoking_non_function[w]||(F=A.ref[p],$=F.expression.token.start,re=F.token.start+F.token.length,e.warnings.invoking_non_function[w]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:F.token.tokenizer.input.substring($,re)}),p++;break;case 92:for(L=u[c-1],z=L,S=u[c],d=L[S];d==null&&z.class!=null;)z=z.class,d=z[S];if(a=o[p],d==null&&(L instanceof Routine?d=Y.Function[S]:typeof L=="string"?d=Y.String[S]:typeof L=="number"?d=Y.Number[S]:Array.isArray(L)?d=Y.List[S]:typeof L=="object"&&(d=Y.Object[S])),d instanceof Routine){if(c-=2,T=m[O]||(m[O]={}),O++,T.object=N,T.super=g,T.supername=R,T.routine=A,T.op_index=p+1,v+=A.locals_size,A=d,M=d.opcodes,o=d.arg1,p=0,J=M.length,N=L,g=z,R=S,A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<d.num_args)for(C=Ce=a+1,je=d.num_args;Ce<=je;C=Ce+=1)u[++c]=0;else a>d.num_args&&(c-=a-d.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else if(typeof d=="function"){switch(a){case 0:try{_=d.call(L)}catch(y){D=y,console.error(D),_=0}u[--c]=_??0;break;case 1:try{_=d.call(L,this.argToNative(u[c-2],e))}catch(y){D=y,console.error(D),_=0}u[c-2]=_??0,c-=2;break;default:for(l=[],c-=a+1,C=De=0,ze=a-1;De<=ze;C=De+=1)l[C]=this.argToNative(u[c+C],e);try{_=d.apply(L,l)}catch(y){D=y,console.error(D),_=0}u[c]=_??0}p++}else c-=a+1,u[c]=d??0,P=A.ref[p].token,w=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.invoking_non_function[w]||(F=A.ref[p],$=F.expression.token.start,re=F.token.start+F.token.length,e.warnings.invoking_non_function[w]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:F.token.tokenizer.input.substring($,re)}),p++;break;case 93:if(g!=null&&R!=null){for(z=g,d=null;d==null&&z.class!=null;)z=z.class,d=z[R];if(d!=null&&d instanceof Routine){if(a=o[p],T=m[O]||(m[O]={}),O++,T.object=N,T.super=g,T.supername=R,T.routine=A,T.op_index=p+1,v+=A.locals_size,A=d,M=d.opcodes,o=d.arg1,p=0,J=M.length,g=z,A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<d.num_args)for(C=Ye=a+1,$e=d.num_args;Ye<=$e;C=Ye+=1)u[++c]=0;else a>d.num_args&&(c-=a-d.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else a=o[p],c-=a,u[++c]=0,p++}else a=o[p],c-=a,u[++c]=0,p++;break;case 94:Ae-=o[p],O<=0?p=J:(T=m[--O],N=T.object,g=T.super,R=T.supername,A=T.routine,p=T.op_index,M=A.opcodes,o=A.arg1,v-=A.locals_size,J=M.length);break;case 100:_=o[p](u[c]),u[c]=isFinite(_)?_:0,p++;break;case 101:_=o[p](u[c-1],u[c]),u[--c]=isFinite(_)?_:0,p++;break;case 110:le=this.runner.createThread(u[c-1],u[c],!1),u[--c]=le,p+=1;break;case 111:le=this.runner.createThread(u[c-1],u[c],!0),u[--c]=le,p+=1;break;case 112:le=this.runner.createThread(u[c],0,!1),u[c]=le,p+=1;break;case 113:Qe=isFinite(u[c])?u[c]:0,this.runner.sleep(Qe),p+=1,ie=p,p=J;break;case 120:if(S=o[p].name,a=o[p].args,_=N[S],_==null&&N.class!=null)for(L=N;_==null&&L.class!=null;)L=L.class,_=L[S];if(_==null&&(_=Y[S]),_==null&&!A.ref[p].nowarning&&(P=A.ref[p].token,w=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.using_undefined_variable[w]||(e.warnings.using_undefined_variable[w]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:S})),d=_??0,d instanceof Routine){T=m[O]||(m[O]={}),O++,T.routine=A,T.object=N,T.super=g,T.supername=R,T.op_index=p+1;let y=A.ref[p]?.token;if(y&&this.call_stack_frames.push({functionName:d.source||"[anonymous function]",file:y.tokenizer.filename,line:y.line,column:y.column}),v+=A.locals_size,A=d,M=d.opcodes,o=d.arg1,p=0,J=M.length,N=A.object!=null?A.object:Y,g=Y,R="",A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<d.num_args)for(C=X=a+1,ae=d.num_args;X<=ae;C=X+=1)u[++c]=0;else a>d.num_args&&(c-=a-d.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else if(typeof d=="function"){switch(a){case 0:try{_=d()}catch(y){console.error(y),_=0}u[++c]=_??0;break;case 1:try{_=d(this.argToNative(u[c],e))}catch(y){console.error(y),_=0}u[c]=_??0;break;default:for(l=[],c-=a-1,C=0;C<a;C++)l[C]=this.argToNative(u[c+C],e);try{_=d.apply(null,l)}catch(y){console.error(y),_=0}u[c]=_??0}p++}else c-=a,u[++c]=d??0,p++;break;case 121:for(a=o[p],L=u[c-1],S=u[c],_=L[S];_==null&&L.class!=null;)L=L.class,_=L[S];if(_==null&&(_=0,A.ref[p].nowarning||(A.ref[p].nowarning=!0,Array.isArray(L)||(P=A.ref[p].token,w=P.tokenizer.filename+"-"+P.line+"-"+P.column,e.warnings.using_undefined_variable[w]={file:P.tokenizer.filename,line:P.line,column:P.column,expression:S}))),d=_,u[--c]=d,d instanceof Routine){c--,T=m[O]||(m[O]={}),O++,T.routine=A,T.object=N,T.super=g,T.supername=R,T.op_index=p+1;let y=A.ref[p]?.token;if(y&&this.call_stack_frames.push({functionName:d.source||"[anonymous function]",file:y.tokenizer.filename,line:y.line,column:y.column}),v+=A.locals_size,A=d,M=d.opcodes,o=d.arg1,p=0,J=M.length,N=A.object!=null?A.object:Y,g=Y,R="",A.uses_arguments&&(l=u.slice(c-a+1,c+1)),a<d.num_args)for(C=X=a+1,ae=d.num_args;X<=ae;C=X+=1)u[++c]=0;else a>d.num_args&&(c-=a-d.num_args);u[++c]=a,A.uses_arguments&&(u[++c]=l)}else if(typeof d=="function"){switch(a){case 0:try{_=d()}catch(y){console.error(y),_=0}u[c]=_??0;break;case 1:try{_=d(this.argToNative(u[c-1],e))}catch(y){console.error(y),_=0}u[c-1]=_??0,c--;break;default:for(l=[],c-=a,C=0;C<a;C++)l[C]=this.argToNative(u[c+C],e);try{_=d.apply(null,l)}catch(y){console.error(y),_=0}u[c]=_??0}p++}else c-=a,u[c]=d??0,p++;break;case 122:t=o[p],h=u[c],typeof h=="number"?(h+=t,u[c]=isFinite(h)?h:0):u[c]=this.add(e,h,t,0),p++;break;case 200:c=o[p](u,c,U,v,N,Y),p++;break;default:throw`Unsupported operation: ${M[p]}`}return ie>=0?(this.op_index=ie,this.routine=A,this.stack_index=c,this.local_index=Ae,this.object=N,this.call_stack_index=O,this.call_super=g,this.call_supername=R,this.locals_offset=v,this.done=!1):(this.op_index=0,this.done=!0,this.routine.callback!=null&&(this.routine.callback(u[c]),this.routine.callback=null)),this.log&&(console.info("total operations: "+Z),console.info(`stack_index: ${c}`),console.info(`result: ${u[c]}`)),u[c]}},VMProfiler=class{static{b(this,"VMProfiler")}static{__name(this,"VMProfiler")}startTime=0;startOps=0;startAllocations=0;frameCount=0;samples=[];processor;constructor(n){this.processor=n}start(){this.startTime=performance.now(),this.startOps=this.processor.metrics?.ops||0,this.startAllocations=this.processor.metrics?.allocations||0,this.frameCount=0}stop(){let e=performance.now()-this.startTime,t=this.processor.metrics?.ops||0,o=this.processor.metrics?.allocations||0,a={ops:t-this.startOps,time:e,allocations:o-this.startAllocations,frames:this.frameCount,samples:this.samples.length,opsPerSec:(t-this.startOps)/e*1e3,avgFrameTime:e/(this.frameCount||1)};return this.samples.push(a),a}frame(){this.frameCount++}getAverageMetrics(){if(this.samples.length===0)return this.stop();let n=this.samples.reduce((e,t)=>({ops:e.ops+t.ops,time:e.time+t.time,allocations:e.allocations+t.allocations,frames:e.frames+t.frames,samples:e.samples+t.samples,opsPerSec:e.opsPerSec+t.opsPerSec,avgFrameTime:e.avgFrameTime+t.avgFrameTime}));return{ops:n.ops/this.samples.length,time:n.time/this.samples.length,allocations:n.allocations/this.samples.length,frames:n.frames/this.samples.length,samples:this.samples.length,opsPerSec:n.opsPerSec/this.samples.length,avgFrameTime:n.avgFrameTime/this.samples.length}}},import_stdlib=q("@l8b/stdlib"),Thread=class{static{b(this,"Thread")}static{__name(this,"Thread")}runner;loop;processor;paused;terminated;next_calls;interface;routine;start_time;delay;repeat;sleep_until;constructor(n){this.runner=n,this.loop=!1,this.processor=new Processor(this.runner),this.paused=!1,this.terminated=!1,this.next_calls=[],this.interface={pause:__name(()=>this.pause(),"pause"),resume:__name(()=>this.resume(),"resume"),stop:__name(()=>this.stop(),"stop"),status:"running"}}addCall(n){this.next_calls.indexOf(n)<0&&this.next_calls.push(n)}loadNext(){let n,e,t,o;return this.next_calls.length>0?(e=this.next_calls.splice(0,1)[0],e instanceof Routine?this.processor.load(e):(t=new Parser(e,""),t.parse(),o=t.program,n=new globalThis.Compiler(o),this.processor.load(n.routine),(e==="update()"||e==="serverUpdate()")&&this.runner.updateControls!=null&&this.runner.updateControls()),!0):!1}pause(){return this.interface.status==="running"?(this.interface.status="paused",this.paused=!0,1):0}resume(){return this.interface.status==="paused"?(this.interface.status="running",this.paused=!1,1):0}stop(){return this.interface.status="stopped",this.terminated=!0,1}},Runner=class{static{b(this,"Runner")}static{__name(this,"Runner")}l8bvm;initialized;system;main_thread;threads;current_thread;thread_index;fps;fps_max;cpu_load;triggers_controls_update;updateControls;profiler;constructor(n){this.l8bvm=n,this.initialized=!1,this.threads=[],this.current_thread=null,this.thread_index=0,this.fps=60,this.fps_max=60,this.cpu_load=0,this.triggers_controls_update=!1,this.profiler=new VMProfiler(null)}init(){return this.initialized=!0,this.l8bvm.context.global.system||(this.l8bvm.context.global.system={}),this.system=this.l8bvm.context.global.system,this.system.preemptive=1,this.system.threads=[],this.main_thread=new Thread(this),this.threads=[this.main_thread],this.current_thread=this.main_thread,this.thread_index=0,this.profiler=new VMProfiler(this.main_thread.processor),this.system.profiler={start:__name(()=>{this.main_thread.processor.profilingEnabled=!0,this.profiler.start()},"start"),stop:__name(()=>(this.main_thread.processor.profilingEnabled=!1,this.profiler.stop()),"stop"),getMetrics:__name(()=>this.profiler.getAverageMetrics(),"getMetrics")},this.l8bvm.context.global.print=this.l8bvm.context.meta.print,this.l8bvm.context.global.random=new Random(0),this.l8bvm.context.global.Function={bind:__name(function(n){let e;return this instanceof Routine?(e=this.clone(),e.object=n,e):this},"bind")},this.l8bvm.context.global.Math=import_stdlib.MathLib,this.l8bvm.context.global.JSON=import_stdlib.JSONLib,this.l8bvm.context.global.List=import_stdlib.ListLib,this.l8bvm.context.global.Function={bind:__name((...n)=>n[0].bind.apply(n[0],n.slice(1)),"bind")},this.l8bvm.context.global.String={...import_stdlib.StringLib,fromCharCode:__name(function(){return String.fromCharCode.apply(null,arguments)},"fromCharCode")},this.l8bvm.context.global.Number={parse:__name(function(n){let e=Number.parseFloat(n);return isFinite(e)?e:0},"parse"),toString:__name(function(){return this.toString()},"toString")},this.l8bvm.context.global.Object={"+":__name((n,e)=>n!=null?n+e:e,"+"),"-":__name((n,e)=>n-e,"-"),"*":__name((n,e)=>n*e,"*"),"/":__name((n,e)=>n/e,"/"),"%":__name((n,e)=>n%e,"%")},this.fps=60,this.fps_max=60,this.cpu_load=0,this.l8bvm.context.meta.print("LootiScript 1.0"),this.triggers_controls_update=!0}run(n,e="",t){let o,a,l,h,E,m,O,g,R=null,x;if(this.initialized||this.init(),m=new Parser(n,e),m.parse(),m.error_info!=null)throw a=m.error_info,a.type="compile",a;if(m.warnings.length>0)for(g=m.warnings,h=0,E=g.length;h<E;h++)switch(x=g[h],l=e+"-"+x.line+"-"+x.column,x.type){case"assigning_api_variable":this.l8bvm.context.warnings.assigning_api_variable[l]==null&&(this.l8bvm.context.warnings.assigning_api_variable[l]={file:e,line:x.line,column:x.column,expression:x.identifier});break;case"assignment_as_condition":this.l8bvm.context.warnings.assignment_as_condition[l]==null&&(this.l8bvm.context.warnings.assignment_as_condition[l]={file:e,line:x.line,column:x.column})}return O=m.program,o=new globalThis.Compiler(O),R=null,o.routine.callback=T=>t!=null?t(Program.toString(T)):R=T,this.main_thread.addCall(o.routine),this.tick(),R}call(n,e){let t,o;if(n==="draw"||n==="update"||n==="serverUpdate"){this.l8bvm.context.global[n]!=null&&this.main_thread.addCall(`${n}()`);return}if(this.l8bvm.context.global[n]!=null)if(e==null||!e.length)this.main_thread.addCall(`${n}()`);else{if(o=this.l8bvm.context.global[n],o instanceof Routine)return t=this.main_thread.processor.routineAsFunction(o,this.l8bvm.context),t(...e);if(typeof o=="function")return o(...e)}else return 0}toString(n){return Program.toString(n)}process(n,e){let t;return t=n.processor,t.time_limit=e,this.current_thread=n,t.run(this.l8bvm.context)}tick(){let n,e,t,o,a,l,h,E,m,O,g,R,x,T;for(this.system.fps!=null&&(this.fps=this.fps*.9+this.system.fps*.1),this.fps_max=Math.max(this.fps,this.fps_max),this.fps<59?h=10:h=Math.floor(1e3/this.fps*.8),R=Date.now(),x=R+100,T=this.system.preemptive?x:1/0,m=this.main_thread.processor,m.done||(this.main_thread.sleep_until!=null?Date.now()>=this.main_thread.sleep_until&&(delete this.main_thread.sleep_until,this.process(this.main_thread,T)):this.process(this.main_thread,T));m.done&&Date.now()<T&&this.main_thread.loadNext();)this.process(this.main_thread,T);for(x=R+h,T=this.system.preemptive?x:1/0,this.main_thread.processor.profilingEnabled&&this.profiler.frame(),E=!0;E;){for(E=!1,O=this.threads,o=0,a=O.length;o<a;o++)if(g=O[o],g!==this.main_thread){if(g.paused||g.terminated)continue;if(m=g.processor,!m.done)g.sleep_until!=null?Date.now()>=g.sleep_until&&(delete g.sleep_until,this.process(g,T),E=!0):(this.process(g,T),E=!0);else if(g.start_time!=null)if(g.repeat)for(;R>=g.start_time&&!(g.paused||g.terminated);)R>=g.start_time+150?g.start_time=R+(g.delay||0):g.start_time+=g.delay||0,m.load(g.routine),this.process(g,T),E=!0;else R>=g.start_time&&(delete g.start_time,m.load(g.routine),this.process(g,T),E=!0);else g.terminated=!0}if(Date.now()>x)break}for(e=this.threads.length-1;e>=1;e--)g=this.threads[e],g.terminated&&(this.threads.splice(e,1),t=this.system.threads.indexOf(g.interface),t>=0&&this.system.threads.splice(t,1));g=this.threads[0],n=Date.now()-R;let D=x-R;l=n/D*100,this.cpu_load=this.cpu_load*.9+l*.1,this.system.cpu_load=Math.min(100,Math.round(this.cpu_load))}createThread(n,e,t){let o,a;for(a=new Thread(this),a.routine=n,this.threads.push(a),a.start_time=Date.now()+e-1e3/this.fps,t&&(a.repeat=t,a.delay=e),this.system.threads.push(a.interface),o=0;o<n.import_values.length;o++)n.import_values[o]===n&&(n.import_values[o]=a.interface);return a.interface}sleep(n){this.current_thread!=null&&(this.current_thread.sleep_until=Date.now()+Math.max(0,n))}},Stack=class{static{b(this,"Stack")}static{__name(this,"Stack")}stack;index;touched;constructor(){this.stack=["stack[stack_index]"],this.index=0,this.touched={}}push(n){return this.stack[++this.index]=n,this.touched[this.index]=!0}pop(){let n;return this.index>=0?n=this.stack.splice(this.index,1)[0]:this.stack[this.index]!=null?n=this.stack[this.index]:n="stack[stack_index-"+this.index+"]",this.index-=1,n}get(n=0){let e;return n==null&&(n=0),e=this.index+n,e>=0?this.stack[e]:this.stack[e]!=null?this.stack[e]:"stack[stack_index-"+-e+"]"}},Transpiler2=class{static{b(this,"Transpiler2")}static{__name(this,"Transpiler")}vcount=0;stack;locals;variables;opcodeHandlers;constructor(){this.opcodeHandlers={LOAD_VALUE:this.LOAD_VALUE.bind(this),LOAD_LOCAL:this.LOAD_LOCAL.bind(this),LOAD_LOCAL_OBJECT:this.LOAD_LOCAL_OBJECT.bind(this),STORE_LOCAL:this.STORE_LOCAL.bind(this),POP:this.POP.bind(this),CREATE_PROPERTY:this.CREATE_PROPERTY.bind(this),LOAD_PROPERTY:this.LOAD_PROPERTY.bind(this),LOAD_PROPERTY_ATOP:this.LOAD_PROPERTY_ATOP.bind(this),NEW_OBJECT:this.NEW_OBJECT.bind(this),NEW_ARRAY:this.NEW_ARRAY.bind(this),MAKE_OBJECT:this.MAKE_OBJECT.bind(this),STORE_VARIABLE:this.STORE_VARIABLE.bind(this),STORE_PROPERTY:this.STORE_PROPERTY.bind(this)}}transpile(n){for(let e=0;e<n.opcodes.length;e++){let t=OPCODES[n.opcodes[e]];if(this.transpilable(t,n.arg1[e])){let o=e+1;for(;o<n.opcodes.length&&n.removeable(o)&&this.transpilable(OPCODES[n.opcodes[o]],n.arg1[o]);)o+=1;o-=1,o-e>=2&&this.transpileSegment(n,e,o)}}}transpileSegment(r,i,j){let comp,err,index,k,s;for(this.vcount=0,this.stack=new Stack,this.locals={},this.variables={},s=`f = function(stack,stack_index,locals,locals_offset,object,global) {
`,k=i;k<=j;k++){let n=OPCODES[r.opcodes[k]],e=this.opcodeHandlers[n];e?comp=e(r.arg1[k]):comp=void 0,comp&&(s+=comp+`
`)}for(index in this.stack.touched)if(this.stack.touched[index]){let n=Number(index);n<0?s+="stack[stack_index-"+Math.abs(n)+"] = "+this.stack.stack[n]+` ;
`:n>0?s+="stack[stack_index+"+index+"] = "+this.stack.stack[n]+` ;
`:s+="stack[stack_index] = "+this.stack.stack[n]+` ;
`}this.stack.index<0?s+="stack_index -= "+Math.abs(this.stack.index)+` ;
`:this.stack.index>0&&(s+="stack_index += "+this.stack.index+` ;
`),s+=`return stack_index ;
}`,console.info(s);try{eval(s)}catch(n){err=n,console.error(s),console.error(err)}r.opcodes[i]=OPCODES.COMPILED;let f=globalThis.f;for(r.arg1[i]=f,k=i+1;k<=j;k++)r.remove(i+1)}createVariable(){return"v"+this.vcount++}transpilable(n,e){return n==="LOAD_VALUE"?typeof e=="string"||typeof e=="number":this.opcodeHandlers[n]!=null}LOAD_VALUE(n){return typeof n=="string"?this.stack.push(' "'+n.replace(/"/g,'\\"')+'" '):typeof n=="number"&&this.stack.push(n+""),""}LOAD_LOCAL(n){let e=this.createVariable();return this.stack.push(e),"let "+e+" = locals[locals_offset+"+n+"] ; // LOAD_LOCAL"}LOAD_LOCAL_OBJECT(n){let e,t;return this.locals[n]!=null?(t=this.locals[n],this.stack.push(t),"if (typeof "+t+' != "object") { '+t+" = locals[locals_offset+"+n+"] = {} } ;"):(t=this.createVariable(),e="let "+t+" = locals[locals_offset+"+n+`] ;
if (typeof `+t+' != "object") { '+t+" = locals[locals_offset+"+n+"] = {} } ;",this.stack.push(t),this.locals[n]=t,e)}STORE_LOCAL(n){let e=this.stack.get();return"locals[locals_offset+"+n+"] = "+e+" ; // STORE_LOCAL"}POP(){return this.stack.pop(),""}CREATE_PROPERTY(n){let e=this.stack.get(-2)+"["+this.stack.get(-1)+"] = "+this.stack.get()+" ;";return this.stack.pop(),this.stack.pop(),e}LOAD_PROPERTY(n){let e,t;return t=this.createVariable(),e="let "+t+" = "+this.stack.get(-1)+"["+this.stack.get()+`] ; // LOAD_PROPERTY
if (`+t+" == null) { "+t+" = 0 ; }",this.stack.pop(),this.stack.pop(),this.stack.push(t),e}LOAD_PROPERTY_ATOP(n){let e,t;return t=this.createVariable(),e="let "+t+" = "+this.stack.get(-1)+"["+this.stack.get()+`] ; // LOAD_PROPERTY_ATOP
if (`+t+" == null) { "+t+" = 0 ; }",this.stack.push(t),e}NEW_OBJECT(){let n=this.createVariable();return this.stack.push(n),"let "+n+" = {} ;"}NEW_ARRAY(){let n=this.createVariable();return this.stack.push(n),"let "+n+" = [] ;"}MAKE_OBJECT(){let n,e;return e=this.createVariable(),n="let "+e+" = "+this.stack.get()+` ;
if (typeof `+e+' != "object") '+e+" = {} ; ",this.stack.pop(),this.stack.push(e),n}STORE_VARIABLE(n){return this.variables[n]!=null?this.variables[n]+' = object["'+n+'"] = '+this.stack.get()+" ; // STORE_VARIABLE":'object["'+n+'"] = '+this.stack.get()+" ; // STORE_VARIABLE"}STORE_PROPERTY(n){let e,t;return t=this.createVariable(),e="let "+t+" = "+this.stack.get(-2)+"["+this.stack.get(-1)+"] = "+this.stack.get(0)+" ; // STORE_PROPERTY",this.stack.pop(),this.stack.pop(),this.stack.pop(),this.stack.push(t),e}}});var Dt=Ke(ht()),Yt=Ke(ct());var export_Routine=Yt.Routine;var export_Runtime=Dt.Runtime;export{export_Routine as Routine,export_Runtime as Runtime};
