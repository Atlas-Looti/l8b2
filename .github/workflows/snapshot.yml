name: Snapshot
on:
  workflow_dispatch:

jobs:
  snapshot:
    name: Release Snapshot Version
    permissions:
      contents: write
      id-token: write
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Install dependencies
        uses: ./.github/actions/install-dependencies

      - name: Determine snapshot tag
        id: snapshot-tag
        run: |
          BRANCH=$(git branch --show-current)
          SNAPSHOT_TAG=$(echo "$BRANCH" | tr -cs '[:alnum:]-' '-' | tr '[:upper:]' '[:lower:]' | sed 's/^-//;s/-$//')
          echo "tag=$SNAPSHOT_TAG" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Snapshot tag: $SNAPSHOT_TAG"

      - name: Configure npm authentication
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NPM_TOKEN" ]; then
            echo "âŒ Error: NPM_TOKEN not set"
            exit 1
          fi
          echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
          npm config set "//registry.npmjs.org/:_authToken" "$NPM_TOKEN"

      - name: Version snapshot packages
        run: |
          echo "ğŸ“ Versioning packages with snapshot tag: ${{ steps.snapshot-tag.outputs.tag }}"
          pnpm changeset version --no-git-tag --snapshot ${{ steps.snapshot-tag.outputs.tag }}

      - name: Reinstall dependencies after versioning
        run: |
          echo "ğŸ“¦ Reinstalling dependencies with updated versions..."
          pnpm install

      - name: Prepare for publishing
        run: pnpm changeset:prepublish

      - name: Publish snapshot
        continue-on-error: true
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          pnpm changeset publish --no-git-tag --snapshot ${{ steps.snapshot-tag.outputs.tag }} --tag ${{ steps.snapshot-tag.outputs.tag }} || {
            echo "âš ï¸ Some packages failed to publish (expected if versions exist)"
            exit 0
          }
          echo "âœ… Snapshot published successfully with tag: ${{ steps.snapshot-tag.outputs.tag }}"